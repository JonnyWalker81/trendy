---
phase: 09-ios-state-architecture
plan: 03
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - apps/ios/trendy/ContentView.swift
  - apps/ios/trendy/ViewModels/OnboardingViewModel.swift
  - apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift
  - apps/ios/trendy/Views/Auth/LoginView.swift
autonomous: true

must_haves:
  truths:
    - "No NotificationCenter posts for .onboardingCompleted anywhere in codebase"
    - "OnboardingViewModel calls AppRouter methods instead of posting notifications"
    - "OnboardingContainerView calls AppRouter methods instead of posting notifications"
    - "ContentView no longer handles routing logic"
  artifacts:
    - path: "apps/ios/trendy/ViewModels/OnboardingViewModel.swift"
      provides: "Onboarding flow without NotificationCenter routing"
      contains: "appRouter.handleOnboardingComplete"
    - path: "apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift"
      provides: "Container without NotificationCenter posts"
      contains: "appRouter.transitionToAuthenticated"
  key_links:
    - from: "apps/ios/trendy/ViewModels/OnboardingViewModel.swift"
      to: "apps/ios/trendy/Services/AppRouter.swift"
      via: "AppRouter method calls"
      pattern: "appRouter\\.(handleOnboardingComplete|transitionTo)"
    - from: "apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift"
      to: "apps/ios/trendy/Services/AppRouter.swift"
      via: "Environment injection"
      pattern: "@Environment\\(AppRouter\\.self\\)"
---

<objective>
Remove NotificationCenter routing and wire existing views to use AppRouter.

Purpose: Replace loosely-coupled notification-based routing with predictable Observable state.
Output: OnboardingViewModel and OnboardingContainerView use AppRouter, ContentView simplified.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ios-state-architecture/09-CONTEXT.md
@.planning/phases/09-ios-state-architecture/09-RESEARCH.md
@.planning/phases/09-ios-state-architecture/09-01-SUMMARY.md
@apps/ios/trendy/ViewModels/OnboardingViewModel.swift
@apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift
@apps/ios/trendy/ContentView.swift
@apps/ios/trendy/Views/Auth/LoginView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update OnboardingViewModel to use AppRouter</name>
  <files>
    apps/ios/trendy/ViewModels/OnboardingViewModel.swift
  </files>
  <action>
Modify `apps/ios/trendy/ViewModels/OnboardingViewModel.swift`:

1. Add AppRouter dependency:
```swift
// Add to dependencies section
private var appRouter: AppRouter?

// Add setter method
func setAppRouter(_ router: AppRouter) {
    self.appRouter = router
}
```

2. In `completeOnboarding()`, replace NotificationCenter.post with AppRouter call:

REMOVE this line (around line 647):
```swift
// Post notification for app to transition
NotificationCenter.default.post(name: .onboardingCompleted, object: nil)
```

REPLACE with:
```swift
// Transition to main app via AppRouter
Task { @MainActor in
    await appRouter?.handleOnboardingComplete()
}
```

3. In `signIn()` method, after successful sign-in and `determineInitialState()`:
- If `isComplete` is true, call `appRouter?.transitionToAuthenticated()` instead of relying on notification

4. In `signInWithGoogle()`, after `determineInitialState()`:
- If `isComplete` is true, call `appRouter?.transitionToAuthenticated()`

5. Update the sign-in flow to handle AppRouter transitions properly:

In `signIn()` after `await determineInitialState()`:
```swift
// If onboarding is complete, transition directly
if isComplete {
    appRouter?.transitionToAuthenticated()
    return
}

// If we're still on auth step after sign-in, advance past it
if currentStep == .auth && !isComplete {
    Log.auth.debug("OnboardingViewModel.signIn: Auth complete, advancing past auth step")
    await advanceToNextStep()
}
```

6. KEEP the Notification.Name extension at the bottom of the file for now (other non-routing notifications may use it). We'll clean up unused notification names in a future phase if needed.

7. Also update `markStepCompleted` calls to use OnboardingStatusService:
- Add OnboardingStatusService dependency
- Call `onboardingStatusService.markStepCompleted(step)` in `persistStep()`
  </action>
  <verify>
1. Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | tail -20`
2. Grep for NotificationCenter.post with onboardingCompleted: `grep -n "NotificationCenter.default.post.*onboardingCompleted\|\.post(name: .onboardingCompleted" apps/ios/trendy/ViewModels/OnboardingViewModel.swift` should return empty
  </verify>
  <done>
OnboardingViewModel uses AppRouter.handleOnboardingComplete() instead of NotificationCenter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OnboardingContainerView to use AppRouter</name>
  <files>
    apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift
  </files>
  <action>
Modify `apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift`:

1. Add AppRouter environment:
```swift
@Environment(AppRouter.self) private var appRouter
```

2. In `initializeOnboarding()`, REMOVE this NotificationCenter post (around line 60):
```swift
// If onboarding is already complete, don't show onboarding UI
// The parent view should handle routing
if vm.isComplete {
    NotificationCenter.default.post(name: .onboardingCompleted, object: nil)
    return
}
```

REPLACE with:
```swift
// If onboarding is already complete, transition to main app
if vm.isComplete {
    appRouter.transitionToAuthenticated()
    return
}
```

3. Pass AppRouter to OnboardingViewModel:
```swift
// After creating vm
vm.setAppRouter(appRouter)
```

4. In `OnboardingNavigationView`, REMOVE the onChange handler for isComplete:
```swift
// REMOVE this entire block (around line 106-111):
.onChange(of: viewModel.isComplete) { _, isComplete in
    if isComplete {
        // Onboarding finished, notify parent
        NotificationCenter.default.post(name: .onboardingCompleted, object: nil)
    }
}
```

The viewModel now calls AppRouter directly in completeOnboarding(), so this observer is no longer needed.

5. Add OnboardingStatusService environment and pass to viewModel:
```swift
@Environment(OnboardingStatusService.self) private var onboardingStatusService
```

Then in initializeOnboarding():
```swift
vm.setOnboardingStatusService(onboardingStatusService)
```
  </action>
  <verify>
1. Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | tail -20`
2. Grep for NotificationCenter.post with onboardingCompleted: `grep -n "NotificationCenter.default.post.*onboardingCompleted\|\.post(name: .onboardingCompleted" apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift` should return empty
  </verify>
  <done>
OnboardingContainerView uses AppRouter.transitionToAuthenticated() instead of NotificationCenter.
  </done>
</task>

<task type="auto">
  <name>Task 3: Simplify ContentView and update LoginView</name>
  <files>
    apps/ios/trendy/ContentView.swift
    apps/ios/trendy/Views/Auth/LoginView.swift
  </files>
  <action>
**ContentView.swift changes:**

ContentView is no longer the main router - RootView handles that now. However, ContentView may still be used for screenshot mode. Simplify it:

1. REMOVE the NotificationCenter onReceive handler (around line 51-55):
```swift
// REMOVE this:
.onReceive(NotificationCenter.default.publisher(for: .onboardingCompleted)) { _ in
    withAnimation {
        onboardingComplete = true
    }
}
```

2. REMOVE the onboarding state management variables and checkOnboardingStatus() method:
- Remove `@State private var onboardingComplete`
- Remove `@State private var hasCheckedOnboarding`
- Remove `private static let onboardingCompleteKey`
- Remove `checkOnboardingStatus()` method
- Remove `.task { await checkOnboardingStatus() }`

3. ContentView should now ONLY handle screenshot mode routing:
```swift
struct ContentView: View {
    @Environment(AuthViewModel.self) private var authViewModel
    @Environment(\.modelContext) private var modelContext

    #if DEBUG
    private var isScreenshotMode: Bool {
        ScreenshotMockData.isScreenshotMode
    }
    #endif

    var body: some View {
        Group {
            #if DEBUG
            if isScreenshotMode {
                MainTabView()
                    .onAppear {
                        setupScreenshotMode()
                    }
            } else {
                // In non-screenshot debug mode, this view shouldn't be used
                // RootView handles routing via AppRouter
                Text("ContentView should not be shown - use RootView")
            }
            #else
            // In release builds, this view shouldn't be used
            // RootView handles routing via AppRouter
            Text("ContentView should not be shown - use RootView")
            #endif
        }
    }

    #if DEBUG
    private func setupScreenshotMode() {
        ScreenshotMockData.injectMockData(into: modelContext)
    }
    #endif
}
```

**LoginView.swift changes:**

LoginView needs to call AppRouter after successful login:

1. Add AppRouter environment:
```swift
@Environment(AppRouter.self) private var appRouter
```

2. After successful login (in the sign-in handler), call:
```swift
Task {
    await appRouter.handleLogin()
}
```

Note: The exact location depends on how LoginView currently handles auth. Look for where it calls supabaseService.signIn() or authViewModel.signIn() and add the AppRouter call after success.

If LoginView uses AuthViewModel, you may need to add the AppRouter call in AuthViewModel's sign-in success handler instead.
  </action>
  <verify>
1. Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | tail -20`
2. Grep for any remaining onboardingCompleted notifications in ContentView: `grep -n "onboardingCompleted\|NotificationCenter" apps/ios/trendy/ContentView.swift` should return empty (or only the extension definition)
  </verify>
  <done>
ContentView simplified to screenshot-mode only, LoginView wired to AppRouter.handleLogin().
  </done>
</task>

</tasks>

<verification>
1. Build succeeds without errors
2. No NotificationCenter.post calls with .onboardingCompleted in:
   - OnboardingViewModel.swift
   - OnboardingContainerView.swift
   - ContentView.swift
3. AppRouter.handleOnboardingComplete() is called when onboarding finishes
4. AppRouter.handleLogin() is called when user logs in from LoginView

Run full notification search:
```bash
grep -rn "NotificationCenter.default.post.*onboardingCompleted\|\.post(name: .onboardingCompleted" apps/ios/trendy/
```
Should return empty (no posts of onboardingCompleted notification).
</verification>

<success_criteria>
- [ ] OnboardingViewModel uses appRouter.handleOnboardingComplete() instead of NotificationCenter
- [ ] OnboardingContainerView uses appRouter.transitionToAuthenticated() instead of NotificationCenter
- [ ] ContentView simplified (no routing logic except screenshot mode)
- [ ] LoginView calls appRouter.handleLogin() after successful auth
- [ ] No NotificationCenter.default.post calls for .onboardingCompleted remain
- [ ] All files build without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-ios-state-architecture/09-03-SUMMARY.md`
</output>
