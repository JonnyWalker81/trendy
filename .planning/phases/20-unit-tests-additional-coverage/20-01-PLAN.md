---
phase: 20-unit-tests-additional-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendyTests/SyncEngine/SingleFlightTests.swift
  - apps/ios/trendyTests/SyncEngine/PaginationTests.swift
  - apps/ios/trendyTests/SyncEngine/BootstrapTests.swift
  - apps/ios/trendyTests/SyncEngine/BatchProcessingTests.swift
  - apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Test verifies single-flight pattern coalesces concurrent sync calls"
    - "Test verifies cursor pagination with hasMore flag and cursor advancement"
    - "Test verifies bootstrap fetch downloads full data and restores relationships"
    - "Test verifies batch processing with 50-event batches and partial failure handling"
    - "Test verifies health check detects captive portal (prevents false syncs)"
  artifacts:
    - path: "apps/ios/trendyTests/SyncEngine/SingleFlightTests.swift"
      provides: "Single-flight pattern tests"
      min_lines: 80
      exports: ["SingleFlightTests"]
    - path: "apps/ios/trendyTests/SyncEngine/PaginationTests.swift"
      provides: "Cursor pagination tests"
      min_lines: 100
      exports: ["PaginationTests"]
    - path: "apps/ios/trendyTests/SyncEngine/BootstrapTests.swift"
      provides: "Bootstrap fetch and relationship restoration tests"
      min_lines: 120
      exports: ["BootstrapTests"]
    - path: "apps/ios/trendyTests/SyncEngine/BatchProcessingTests.swift"
      provides: "Batch processing and partial failure tests"
      min_lines: 100
      exports: ["BatchProcessingTests"]
    - path: "apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift"
      provides: "Health check and captive portal detection tests"
      min_lines: 80
      exports: ["HealthCheckTests"]
  key_links:
    - from: "SingleFlightTests"
      to: "SyncEngine.performSync"
      via: "concurrent TaskGroup calls"
      pattern: "withThrowingTaskGroup.*performSync"
    - from: "PaginationTests"
      to: "SyncEngine.pullChanges"
      via: "getChangesResponses queue"
      pattern: "getChangesResponses.*hasMore"
    - from: "BootstrapTests"
      to: "SyncEngine.bootstrapFetch"
      via: "cursor=0 triggers bootstrap"
      pattern: "set\\(0.*cursor"
    - from: "HealthCheckTests"
      to: "SyncEngine.performHealthCheck"
      via: "getEventTypesResponses failure"
      pattern: "decodingError"
---

<objective>
Create comprehensive unit tests for SyncEngine's single-flight pattern, cursor pagination, bootstrap fetch with relationship restoration, batch processing with partial failures, and health check captive portal detection.

Purpose: Verify five critical sync patterns not covered in previous test phases (circuit breaker, resurrection prevention, deduplication). These tests ensure concurrent sync calls coalesce, pagination advances correctly, bootstrap restores relationships, batch failures are handled gracefully, and captive portals don't cause false syncs.

Output:
- SingleFlightTests.swift - Tests concurrent sync call coalescing
- PaginationTests.swift - Tests cursor advancement and hasMore flag
- BootstrapTests.swift - Tests full data download and relationship restoration
- BatchProcessingTests.swift - Tests 50-event batches and partial failure handling
- HealthCheckTests.swift - Tests captive portal detection
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-unit-tests-additional-coverage/20-CONTEXT.md
@.planning/phases/20-unit-tests-additional-coverage/20-RESEARCH.md

# Existing test patterns to follow
@apps/ios/trendyTests/SyncEngine/CircuitBreakerTests.swift
@apps/ios/trendyTests/SyncEngine/DeduplicationTests.swift
@apps/ios/trendyTests/SyncEngine/ResurrectionPreventionTests.swift

# Mock infrastructure
@apps/ios/trendyTests/Mocks/MockNetworkClient.swift
@apps/ios/trendyTests/Mocks/MockDataStore.swift
@apps/ios/trendyTests/Mocks/MockDataStoreFactory.swift

# SyncEngine implementation
@apps/ios/trendy/Services/Sync/SyncEngine.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SingleFlightTests and PaginationTests</name>
  <files>apps/ios/trendyTests/SyncEngine/SingleFlightTests.swift, apps/ios/trendyTests/SyncEngine/PaginationTests.swift</files>
  <action>
Create two test files following the established patterns from CircuitBreakerTests.swift and DeduplicationTests.swift.

**SingleFlightTests.swift (apps/ios/trendyTests/SyncEngine/SingleFlightTests.swift):**

Structure:
```swift
//
//  SingleFlightTests.swift
//  trendyTests
//
//  Unit tests for SyncEngine single-flight pattern.
//  Verifies concurrent sync calls are coalesced into single execution.
//
//  Requirements tested:
//  - SYNC-01: Test single-flight pattern (concurrent sync calls coalesced)
//

import Testing
import Foundation
@testable import trendy
```

**Test helpers:** Reuse the established `makeTestDependencies()` and `configureForFlush()` patterns from existing tests.

**@Suite("Single Flight Pattern")**

Tests to create:

1. `testSYNC01_ConcurrentSyncCallsCoalesce()` - Covers SYNC-01
   - Create fresh dependencies with `makeTestDependencies()`
   - Configure for successful sync (health check passes, cursor set, empty change feed)
   - Use `withThrowingTaskGroup` to launch 5 concurrent `engine.performSync()` calls
   - Verify network call count shows only 1 set of calls was made (not 5)
   - Check via `mockNetwork.getEventTypesCalls.count` or similar

2. `testConcurrentSyncCallsAllReceiveResult()`
   - Verify all concurrent callers complete (don't hang)
   - Use TaskGroup and ensure all 5 tasks complete successfully

3. `testSecondSyncAfterFirstCompletesExecutesNormally()`
   - First sync completes
   - Second sync executes (not coalesced because first is done)
   - Verify 2 sets of network calls

**PaginationTests.swift (apps/ios/trendyTests/SyncEngine/PaginationTests.swift):**

Structure:
```swift
//
//  PaginationTests.swift
//  trendyTests
//
//  Unit tests for SyncEngine cursor pagination.
//  Verifies hasMore flag and cursor advancement work correctly.
//
//  Requirements tested:
//  - SYNC-02: Test cursor pagination (hasMore flag, cursor advancement)
//

import Testing
import Foundation
@testable import trendy
```

**@Suite("Cursor Pagination")**

Tests to create:

1. `testSYNC02_PaginationAdvancesCursorUntilHasMoreFalse()` - Covers SYNC-02
   - Configure health check to pass
   - Set cursor to non-zero (1000) to skip bootstrap
   - Configure multi-page getChangesResponses:
     - Page 1: changes=[], nextCursor=2000, hasMore=true
     - Page 2: changes=[], nextCursor=3000, hasMore=true
     - Page 3: changes=[], nextCursor=4000, hasMore=false
   - Call `engine.performSync()`
   - Verify 3 getChangesCalls were made
   - Verify cursor progression: 1000 -> 2000 -> 3000

2. `testPaginationStopsImmediatelyWhenHasMoreFalse()`
   - Configure single-page response with hasMore=false
   - Verify only 1 getChangesCalls made

3. `testCursorSavedToUserDefaults()`
   - Configure pagination responses
   - After sync, verify UserDefaults has correct cursor value
   - Use key: "sync_engine_cursor_\(AppEnvironment.current.rawValue)"

4. `testEmptyChangesStillAdvancesCursor()`
   - Changes array empty but hasMore=true
   - Verify cursor still advances

**Import and helper patterns:**
- `@testable import trendy`
- `import Testing`, `import Foundation`
- Use `makeTestDependencies()` helper (copy from existing tests)
- Use `configureForFlush()` for pagination tests (since cursor > 0)
- Reset UserDefaults cursor in each test setup
  </action>
  <verify>
Verify test files compile with Swift syntax check:
```bash
cd /Users/cipher/Repositories/trendy/apps/ios && swiftc -parse -target arm64-apple-ios17.0-simulator -sdk $(xcrun --sdk iphonesimulator --show-sdk-path) trendyTests/SyncEngine/SingleFlightTests.swift trendyTests/SyncEngine/PaginationTests.swift 2>&1 | head -20
```

If swiftc syntax check has import issues (expected since dependencies not resolved), verify file exists and has correct structure:
```bash
head -50 /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/SingleFlightTests.swift
head -50 /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/PaginationTests.swift
wc -l /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/SingleFlightTests.swift
wc -l /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/PaginationTests.swift
```
  </verify>
  <done>
SingleFlightTests.swift and PaginationTests.swift exist in apps/ios/trendyTests/SyncEngine/, each contains @Suite with @Test functions covering SYNC-01 and SYNC-02 requirements, follows established test patterns from phases 17-19.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BootstrapTests and BatchProcessingTests</name>
  <files>apps/ios/trendyTests/SyncEngine/BootstrapTests.swift, apps/ios/trendyTests/SyncEngine/BatchProcessingTests.swift</files>
  <action>
Create two test files for bootstrap fetch and batch processing.

**BootstrapTests.swift (apps/ios/trendyTests/SyncEngine/BootstrapTests.swift):**

Structure:
```swift
//
//  BootstrapTests.swift
//  trendyTests
//
//  Unit tests for SyncEngine bootstrap fetch.
//  Verifies full data download and relationship restoration.
//
//  Requirements tested:
//  - SYNC-03: Test bootstrap fetch (full data download, relationship restoration)
//

import Testing
import Foundation
@testable import trendy
```

**@Suite("Bootstrap Fetch")**

Tests to create:

1. `testSYNC03_BootstrapRestoresEventToEventTypeRelationships()` - Covers SYNC-03
   - Set cursor to 0 (triggers bootstrap)
   - Configure health check to pass
   - Configure getEventTypesResponses with one EventType (id: "type-1", name: "Work")
   - Configure getGeofencesResponses with empty array
   - Configure getAllEventsResponses with one Event (id: "evt-1", eventTypeId: "type-1")
   - Configure getLatestCursorResponses with cursor value (e.g., 1000)
   - Configure getPropertyDefinitionsResponses with empty array
   - After sync, verify:
     - Event exists in mockStore
     - event.eventType is NOT nil
     - event.eventType?.id == "type-1"
     - event.eventType?.name == "Work"

2. `testBootstrapTriggeredWhenCursorIsZero()`
   - Set cursor to 0
   - Configure all bootstrap responses
   - Verify getAllEventsCalls is called (bootstrap behavior)

3. `testBootstrapNotTriggeredWhenCursorNonZero()`
   - Set cursor to 1000
   - Verify getAllEventsCalls is NOT called (incremental sync only)

4. `testBootstrapUpdatesLatestCursorAfterCompletion()`
   - Set cursor to 0
   - Configure getLatestCursorResponses to return 5000
   - After sync, verify UserDefaults cursor is 5000

5. `testBootstrapDownloadsAllEventTypes()`
   - Configure multiple EventTypes
   - Verify all are stored in mockStore

**BatchProcessingTests.swift (apps/ios/trendyTests/SyncEngine/BatchProcessingTests.swift):**

Structure:
```swift
//
//  BatchProcessingTests.swift
//  trendyTests
//
//  Unit tests for SyncEngine batch processing.
//  Verifies 50-event batch size and partial failure handling.
//
//  Requirements tested:
//  - SYNC-04: Test batch processing (50-event batches, partial failure handling)
//

import Testing
import Foundation
@testable import trendy
```

**Helper for seeding multiple mutations:**
```swift
private func seedMultipleMutations(mockStore: MockDataStore, count: Int, prefix: String = "evt") {
    for i in 0..<count {
        let eventId = "\(prefix)-\(i)"
        let request = APIModelFixture.makeCreateEventRequest(id: eventId, eventTypeId: "type-1")
        let payload = try! JSONEncoder().encode(request)
        _ = mockStore.seedPendingMutation(entityType: .event, entityId: eventId, operation: .create, payload: payload)
    }
}
```

**@Suite("Batch Processing")**

Tests to create:

1. `testSYNC04_BatchProcessingHandlesPartialFailures()` - Covers SYNC-04
   - Configure for flush (health check, cursor, empty change feed)
   - Seed 3 mutations (evt-1, evt-2, evt-3)
   - Configure batch response: created=[evt-1, evt-3], errors=[{index:1, message:"Failed"}]
   - After sync, verify:
     - Successful mutations removed from queue
     - Failed mutation (evt-2) still pending
     - Failed mutation has attempts incremented

2. `testBatchSizeIs50Events()`
   - Seed 60 mutations
   - Configure 2 batch responses (first batch: 50, second batch: 10)
   - Verify 2 createEventsBatchCalls made
   - First call has 50 events, second has 10

3. `testWholeBatchFailureKeepsAllPending()`
   - Seed 3 mutations
   - Configure batch response with failure (error, not success)
   - Verify all 3 mutations still pending

4. `testSuccessfulBatchRemovesAllFromQueue()`
   - Seed 3 mutations
   - Configure batch response: all 3 created successfully
   - Verify no pending mutations remain

5. `testBatchFailureIncrementsAttemptCount()`
   - Seed 1 mutation
   - Configure batch failure response
   - After sync, verify mutation.attempts == 1

**Key implementation notes:**
- For bootstrap tests: Set cursor to 0 with `UserDefaults.standard.set(0, forKey: "sync_engine_cursor_\(AppEnvironment.current.rawValue)")`
- For batch tests: Use `configureForFlush()` pattern from CircuitBreakerTests
- Batch responses use `createEventsBatchResponses` array in MockNetworkClient
  </action>
  <verify>
Verify test files exist and have correct structure:
```bash
head -50 /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/BootstrapTests.swift
head -50 /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/BatchProcessingTests.swift
wc -l /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/BootstrapTests.swift
wc -l /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/BatchProcessingTests.swift
```
  </verify>
  <done>
BootstrapTests.swift and BatchProcessingTests.swift exist in apps/ios/trendyTests/SyncEngine/, each contains @Suite with @Test functions covering SYNC-03 and SYNC-04 requirements, includes relationship restoration verification and partial failure handling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create HealthCheckTests</name>
  <files>apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift</files>
  <action>
Create test file for health check and captive portal detection.

**HealthCheckTests.swift (apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift):**

Structure:
```swift
//
//  HealthCheckTests.swift
//  trendyTests
//
//  Unit tests for SyncEngine health check.
//  Verifies captive portal detection prevents false syncs.
//
//  Requirements tested:
//  - SYNC-05: Test health check detects captive portal (prevents false syncs)
//

import Testing
import Foundation
@testable import trendy
```

**@Suite("Health Check")**

Tests to create:

1. `testSYNC05_HealthCheckDetectsCaptivePortalAndPreventsSync()` - Covers SYNC-05
   - Create fresh dependencies
   - Set cursor to non-zero (skip bootstrap)
   - Seed a pending mutation (so sync would try to flush if health check passed)
   - Configure getEventTypesResponses with failure: `.failure(APIError.decodingError("Expected array, got HTML"))`
   - Record network call count before sync
   - Call `engine.performSync()`
   - Verify:
     - Only 1 network call made (health check)
     - No flush operations occurred (createEventsBatchCalls.count == 0)
     - Pending mutation still exists

2. `testHealthCheckPassesWithValidResponse()`
   - Configure getEventTypesResponses with success
   - Configure full sync setup (change feed, etc.)
   - Verify sync proceeds normally
   - Verify mutation is flushed

3. `testHealthCheckFailureWithNetworkError()`
   - Configure getEventTypesResponses with network error
   - Verify sync blocked
   - Verify mutation still pending

4. `testHealthCheckCalledBeforeEverySync()`
   - Configure multiple health check responses
   - Call performSync() twice
   - Verify getEventTypesCalls.count >= 2

5. `testSyncBlockedDuringCaptivePortal()`
   - Configure health check to return HTML/decoding error
   - Verify no mutations flushed
   - Verify no pullChanges called

**Key captive portal simulation patterns:**
- `APIError.decodingError("...")` - simulates HTML response from captive portal
- `APIError.networkError(...)` - simulates redirect failure
- Key assertion: Only getEventTypes called, no other network operations

**Helper functions:**
```swift
private func makeTestDependencies() -> (mockNetwork: MockNetworkClient, mockStore: MockDataStore, factory: MockDataStoreFactory, engine: SyncEngine) {
    let mockNetwork = MockNetworkClient()
    let mockStore = MockDataStore()
    let factory = MockDataStoreFactory(mockStore: mockStore)
    let engine = SyncEngine(networkClient: mockNetwork, dataStoreFactory: factory)
    return (mockNetwork, mockStore, factory, engine)
}

private func seedEventMutation(mockStore: MockDataStore, eventId: String) {
    let request = APIModelFixture.makeCreateEventRequest(id: eventId, eventTypeId: "type-1")
    let payload = try! JSONEncoder().encode(request)
    _ = mockStore.seedPendingMutation(entityType: .event, entityId: eventId, operation: .create, payload: payload)
}
```
  </action>
  <verify>
Verify test file exists and has correct structure:
```bash
head -80 /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift
wc -l /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift
grep -c "@Test" /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/HealthCheckTests.swift
```
  </verify>
  <done>
HealthCheckTests.swift exists in apps/ios/trendyTests/SyncEngine/, contains @Suite with @Test functions covering SYNC-05 requirement, simulates captive portal with decodingError and verifies sync is blocked.
  </done>
</task>

</tasks>

<verification>
1. All 5 test files exist in apps/ios/trendyTests/SyncEngine/
2. SingleFlightTests.swift has @Test for SYNC-01 (concurrent call coalescing)
3. PaginationTests.swift has @Test for SYNC-02 (cursor advancement)
4. BootstrapTests.swift has @Test for SYNC-03 (relationship restoration)
5. BatchProcessingTests.swift has @Test for SYNC-04 (partial failure handling)
6. HealthCheckTests.swift has @Test for SYNC-05 (captive portal detection)
7. All test files follow established patterns from phases 17-19
8. Test files have requirement comments (e.g., "// Covers SYNC-01: ...")
9. Fresh dependencies per test (makeTestDependencies pattern)
10. Tests will compile once FullDisclosureSDK blocker resolved

Verify with:
```bash
ls -la /Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/*.swift
for f in SingleFlightTests PaginationTests BootstrapTests BatchProcessingTests HealthCheckTests; do
  echo "=== $f ===" && grep -c "@Test" "/Users/cipher/Repositories/trendy/apps/ios/trendyTests/SyncEngine/${f}.swift"
done
```
</verification>

<success_criteria>
- SingleFlightTests.swift verifies concurrent sync calls coalesce (SYNC-01)
- PaginationTests.swift verifies cursor pagination with hasMore flag (SYNC-02)
- BootstrapTests.swift verifies bootstrap restores event-to-eventType relationships (SYNC-03)
- BatchProcessingTests.swift verifies 50-event batches and partial failure handling (SYNC-04)
- HealthCheckTests.swift verifies captive portal detection blocks sync (SYNC-05)
- All tests follow fresh-dependencies-per-test pattern
- All tests have structured names and requirement comments
- Test files compile (syntax validation with swiftc -parse or equivalent)
</success_criteria>

<output>
After completion, create `.planning/phases/20-unit-tests-additional-coverage/20-01-SUMMARY.md`
</output>
