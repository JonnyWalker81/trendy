---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/GeofenceManager.swift
  - apps/ios/trendy/trendy.entitlements
autonomous: true

must_haves:
  truths:
    - "All GeofenceManager logging uses structured Log.geofence.* calls"
    - "No print() statements remain in GeofenceManager.swift"
    - "HealthKit background delivery entitlement is present and verified"
  artifacts:
    - path: "apps/ios/trendy/Services/GeofenceManager.swift"
      provides: "Geofence monitoring with structured logging"
      contains: "Log.geofence"
    - path: "apps/ios/trendy/trendy.entitlements"
      provides: "iOS entitlements including HealthKit background delivery"
      contains: "com.apple.developer.healthkit.background-delivery"
  key_links:
    - from: "GeofenceManager.swift"
      to: "Log.geofence"
      via: "structured logging calls"
      pattern: "Log\\.geofence\\."
---

<objective>
Replace all print() statements in GeofenceManager.swift with structured Log.geofence.* calls, and verify HealthKit background delivery entitlement is properly configured.

Purpose: Complete the logging migration for the second major iOS service, ensuring consistent logging patterns across HealthKit and Geofence systems. Verify entitlements are correct for background delivery.

Output: GeofenceManager.swift with 0 print() statements and structured logging throughout. Verified entitlements file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing logging infrastructure - use this pattern:
@apps/ios/trendy/Utilities/Logger.swift

# Target files for this plan:
@apps/ios/trendy/Services/GeofenceManager.swift
@apps/ios/trendy/trendy.entitlements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace print() with Log.geofence in GeofenceManager.swift</name>
  <files>apps/ios/trendy/Services/GeofenceManager.swift</files>
  <action>
    Replace all 45 print() statements with appropriate Log.geofence.* calls:

    **Mapping rules:**
    - `print("âœ… ...` (success messages) â†’ `Log.geofence.info(...)`
    - `print("âŒ ...` or `print("âš ï¸ ...` (errors/warnings) â†’ `Log.geofence.warning(...)` or `Log.geofence.error(...)`
    - `print("ðŸ” ...` (lookups/tracing) â†’ `Log.geofence.debug(...)`
    - `print("ðŸ“ ...` or `print("ðŸ“ ...` (actions) â†’ `Log.geofence.debug(...)`
    - `print("ðŸ§ª ...` (test/debug) â†’ `Log.geofence.debug(...)` in #if DEBUG block
    - Multi-line print blocks â†’ Single Log.* call with context builder

    **Context patterns to use:**
    ```swift
    // For success with data:
    Log.geofence.info("Started monitoring geofence", context: .with { ctx in
        ctx.add("name", geofence.name)
        ctx.add("id", geofence.id)
        ctx.add("radius", Int(geofence.radius))
    })

    // For errors:
    Log.geofence.error("Geofence not found", context: .with { ctx in
        ctx.add("geofenceId", geofenceId)
    })
    ```

    **Specific transformations (by line number from grep):**
    - Line 152 (insufficient auth warning): `Log.geofence.warning()`
    - Line 162 (failed to fetch): `Log.geofence.error()`
    - Line 170 (>20 geofences): `Log.geofence.warning()` with count
    - Line 177 (started monitoring): `Log.geofence.info()` with count
    - Lines 200-202 (monitoring details): Consolidate into single `Log.geofence.debug()` with context
    - Lines 306, 313 (debug simulation): Wrap in #if DEBUG, use `Log.geofence.debug()`
    - Lines 363-403 (handleGeofenceEntry): Convert all to appropriate Log.geofence levels
    - Line 459 (save failed): `Log.geofence.error()` with error context

    **DO NOT:**
    - Change any business logic
    - Modify function signatures
    - Change error handling flow
  </action>
  <verify>
    ```bash
    grep -c "print(" apps/ios/trendy/Services/GeofenceManager.swift
    # Expected: 0

    grep -c "Log.geofence" apps/ios/trendy/Services/GeofenceManager.swift
    # Expected: 45+ (roughly same as print count)
    ```
  </verify>
  <done>
    - Zero print() statements in GeofenceManager.swift
    - All logging uses Log.geofence.* pattern
    - File compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and document entitlements configuration</name>
  <files>apps/ios/trendy/trendy.entitlements</files>
  <action>
    Verify the entitlements file contains all required entries for background HealthKit delivery:

    **Required entitlements:**
    1. `com.apple.developer.healthkit` = true (HealthKit access)
    2. `com.apple.developer.healthkit.background-delivery` = true (background updates)
    3. `com.apple.security.application-groups` containing the app group ID

    **Verification steps:**
    1. Read the entitlements file
    2. Confirm all three keys are present with correct values
    3. Document the app group identifier being used

    **If any entitlement is missing:**
    Add it to the file. The entitlements file should look like:
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <key>com.apple.developer.healthkit</key>
        <true/>
        <key>com.apple.developer.healthkit.background-delivery</key>
        <true/>
        <key>com.apple.security.application-groups</key>
        <array>
            <string>group.com.memento.trendy</string>
        </array>
    </dict>
    </plist>
    ```

    **Note:** The entitlements file configures what capabilities the app REQUESTS. The actual provisioning profile (configured in Apple Developer Portal) must ALSO include these capabilities. This task verifies the code-side configuration only. Provisioning profile must be verified separately in Xcode or the developer portal.
  </action>
  <verify>
    ```bash
    # Check entitlements file contains required keys
    grep "healthkit.background-delivery" apps/ios/trendy/trendy.entitlements && echo "Background delivery entitlement: PRESENT"
    grep "com.apple.developer.healthkit" apps/ios/trendy/trendy.entitlements && echo "HealthKit entitlement: PRESENT"
    grep "application-groups" apps/ios/trendy/trendy.entitlements && echo "App Groups entitlement: PRESENT"
    ```
  </verify>
  <done>
    - Entitlements file verified to contain HealthKit background delivery
    - App group identifier documented
    - Any missing entitlements added
  </done>
</task>

<task type="auto">
  <name>Task 3: Add startup logging for entitlement verification</name>
  <files>apps/ios/trendy/Services/HealthKitService.swift</files>
  <action>
    Enhance the `verifyAppGroupSetup()` method to log entitlement status using structured logging.

    In the existing `verifyAppGroupSetup()` method (lines 176-200), replace the print statements that were converted in Plan 01-01 with additional entitlement context:

    ```swift
    private func verifyAppGroupSetup() {
        // Test App Group access
        let testKey = "healthKitAppGroupTest"
        let testValue = "verified-\(Date().timeIntervalSince1970)"

        Self.sharedDefaults.set(testValue, forKey: testKey)
        Self.sharedDefaults.synchronize()

        let readValue = Self.sharedDefaults.string(forKey: testKey)
        let appGroupWorking = readValue == testValue

        Log.healthKit.info("App Group verification", context: .with { ctx in
            ctx.add("success", appGroupWorking)
            ctx.add("usingAppGroup", Self.isUsingAppGroup)
            ctx.add("appGroupId", Self.appGroupIdentifier)
        })

        if !appGroupWorking {
            Log.healthKit.error("App Group verification failed - check entitlements and provisioning profile", context: .with { ctx in
                ctx.add("expected", testValue)
                ctx.add("actual", readValue ?? "nil")
            })
        }

        Self.sharedDefaults.removeObject(forKey: testKey)
    }
    ```

    This provides clear diagnostic logging at startup that helps identify entitlement issues.
  </action>
  <verify>
    ```bash
    # Verify the method uses Log.healthKit
    grep -A 20 "func verifyAppGroupSetup" apps/ios/trendy/Services/HealthKitService.swift | grep "Log.healthKit"
    # Expected: At least 2 matches (info and error cases)
    ```
  </verify>
  <done>
    - verifyAppGroupSetup() uses structured logging
    - Entitlement issues are clearly logged at startup
    - No print() statements in verification method
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `grep -c "print(" apps/ios/trendy/Services/GeofenceManager.swift` returns 0
- [ ] `grep -c "Log.geofence" apps/ios/trendy/Services/GeofenceManager.swift` returns 45+
- [ ] Entitlements file contains `healthkit.background-delivery`
- [ ] Xcode build succeeds without errors
</verification>

<success_criteria>

- All 45 print() statements in GeofenceManager replaced with Log.geofence.* calls
- Logging levels appropriately chosen (debug/info/warning/error)
- Entitlements file verified to contain all required keys
- Startup logging provides clear entitlement diagnostics
- Both files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
