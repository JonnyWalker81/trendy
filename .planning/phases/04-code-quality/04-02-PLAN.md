---
phase: 04-code-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/GeofenceManager.swift
  - apps/ios/trendy/Services/Geofence/GeofenceManager.swift
  - apps/ios/trendy/Services/Geofence/GeofenceManager+Authorization.swift
  - apps/ios/trendy/Services/Geofence/GeofenceManager+Registration.swift
  - apps/ios/trendy/Services/Geofence/GeofenceManager+EventHandling.swift
  - apps/ios/trendy/Services/Geofence/GeofenceManager+CLLocationManagerDelegate.swift
  - apps/ios/trendy/Services/Geofence/GeofenceHealthStatus.swift
  - apps/ios/trendy/Services/Geofence/CLAuthorizationStatus+Description.swift
autonomous: true

must_haves:
  truths:
    - "GeofenceManager functionality unchanged (all features work identically)"
    - "No single file exceeds 300 lines"
    - "Build succeeds with no errors or warnings"
    - "Each file handles at most 2 distinct responsibilities"
  artifacts:
    - path: "apps/ios/trendy/Services/Geofence/GeofenceManager.swift"
      provides: "Main coordinator class with properties and initialization"
      max_lines: 200
    - path: "apps/ios/trendy/Services/Geofence/GeofenceManager+Authorization.swift"
      provides: "Location authorization request flow"
      max_lines: 100
    - path: "apps/ios/trendy/Services/Geofence/GeofenceManager+Registration.swift"
      provides: "Region registration, reconciliation, monitoring"
      max_lines: 250
    - path: "apps/ios/trendy/Services/Geofence/GeofenceManager+EventHandling.swift"
      provides: "Geofence entry/exit event creation and active event tracking"
      max_lines: 300
    - path: "apps/ios/trendy/Services/Geofence/GeofenceManager+CLLocationManagerDelegate.swift"
      provides: "CLLocationManagerDelegate protocol conformance"
      max_lines: 150
    - path: "apps/ios/trendy/Services/Geofence/GeofenceHealthStatus.swift"
      provides: "Health status struct definition"
      max_lines: 80
    - path: "apps/ios/trendy/Services/Geofence/CLAuthorizationStatus+Description.swift"
      provides: "CLAuthorizationStatus description extension"
      max_lines: 30
  key_links:
    - from: "GeofenceManager.swift"
      to: "All extension files"
      via: "Internal access modifiers"
      pattern: "internal (var|let|func)"
    - from: "Extension files"
      to: "GeofenceManager properties"
      via: "Access to internal properties"
      pattern: "self\\.(locationManager|modelContext|eventStore)"
---

<objective>
Split GeofenceManager.swift (950 lines) into focused extension files organized by responsibility.

Purpose: Satisfy CODE-03 requirement by separating concerns (auth, registration, event handling) into distinct modules <300 lines each.

Output: 7 files in apps/ios/trendy/Services/Geofence/ directory, each handling a single concern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-code-quality/04-RESEARCH.md
@apps/ios/trendy/Services/GeofenceManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Geofence directory and extract standalone types</name>
  <files>
    apps/ios/trendy/Services/Geofence/GeofenceHealthStatus.swift
    apps/ios/trendy/Services/Geofence/CLAuthorizationStatus+Description.swift
  </files>
  <action>
Create the apps/ios/trendy/Services/Geofence/ directory structure.

**GeofenceHealthStatus.swift** (~70 lines):
Imports: Foundation, CoreLocation

Move the entire GeofenceHealthStatus struct (lines 14-66 of original):
- struct GeofenceHealthStatus
- registeredWithiOS, savedInApp, authorizationStatus, locationServicesEnabled
- missingFromiOS, orphanedIniOS computed properties
- isHealthy, statusSummary computed properties

This is a standalone type, not an extension.

**CLAuthorizationStatus+Description.swift** (~25 lines):
Imports: Foundation, CoreLocation

Move the CLAuthorizationStatus extension (lines 931-950 of original):
- extension CLAuthorizationStatus
- var description: String

This is a standalone extension on CLAuthorizationStatus, not on GeofenceManager.
  </action>
  <verify>
Both files exist and compile independently.
GeofenceHealthStatus.swift < 80 lines.
CLAuthorizationStatus+Description.swift < 30 lines.
  </verify>
  <done>Standalone types extracted to separate files.</done>
</task>

<task type="auto">
  <name>Task 2: Create main coordinator and authorization extension</name>
  <files>
    apps/ios/trendy/Services/Geofence/GeofenceManager.swift
    apps/ios/trendy/Services/Geofence/GeofenceManager+Authorization.swift
  </files>
  <action>
**GeofenceManager.swift** (~150 lines):
Imports: Foundation, CoreLocation, SwiftData, Observation

Create the main coordinator containing ONLY:
1. File header and imports
2. @Observable class declaration
3. MARK: - Notification Names (lines 73-78)
4. MARK: - Properties section (lines 80-114):
   - locationManager, modelContext, eventStore, notificationManager
   - authorizationStatus, lastError, pendingAlwaysAuthorizationRequest
   - isLocationServicesEnabled, monitoredRegions
   - activeGeofenceEvents, lastEventTimestamp, lastEventDescription
5. MARK: - Initialization section (lines 116-162):
   - init() method with notification observers
6. MARK: - Lifecycle section (lines 234-239):
   - deinit

Change `private` to `internal` for properties accessed by extensions:
- locationManager
- pendingAlwaysAuthorizationRequest
- activeGeofenceEvents

Do NOT include any other methods - they go to extension files.

**GeofenceManager+Authorization.swift** (~80 lines):
Imports: Foundation, CoreLocation

Move authorization methods (lines 164-232 of original):
- MARK: - Authorization
- requestWhenInUseAuthorization()
- requestAlwaysAuthorization()
- hasGeofencingAuthorization computed property
- currentLocation computed property
- requestGeofencingAuthorization() -> Bool
  </action>
  <verify>
GeofenceManager.swift < 200 lines with only properties and init/deinit.
GeofenceManager+Authorization.swift < 100 lines.
Both files compile.
  </verify>
  <done>Main coordinator and authorization extension created.</done>
</task>

<task type="auto">
  <name>Task 3: Create registration and event handling extensions</name>
  <files>
    apps/ios/trendy/Services/Geofence/GeofenceManager+Registration.swift
    apps/ios/trendy/Services/Geofence/GeofenceManager+EventHandling.swift
  </files>
  <action>
**GeofenceManager+Registration.swift** (~200 lines):
Imports: Foundation, CoreLocation, SwiftData

Move geofence management methods (lines 241-441 of original):
- MARK: - Geofence Management
- startMonitoringAllGeofences()
- startMonitoring(geofence:)
- stopMonitoring(geofence:)
- stopMonitoringAllGeofences()
- refreshMonitoredGeofences()
- reconcileRegions(desired:)
- ensureRegionsRegistered()
- MARK: - Debug/Testing Methods (lines 443-463)
- simulateEntry(geofenceId:) (#if DEBUG)
- simulateExit(geofenceId:) (#if DEBUG)
- MARK: - Debug Properties (lines 489-524)
- monitoredRegionIdentifiers, activeGeofenceEventCount, activeGeofenceIds
- healthStatus computed property

**GeofenceManager+EventHandling.swift** (~250 lines):
Imports: Foundation, CoreLocation, SwiftData

Move event handling methods:
- MARK: - Active Geofence Events (lines 465-487)
- loadActiveGeofenceEvents() (private -> internal)
- saveActiveGeofenceEvents() (private -> internal)
- activeEvent(for:) -> String?
- MARK: - Launch and Background Event Handlers (lines 526-581)
- handleNormalLaunch(_:) (@objc)
- handleBackgroundEntry(_:) (@objc)
- handleBackgroundExit(_:) (@objc)
- MARK: - Event Creation/Update (lines 583-800)
- handleGeofenceEntry(geofenceId:) (private -> internal)
- handleGeofenceExit(geofenceId:) (private -> internal)
- clearError()

Change `private` to `internal` on methods that need to be called from the delegate extension.
  </action>
  <verify>
GeofenceManager+Registration.swift < 250 lines.
GeofenceManager+EventHandling.swift < 300 lines.
Both files compile.
  </verify>
  <done>Registration and event handling concerns separated into focused files.</done>
</task>

<task type="auto">
  <name>Task 4: Create CLLocationManagerDelegate extension and remove original</name>
  <files>
    apps/ios/trendy/Services/Geofence/GeofenceManager+CLLocationManagerDelegate.swift
    apps/ios/trendy/Services/GeofenceManager.swift
  </files>
  <action>
**GeofenceManager+CLLocationManagerDelegate.swift** (~130 lines):
Imports: Foundation, CoreLocation

Move the delegate extension (lines 803-929 of original):
- extension GeofenceManager: CLLocationManagerDelegate
- locationManagerDidChangeAuthorization(_:)
- locationManager(_:didEnterRegion:)
- locationManager(_:didExitRegion:)
- locationManager(_:didDetermineState:for:)
- locationManager(_:monitoringDidFailFor:withError:)
- locationManager(_:didStartMonitoringFor:)

This extension calls handleGeofenceEntry/Exit which are now in EventHandling extension.
Since those methods are now `internal`, they can be called across extension files.

**Delete original file:**
1. Delete the original apps/ios/trendy/Services/GeofenceManager.swift file.

2. Run the build to verify everything compiles:
   ```
   cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | head -100
   ```

3. If there are compilation errors:
   - Fix missing imports in extension files
   - Fix access control issues (private -> internal)
   - Ensure GeofenceHealthStatus is imported where needed

4. Count lines in each new file:
   ```
   wc -l apps/ios/trendy/Services/Geofence/*.swift
   ```
  </action>
  <verify>
Build succeeds with exit code 0.
Original GeofenceManager.swift is deleted.
GeofenceManager+CLLocationManagerDelegate.swift < 150 lines.
All files in Geofence/ are under 300 lines.
  </verify>
  <done>GeofenceManager decomposition complete - 7 focused files, all under 300 lines, build passes.</done>
</task>

</tasks>

<verification>
After all tasks:
1. Build succeeds: `xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build`
2. No file exceeds 300 lines: `wc -l apps/ios/trendy/Services/Geofence/*.swift`
3. Original file removed: `ls apps/ios/trendy/Services/GeofenceManager.swift` returns "No such file"
4. All extension files have correct imports and compile independently
</verification>

<success_criteria>
- CODE-03 requirement satisfied: GeofenceManager has clean separation of concerns
- Auth, registration, and event handling in separate files
- No file exceeds 300 lines
- Build passes with no errors
- All existing functionality preserved (no behavioral changes)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-02-SUMMARY.md`
</output>
