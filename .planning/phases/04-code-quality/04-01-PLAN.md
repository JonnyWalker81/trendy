---
phase: 04-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/HealthKitService.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+Authorization.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+Persistence.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+WorkoutProcessing.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+SleepProcessing.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+DailyAggregates.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+EventFactory.swift
  - apps/ios/trendy/Services/HealthKit/HealthKitService+Debug.swift
  - apps/ios/trendy/Services/HealthKit/HKWorkoutActivityType+Name.swift
autonomous: true

must_haves:
  truths:
    - "HealthKitService functionality unchanged (all features work identically)"
    - "No single file exceeds 400 lines"
    - "Build succeeds with no errors or warnings"
    - "Each file handles at most 2 distinct responsibilities"
  artifacts:
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService.swift"
      provides: "Main coordinator class with properties and initialization"
      max_lines: 250
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+Authorization.swift"
      provides: "Authorization request and status methods"
      max_lines: 150
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift"
      provides: "Observer query setup, background delivery, monitoring"
      max_lines: 200
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+Persistence.swift"
      provides: "UserDefaults persistence for anchors, sample IDs, dates"
      max_lines: 250
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+WorkoutProcessing.swift"
      provides: "Workout sample processing with heart rate enrichment"
      max_lines: 200
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+SleepProcessing.swift"
      provides: "Sleep sample aggregation and daily sleep events"
      max_lines: 300
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+DailyAggregates.swift"
      provides: "Steps and active energy daily aggregation"
      max_lines: 300
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift"
      provides: "Mindfulness and water sample processing"
      max_lines: 150
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+EventFactory.swift"
      provides: "Event creation, duplicate checking, EventType management"
      max_lines: 300
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+Debug.swift"
      provides: "Debug queries, simulation, cache clearing"
      max_lines: 400
    - path: "apps/ios/trendy/Services/HealthKit/HKWorkoutActivityType+Name.swift"
      provides: "HKWorkoutActivityType extension for workout names"
      max_lines: 150
  key_links:
    - from: "HealthKitService.swift"
      to: "All extension files"
      via: "Internal access modifiers"
      pattern: "internal (var|let|func)"
    - from: "Extension files"
      to: "HealthKitService properties"
      via: "Access to internal properties"
      pattern: "self\\.(healthStore|modelContext|eventStore)"
---

<objective>
Split HealthKitService.swift (2,313 lines) into focused extension files organized by responsibility.

Purpose: Satisfy CODE-01 requirement by decomposing the monolithic service into modules <400 lines each, improving maintainability and testability.

Output: 11 files in apps/ios/trendy/Services/HealthKit/ directory, each handling a single concern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-code-quality/04-RESEARCH.md
@apps/ios/trendy/Services/HealthKitService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HealthKit directory and main coordinator file</name>
  <files>
    apps/ios/trendy/Services/HealthKit/HealthKitService.swift
  </files>
  <action>
Create the apps/ios/trendy/Services/HealthKit/ directory structure.

Create HealthKitService.swift containing ONLY:
1. File header and imports (Foundation, HealthKit, SwiftData, Observation)
2. The @Observable class declaration and MARK: - Properties section (lines ~15-135 of original)
3. Static properties: appGroupIdentifier, isUsingAppGroup, sharedDefaults, migrationCompletedKey
4. Instance properties: healthStore, modelContext, eventStore, notificationManager
5. Authorization tracking: authorizationRequestedKey, authorizationRequestedInDefaults, authorizationRequested, hasEnabledCategories, isAuthorized, isHealthKitAvailable
6. Refresh state: isRefreshingDailyAggregates, isRefreshing, refreshingCategories
7. Query/processing state: observerQueries, processedSampleIds, lastStepDate, lastSleepDate, lastActiveEnergyDate, queryAnchors, lastUpdateTimes
8. Constants: all key strings and maxProcessedSampleIds
9. Static dateOnlyFormatter
10. MARK: - Initialization section with init() method (lines ~156-187)

Change ALL `private` properties that need to be accessed by extensions to `internal`:
- healthStore, modelContext, eventStore, notificationManager
- observerQueries, processedSampleIds, queryAnchors, lastUpdateTimes
- lastStepDate, lastSleepDate, lastActiveEnergyDate
- All key string constants

Keep `private static` for truly private static properties.
Keep `private(set)` pattern but change `private` to `internal` for the setter.

Do NOT include any methods beyond init(). All methods go to extension files.
  </action>
  <verify>
File exists at apps/ios/trendy/Services/HealthKit/HealthKitService.swift with <250 lines.
File contains class declaration, all properties, and init() only.
  </verify>
  <done>Main coordinator file exists with properties and initialization, all properties that extensions need are marked internal.</done>
</task>

<task type="auto">
  <name>Task 2: Create authorization and query management extensions</name>
  <files>
    apps/ios/trendy/Services/HealthKit/HealthKitService+Authorization.swift
    apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift
  </files>
  <action>
**HealthKitService+Authorization.swift** (~100 lines):
Imports: Foundation, HealthKit

Move these methods from original file:
- MARK: - Authorization section (lines ~276-324)
- requestAuthorization() async throws
- hasHealthKitAuthorization computed property
- resetAuthorizationState()
- requestAuthorizationForCategory(_:) async throws (private -> internal)
- shouldRequestAuthorization(for:) async (private -> internal)

**HealthKitService+QueryManagement.swift** (~150 lines):
Imports: Foundation, HealthKit

Move these methods from original file:
- MARK: - Monitoring Management section (lines ~325-495)
- startMonitoringAllConfigurations()
- startMonitoring(category:)
- startObserverQuery(for:sampleType:) async (private -> internal)
- stopMonitoring(category:)
- stopMonitoringAll()
- refreshMonitoring()
- MARK: - Background Delivery section (lines ~497-515)
- enableBackgroundDelivery(for:) async throws (private -> internal)

Both files need their own imports at the top.
Change `private` to `internal` on methods that other extensions call.
  </action>
  <verify>
Both files exist and compile.
HealthKitService+Authorization.swift < 150 lines.
HealthKitService+QueryManagement.swift < 200 lines.
  </verify>
  <done>Authorization and query management concerns extracted to focused extension files.</done>
</task>

<task type="auto">
  <name>Task 3: Create processing extensions (Workout, Sleep, DailyAggregates, Category)</name>
  <files>
    apps/ios/trendy/Services/HealthKit/HealthKitService+WorkoutProcessing.swift
    apps/ios/trendy/Services/HealthKit/HealthKitService+SleepProcessing.swift
    apps/ios/trendy/Services/HealthKit/HealthKitService+DailyAggregates.swift
    apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift
  </files>
  <action>
**HealthKitService+WorkoutProcessing.swift** (~150 lines):
Imports: Foundation, HealthKit, SwiftData

Move from original:
- MARK: - Workout Processing section (lines ~618-750)
- processWorkoutSample(_:isBulkImport:) async (private -> internal)
- fetchHeartRateStats(for:) async (private -> internal)

**HealthKitService+SleepProcessing.swift** (~250 lines):
Imports: Foundation, HealthKit, SwiftData

Move from original:
- MARK: - Sleep Processing section (lines ~752-985)
- processSleepSample(_:isBulkImport:) async (private -> internal)
- aggregateDailySleep(isBulkImport:) async (private -> internal)

**HealthKitService+DailyAggregates.swift** (~250 lines):
Imports: Foundation, HealthKit, SwiftData

Move from original:
- MARK: - Steps Processing section (lines ~987-1102)
- aggregateDailySteps(isBulkImport:) async (private -> internal)
- MARK: - Active Energy Processing section (lines ~1104-1227)
- processActiveEnergySample(_:isBulkImport:) async (private -> internal)
- aggregateDailyActiveEnergy(isBulkImport:) async (private -> internal)

**HealthKitService+CategoryProcessing.swift** (~100 lines):
Imports: Foundation, HealthKit, SwiftData

Move from original:
- MARK: - Mindfulness Processing section (lines ~1229-1275)
- processMindfulnessSample(_:isBulkImport:) async (private -> internal)
- MARK: - Water Processing section (lines ~1277-1325)
- processWaterSample(_:isBulkImport:) async (private -> internal)
- MARK: - Sample Processing (lines ~517-616)
- handleNewSamples(for:) async (private -> internal)
- processSample(_:category:isBulkImport:) async (private -> internal)

All methods change from private to internal since they're called from other extensions.
  </action>
  <verify>
All four files exist and each is under 300 lines.
Methods are marked @MainActor where they modify observable state.
  </verify>
  <done>All sample processing logic extracted into focused files by data type.</done>
</task>

<task type="auto">
  <name>Task 4: Create EventFactory, Persistence, Debug, and HKWorkoutActivityType extensions</name>
  <files>
    apps/ios/trendy/Services/HealthKit/HealthKitService+EventFactory.swift
    apps/ios/trendy/Services/HealthKit/HealthKitService+Persistence.swift
    apps/ios/trendy/Services/HealthKit/HealthKitService+Debug.swift
    apps/ios/trendy/Services/HealthKit/HKWorkoutActivityType+Name.swift
  </files>
  <action>
**HealthKitService+EventFactory.swift** (~250 lines):
Imports: Foundation, HealthKit, SwiftData

Move from original:
- MARK: - Event Creation section (lines ~1327-1381)
- createEvent(...) async throws (private -> internal)
- eventExistsWithHealthKitSampleId(_:) async (private -> internal)
- eventExistsWithMatchingWorkoutTimestamp(...) async (private -> internal)
- findEventByHealthKitSampleId(_:) async (private -> internal)
- updateHealthKitEvent(_:properties:notes:isAllDay:) async throws (private -> internal)
- MARK: - Auto-Create EventType section (lines ~1493-1555)
- ensureEventType(for:) async (private -> internal)
- MARK: - Notifications section (lines ~1557-1570)
- sendNotificationIfEnabled(for:eventTypeName:details:) async (private -> internal)

**HealthKitService+Persistence.swift** (~200 lines):
Imports: Foundation, HealthKit

Move from original:
- MARK: - Migration section (lines ~233-274)
- verifyAppGroupSetup() (private -> internal)
- migrateFromStandardUserDefaults() (private -> internal)
- logCurrentState() (private -> internal, #if DEBUG)
- MARK: - Persistence section (lines ~1572-1635)
- markSampleAsProcessed(_:) (private -> internal)
- loadProcessedSampleIds() (private -> internal)
- saveProcessedSampleIds() (private -> internal)
- loadLastStepDate(), saveLastStepDate() (private -> internal)
- loadLastSleepDate(), saveLastSleepDate() (private -> internal)
- loadLastActiveEnergyDate(), saveLastActiveEnergyDate() (private -> internal)
- MARK: - Anchor Persistence section (lines ~1637-1701)
- saveAnchor(_:for:), loadAnchor(for:), clearAnchor(for:), clearAllAnchors(), loadAllAnchors()
- MARK: - Update Time Tracking section (lines ~1703-1737)
- recordCategoryUpdate(for:), loadAllUpdateTimes(), lastUpdateTime(for:), clearUpdateTime(for:)

**HealthKitService+Debug.swift** (~350 lines):
Imports: Foundation, HealthKit, SwiftData

Move from original:
- MARK: - Debug Properties section (lines ~1739-1768)
- All debug computed properties
- MARK: - Debug queries section (lines ~1770-1960)
- debugQueryStepData(), debugQueryActiveEnergyData(), debugQueryWorkoutData(), debugQuerySleepData()
- Force check methods (lines ~1962-2037)
- forceSleepCheck(), forceStepsCheck(), forceActiveEnergyCheck()
- refreshDailyAggregates()
- forceRefreshAllCategories()
- Cache clearing methods (lines ~2110-2151)
- clearSleepCache(), clearStepsCache(), clearActiveEnergyCache(), refreshAllObservers()
- MARK: - Debug/Testing Simulation section (lines ~2153-2220)
- simulateWorkoutDetection(), simulateSleepDetection() (#if DEBUG || STAGING)

**HKWorkoutActivityType+Name.swift** (~100 lines):
Imports: Foundation, HealthKit

Move from original:
- MARK: - HKWorkoutActivityType Extension section (lines ~2224-2313)
- The entire HKWorkoutActivityType extension with the name computed property

This is NOT a HealthKitService extension - it's a standalone HKWorkoutActivityType extension.
  </action>
  <verify>
All four files exist.
HealthKitService+EventFactory.swift < 300 lines.
HealthKitService+Persistence.swift < 250 lines.
HealthKitService+Debug.swift < 400 lines.
HKWorkoutActivityType+Name.swift < 150 lines.
  </verify>
  <done>Event factory, persistence, debug utilities, and workout type extension extracted.</done>
</task>

<task type="auto">
  <name>Task 5: Remove original file and verify build</name>
  <files>
    apps/ios/trendy/Services/HealthKitService.swift
  </files>
  <action>
1. Delete the original apps/ios/trendy/Services/HealthKitService.swift file (now replaced by files in HealthKit/ subdirectory).

2. Run the build to verify everything compiles:
   ```
   cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | head -100
   ```

3. If there are compilation errors:
   - Fix missing imports in extension files
   - Fix access control issues (private -> internal)
   - Fix any missing @MainActor annotations

4. Count lines in each new file to verify all are under 400 lines:
   ```
   wc -l apps/ios/trendy/Services/HealthKit/*.swift
   ```
  </action>
  <verify>
Build succeeds with exit code 0.
Original HealthKitService.swift is deleted.
All files in HealthKit/ are under 400 lines.
Total line count across all files is approximately same as original (some increase due to imports is acceptable).
  </verify>
  <done>HealthKitService decomposition complete - 11 focused files, all under 400 lines, build passes.</done>
</task>

</tasks>

<verification>
After all tasks:
1. Build succeeds: `xcodebuild -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build`
2. No file exceeds 400 lines: `wc -l apps/ios/trendy/Services/HealthKit/*.swift`
3. Original file removed: `ls apps/ios/trendy/Services/HealthKitService.swift` returns "No such file"
4. All extension files have correct imports and compile independently
</verification>

<success_criteria>
- CODE-01 requirement satisfied: HealthKitService split into focused modules
- Each file handles at most 2 responsibilities
- No file exceeds 400 lines
- Build passes with no errors
- All existing functionality preserved (no behavioral changes)
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-quality/04-01-SUMMARY.md`
</output>
