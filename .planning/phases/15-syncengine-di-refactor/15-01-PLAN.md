---
phase: 15-syncengine-di-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/Sync/SyncEngine.swift
  - apps/ios/trendy/ViewModels/EventStore.swift
autonomous: true

must_haves:
  truths:
    - "SyncEngine can be unit tested with mock dependencies"
    - "Production app builds and runs with DI architecture"
    - "EventStore creates SyncEngine with DefaultDataStoreFactory"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncEngine.swift"
      provides: "Protocol-based dependency injection"
      contains: "networkClient: any NetworkClientProtocol"
    - path: "apps/ios/trendy/ViewModels/EventStore.swift"
      provides: "SyncEngine creation with factory"
      contains: "DefaultDataStoreFactory"
  key_links:
    - from: "SyncEngine.init"
      to: "NetworkClientProtocol"
      via: "stored property"
      pattern: "private let networkClient: any NetworkClientProtocol"
    - from: "SyncEngine.init"
      to: "DataStoreFactory"
      via: "stored property"
      pattern: "private let dataStoreFactory: any DataStoreFactory"
    - from: "EventStore.setModelContext"
      to: "SyncEngine.init"
      via: "protocol dependencies"
      pattern: "SyncEngine\\(\\s*networkClient:"
---

<objective>
Refactor SyncEngine to accept protocol-based dependencies via constructor injection

Purpose: Complete the DI infrastructure from Phases 13-14 by wiring protocols into SyncEngine. This enables unit testing in Phase 16 by allowing mock implementations to be injected.

Output: SyncEngine accepts NetworkClientProtocol and DataStoreFactory at init, uses them internally, and EventStore creates SyncEngine with production implementations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-syncengine-di-refactor/15-CONTEXT.md
@.planning/phases/15-syncengine-di-refactor/15-RESEARCH.md
@apps/ios/trendy/Protocols/NetworkClientProtocol.swift
@apps/ios/trendy/Protocols/DataStoreProtocol.swift
@apps/ios/trendy/Protocols/DataStoreFactory.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SyncEngine init and stored properties</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Modify the SyncEngine actor to use protocol-based dependencies:

1. **Replace stored properties** (around lines 51-54):
   - Change `private let apiClient: APIClient` to `private let networkClient: any NetworkClientProtocol`
   - Change `private let modelContainer: ModelContainer` to `private let dataStoreFactory: any DataStoreFactory`
   - Keep `syncHistoryStore: SyncHistoryStore?` unchanged (not protocol-based per RESEARCH.md)

2. **Update init signature** (around line 110):
   - Change from: `init(apiClient: APIClient, modelContainer: ModelContainer, syncHistoryStore: SyncHistoryStore? = nil)`
   - Change to: `init(networkClient: any NetworkClientProtocol, dataStoreFactory: any DataStoreFactory, syncHistoryStore: SyncHistoryStore? = nil)`

3. **Update init body**:
   - Change `self.apiClient = apiClient` to `self.networkClient = networkClient`
   - Change `self.modelContainer = modelContainer` to `self.dataStoreFactory = dataStoreFactory`
   - Keep cursor loading and logging unchanged

4. **Remove import SwiftData if no longer needed** (check after Task 2 if ModelContainer references remain)
  </action>
  <verify>
File compiles with updated init signature:
```bash
cd /Users/cipher/Repositories/trendy/apps/ios && swift build --target trendy 2>&1 | head -50
```
Expected: Compiler errors about missing `apiClient` and `modelContainer` references (expected - fixed in Task 2)
  </verify>
  <done>SyncEngine.init accepts protocol-based dependencies; stored properties use protocol types</done>
</task>

<task type="auto">
  <name>Task 2: Replace all internal concrete usages</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Replace all concrete type usages inside SyncEngine with protocol-based equivalents.

**PART A: Network client replacements (20+ sites)**

Use systematic find-replace with verification after each category:

1. **Geofence calls (IMPORTANT: signature change required)**
   - `apiClient.getGeofences()` -> `networkClient.getGeofences(activeOnly: false)`
   - Lines 487 and 1658 call `getGeofences()` without parameter
   - NetworkClientProtocol requires `getGeofences(activeOnly: Bool)` - must add explicit parameter

2. **Event calls**
   - `apiClient.getAllEvents()` -> `networkClient.getAllEvents(batchSize: 50)` (add explicit parameter)
   - `apiClient.createEventsBatch(_:)` -> `networkClient.createEventsBatch(_:)`
   - `apiClient.createEventWithIdempotency(_:idempotencyKey:)` -> `networkClient.createEventWithIdempotency(_:idempotencyKey:)`
   - `apiClient.updateEvent(id:_:)` -> `networkClient.updateEvent(id:_:)`
   - `apiClient.deleteEvent(id:)` -> `networkClient.deleteEvent(id:)`

3. **EventType calls**
   - `apiClient.getEventTypes()` -> `networkClient.getEventTypes()`
   - `apiClient.createEventTypeWithIdempotency(_:idempotencyKey:)` -> `networkClient.createEventTypeWithIdempotency(_:idempotencyKey:)`
   - `apiClient.updateEventType(id:_:)` -> `networkClient.updateEventType(id:_:)`
   - `apiClient.deleteEventType(id:)` -> `networkClient.deleteEventType(id:)`

4. **Geofence CRUD calls**
   - `apiClient.createGeofenceWithIdempotency(_:idempotencyKey:)` -> `networkClient.createGeofenceWithIdempotency(_:idempotencyKey:)`
   - `apiClient.updateGeofence(id:_:)` -> `networkClient.updateGeofence(id:_:)`
   - `apiClient.deleteGeofence(id:)` -> `networkClient.deleteGeofence(id:)`

5. **PropertyDefinition calls**
   - `apiClient.getPropertyDefinitions(eventTypeId:)` -> `networkClient.getPropertyDefinitions(eventTypeId:)`
   - `apiClient.createPropertyDefinitionWithIdempotency(_:idempotencyKey:)` -> `networkClient.createPropertyDefinitionWithIdempotency(_:idempotencyKey:)`
   - `apiClient.updatePropertyDefinition(id:_:)` -> `networkClient.updatePropertyDefinition(id:_:)`
   - `apiClient.deletePropertyDefinition(id:)` -> `networkClient.deletePropertyDefinition(id:)`

6. **Change feed calls**
   - `apiClient.getChanges(since:limit:)` -> `networkClient.getChanges(since:limit:)`
   - `apiClient.getLatestCursor()` -> `networkClient.getLatestCursor()`

**Verify Part A:**
```bash
grep -c "apiClient\." trendy/Services/Sync/SyncEngine.swift
# Should be 0
```

**PART B: DataStore factory replacements (13+ sites)**

Replace every pattern of `ModelContext(modelContainer)` + `LocalStore(modelContext:)` with `dataStoreFactory.makeDataStore()`:

Example transformation:
```swift
// BEFORE:
let context = ModelContext(modelContainer)
let localStore = LocalStore(modelContext: context)

// AFTER:
let dataStore = dataStoreFactory.makeDataStore()
```

Then replace all `localStore.` calls with `dataStore.` for that scope.

**Note on naming:** Use `dataStore` (not `localStore`) for the variable name to indicate it's protocol-typed.

**Verify Part B:**
```bash
grep -c "LocalStore(" trendy/Services/Sync/SyncEngine.swift
# Should be 0
grep -c "ModelContext(modelContainer)" trendy/Services/Sync/SyncEngine.swift
# Should be 0
```
  </action>
  <verify>
```bash
cd /Users/cipher/Repositories/trendy/apps/ios

# Verify no concrete references remain
echo "=== Part A: Network client verification ==="
grep -n "apiClient\." trendy/Services/Sync/SyncEngine.swift && echo "FAIL: apiClient references found" || echo "PASS: No apiClient references"

echo ""
echo "=== Part B: DataStore verification ==="
grep -n "LocalStore(" trendy/Services/Sync/SyncEngine.swift && echo "FAIL: LocalStore references found" || echo "PASS: No LocalStore references"
grep -n "ModelContext(modelContainer)" trendy/Services/Sync/SyncEngine.swift && echo "FAIL: ModelContext references found" || echo "PASS: No ModelContext references"

echo ""
echo "=== Verify protocol types in use ==="
grep -c "networkClient\." trendy/Services/Sync/SyncEngine.swift
grep -c "dataStore\." trendy/Services/Sync/SyncEngine.swift || grep -c "dataStoreFactory\." trendy/Services/Sync/SyncEngine.swift
```
  </verify>
  <done>All internal SyncEngine code uses networkClient (protocol) and dataStoreFactory.makeDataStore() (protocol factory pattern)</done>
</task>

<task type="auto">
  <name>Task 3: Update EventStore and verify build</name>
  <files>apps/ios/trendy/ViewModels/EventStore.swift</files>
  <action>
Update EventStore to create SyncEngine with protocol-based dependencies:

**Modify setModelContext method** (around line 332-344):
```swift
// BEFORE:
if let apiClient = apiClient {
    self.syncEngine = SyncEngine(
        apiClient: apiClient,
        modelContainer: context.container,
        syncHistoryStore: syncHistoryStore
    )
}

// AFTER:
if let apiClient = apiClient {
    let dataStoreFactory = DefaultDataStoreFactory(modelContainer: context.container)
    self.syncEngine = SyncEngine(
        networkClient: apiClient,
        dataStoreFactory: dataStoreFactory,
        syncHistoryStore: syncHistoryStore
    )
}
```

**Why this works:**
- `apiClient` already conforms to `NetworkClientProtocol` (Phase 14)
- `DefaultDataStoreFactory` conforms to `DataStoreFactory` (Phase 13)
- Compiler implicitly converts concrete types to protocol existentials

**Build verification:**
Run full iOS build to confirm no compile errors.
  </action>
  <verify>
```bash
cd /Users/cipher/Repositories/trendy/apps/ios

# Verify key_link: SyncEngine created with protocol parameter names
echo "=== Verify SyncEngine init call uses protocol parameter names ==="
grep -n "SyncEngine(" trendy/ViewModels/EventStore.swift
grep -E "SyncEngine\(\s*networkClient:" trendy/ViewModels/EventStore.swift && echo "PASS: SyncEngine uses networkClient parameter" || echo "FAIL: SyncEngine not using networkClient parameter"

# Verify DefaultDataStoreFactory is used
echo ""
echo "=== Verify DefaultDataStoreFactory usage ==="
grep -n "DefaultDataStoreFactory" trendy/ViewModels/EventStore.swift

# Attempt to build (may have FullDisclosureSDK issue per STATE.md but protocol changes should compile)
echo ""
echo "=== Build verification ==="
xcodebuild -scheme "trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | tail -30
```

If FullDisclosureSDK blocks build, verify with manual syntax check:
```bash
# Check EventStore compiles with new syntax
swiftc -parse -sdk $(xcrun --sdk iphonesimulator --show-sdk-path) trendy/ViewModels/EventStore.swift 2>&1 | head -20
```
  </verify>
  <done>EventStore creates SyncEngine with DefaultDataStoreFactory; key_link pattern "SyncEngine(\s*networkClient:" present; production build compiles</done>
</task>

</tasks>

<verification>
**After all tasks:**

1. **No concrete type references in SyncEngine:**
```bash
cd /Users/cipher/Repositories/trendy/apps/ios
echo "=== Checking for concrete APIClient usage ==="
grep -c "private let apiClient:" trendy/Services/Sync/SyncEngine.swift || true
echo "=== Checking for concrete ModelContainer usage ==="
grep -c "private let modelContainer:" trendy/Services/Sync/SyncEngine.swift || true
echo "=== Checking for protocol usage ==="
grep -c "private let networkClient: any NetworkClientProtocol" trendy/Services/Sync/SyncEngine.swift
grep -c "private let dataStoreFactory: any DataStoreFactory" trendy/Services/Sync/SyncEngine.swift
```

2. **EventStore uses factory pattern and correct parameter names:**
```bash
grep -c "DefaultDataStoreFactory" trendy/ViewModels/EventStore.swift
grep -E "SyncEngine\(\s*networkClient:" trendy/ViewModels/EventStore.swift
```

3. **Build verification (best effort given FullDisclosureSDK blocker):**
```bash
xcodebuild -scheme "trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16" build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)" | head -10
```
</verification>

<success_criteria>
- [ ] SyncEngine.init accepts `networkClient: any NetworkClientProtocol` and `dataStoreFactory: any DataStoreFactory`
- [ ] Zero `apiClient.` references inside SyncEngine.swift
- [ ] Zero `LocalStore(` references inside SyncEngine.swift
- [ ] Zero `ModelContext(modelContainer)` references inside SyncEngine.swift
- [ ] EventStore creates `DefaultDataStoreFactory` and passes to SyncEngine
- [ ] EventStore SyncEngine init uses `networkClient:` parameter name (key_link verified)
- [ ] iOS build compiles (or only fails on unrelated FullDisclosureSDK issue)
- [ ] Requirement TEST-06 satisfied: "SyncEngine accepts protocol-based dependencies via init"
</success_criteria>

<output>
After completion, create `.planning/phases/15-syncengine-di-refactor/15-01-SUMMARY.md`
</output>
