---
phase: 12-foundation-cleanup
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "HealthKit observer query completion handlers call completionHandler() in all code paths"
    - "Verification documented in phase summary"
  note: >
    Research (12-RESEARCH.md lines 251-283) confirms completion handlers are already correctly implemented.
    This plan documents the audit to satisfy QUAL-02 requirement.
  artifacts:
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift"
      provides: "HealthKit observer queries with correct completion handler calls"
      contains: "completionHandler()"
  key_links:
    - from: "HealthKitService+QueryManagement.swift"
      to: "HKObserverQuery closure"
      via: "completionHandler() called in guard, error, and success paths"
      pattern: "completionHandler\\(\\)"
---

<objective>
Document verification of HealthKit completion handler correctness (QUAL-02)

Purpose: Satisfy requirement QUAL-02 by auditing and documenting that all HealthKit observer query handlers call completionHandler() in every code path. Research has already confirmed this is correctly implemented - this plan creates the formal verification record.

Output: Documented verification that completion handlers are correctly called in all paths
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-foundation-cleanup/12-CONTEXT.md
@.planning/phases/12-foundation-cleanup/12-RESEARCH.md
@apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit HealthKit observer query completion handlers</name>
  <files>apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift</files>
  <action>
Read HealthKitService+QueryManagement.swift and verify all HKObserverQuery closures call completionHandler() in every code path:

1. Locate all HKObserverQuery initializations (expect 1 at lines ~73-97)
2. For each observer query closure, trace all exit paths:
   - Guard failure paths (e.g., `guard let self = self else { ... }`)
   - Error handling paths (e.g., `if let error = error { ... }`)
   - Success paths (normal execution flow)
3. Verify completionHandler() is called in EACH path
4. Document findings

**Expected findings per research:**
- Lines 73-97 contain the observer query
- Guard failure (self is nil): calls completionHandler() at line ~57-59
- Error case: calls completionHandler() at line ~64-66
- Success case: calls completionHandler() at line ~73

**If any path is missing completionHandler():**
- Add the missing call
- Log the fix

**If all paths are correct (expected):**
- Document verification
- No code changes needed
  </action>
  <verify>
1. `grep -c "completionHandler()" apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift` returns >= 3
2. Manual inspection confirms all code paths call completionHandler()
  </verify>
  <done>All HKObserverQuery closures verified to call completionHandler() in every code path (guard failure, error, success)</done>
</task>

</tasks>

<verification>
After task complete:

1. Verify completionHandler calls exist:
```bash
grep -n "completionHandler()" apps/ios/trendy/Services/HealthKit/HealthKitService+QueryManagement.swift
```

2. Count should be >= 3 (one per exit path in the observer query closure)

3. Visual inspection of HKObserverQuery closure confirms:
   - Guard failure calls completionHandler()
   - Error path calls completionHandler()
   - Success path calls completionHandler()
</verification>

<success_criteria>
- [ ] HKObserverQuery closure at lines ~73-97 audited
- [ ] Guard failure path calls completionHandler() - VERIFIED
- [ ] Error handling path calls completionHandler() - VERIFIED
- [ ] Success path calls completionHandler() - VERIFIED
- [ ] Verification documented in SUMMARY
</success_criteria>

<output>
After completion, create `.planning/phases/12-foundation-cleanup/12-05-SUMMARY.md`

The summary should document:
1. Which file was audited
2. Which code paths were verified
3. Confirmation that QUAL-02 is satisfied (all paths call completionHandler)
</output>
