---
phase: 07-ux-indicators
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - apps/ios/trendy/Views/Components/SyncIndicator/SyncErrorView.swift
  - apps/ios/trendy/ViewModels/SyncStatusViewModel.swift
autonomous: true

must_haves:
  truths:
    - "Sync errors persist until dismissed or resolved"
    - "Errors show user-friendly message with technical details on tap"
    - "Auth errors (401/403) prompt user to re-login"
    - "Error visibility escalates after 3+ consecutive failures"
  artifacts:
    - path: "apps/ios/trendy/Views/Components/SyncIndicator/SyncErrorView.swift"
      provides: "Error display with tap-to-expand and retry"
      min_lines: 80
    - path: "apps/ios/trendy/ViewModels/SyncStatusViewModel.swift"
      provides: "Enhanced with error persistence and escalation tracking"
      contains: "failureCount"
  key_links:
    - from: "SyncErrorView"
      to: "SyncStatusViewModel"
      via: "error state binding"
      pattern: "displayState.*error"
    - from: "SyncStatusViewModel"
      to: "error escalation"
      via: "failureCount threshold"
      pattern: "failureCount >= 3"
---

<objective>
Enhance error handling with persistence, tap-to-expand, and escalation

Purpose: Satisfy UX-03 (sync errors surfaced with tappable explanation). Errors should not silently disappear - users need to know what went wrong and how to fix it.

Output: SyncErrorView (tap-to-expand error display), enhanced SyncStatusViewModel (error persistence and escalation)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ux-indicators/07-CONTEXT.md
@.planning/phases/07-ux-indicators/07-RESEARCH.md
@apps/ios/trendy/ViewModels/SyncStatusViewModel.swift (created in 07-01)
@apps/ios/trendy/DesignSystem/Colors.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncErrorView with tap-to-expand</name>
  <files>apps/ios/trendy/Views/Components/SyncIndicator/SyncErrorView.swift</files>
  <action>
Create error display component with expandable details:

**Parameters:**
- `userMessage: String` (friendly message like "Sync failed")
- `technicalDetails: String?` (raw error message for debugging)
- `isAuthError: Bool` (true for 401/403 - changes action button)
- `isEscalated: Bool` (true when 3+ failures - changes visual prominence)
- `onRetry: () async -> Void`
- `onReLogin: () -> Void` (for auth errors)
- `onDismiss: () -> Void`

**State:**
- @State showDetails = false
- @Environment(\.accessibilityReduceMotion) reduceMotion

**Layout:**
- VStack(alignment: .leading, spacing: 8)
- Top HStack:
  - exclamationmark.triangle.fill icon (Color.dsDestructive)
  - Text(userMessage) with .subheadline.weight(.medium)
  - Spacer
  - If isAuthError: "Sign In" button -> onReLogin
  - Else: "Retry" button -> Task { await onRetry() }
  - "X" dismiss button -> onDismiss
- If showDetails && technicalDetails != nil:
  - Text(technicalDetails) in .caption, Color.dsMutedForeground, padded top 4
- Padding 16 all around
- Background: Color.dsDestructive.opacity(isEscalated ? 0.2 : 0.1)
- Corner radius 12
- If isEscalated: add red border (Color.dsDestructive, lineWidth 1)

**Animation:**
- onTapGesture toggles showDetails with spring animation (unless reduceMotion)

**Error Message Classification (static helper):**
- `static func classifyError(_ message: String) -> (userMessage: String, isAuthError: Bool)`
- Contains "401" or "unauthorized" or "session expired" -> ("Session expired, sign in again", true)
- Contains "403" or "forbidden" -> ("Access denied, sign in again", true)
- Contains "network" or "connection" or "offline" -> ("No connection", false)
- Contains "500" or "server" -> ("Server error, try again later", false)
- Default: ("Sync failed", false)

Include SwiftUI Previews: normal error, auth error, escalated error, with details expanded
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
Previews render for all error variants
  </verify>
  <done>
Error view shows user-friendly message, expands to show details on tap, handles auth errors distinctly, visually escalates after repeated failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance SyncStatusViewModel with error persistence and escalation</name>
  <files>apps/ios/trendy/ViewModels/SyncStatusViewModel.swift</files>
  <action>
Enhance the view model created in 07-01:

**New Properties:**
- `persistedError: (message: String, timestamp: Date)?` - error that stays until dismissed
- `lastErrorWasAuthError: Bool = false` - tracks if last error was auth-related
- `consecutiveFailureCount: Int = 0` - for escalation (not same as failureCount if that exists)
- Computed `isErrorEscalated: Bool { consecutiveFailureCount >= 3 }`

**New Methods:**
- `recordError(message: String)`:
  - Set persistedError = (message, Date())
  - Classify error using SyncErrorView.classifyError to set lastErrorWasAuthError
  - Increment consecutiveFailureCount
- `dismissError()`:
  - Clear persistedError
  - (DO NOT reset consecutiveFailureCount - that resets on success)
- `recordSuccess()`:
  - Clear persistedError
  - Reset consecutiveFailureCount to 0
  - Reset lastErrorWasAuthError to false

**Update displayState computed property:**
- If persistedError != nil, return .error even when syncState is .idle
- This ensures errors persist until user dismisses or sync succeeds

**Update refresh(from:) method:**
- If eventStore.currentSyncState is .error, call recordError with the message
- If eventStore.currentSyncState is .idle and pendingCount == 0 and there was no error, call recordSuccess

Ensure existing properties/methods from 07-01 still work correctly.
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
  </verify>
  <done>
View model persists errors until dismissed, tracks consecutive failures for escalation, classifies auth errors.
  </done>
</task>

</tasks>

<verification>
1. SyncErrorView.swift exists with tap-to-expand behavior
2. SyncErrorView correctly classifies error messages
3. SyncStatusViewModel persists errors until dismissed
4. Escalation visual triggers after 3+ consecutive failures
5. Auth errors show "Sign In" instead of "Retry"
6. Build passes
</verification>

<success_criteria>
- [ ] SyncErrorView shows user-friendly message
- [ ] SyncErrorView expands to show technical details on tap
- [ ] SyncErrorView handles auth errors with Sign In action
- [ ] SyncErrorView shows escalated visual after 3+ failures
- [ ] SyncStatusViewModel persists errors until dismissed
- [ ] SyncStatusViewModel tracks consecutive failures
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-indicators/07-03-SUMMARY.md`
</output>
