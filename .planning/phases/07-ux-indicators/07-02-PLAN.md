---
phase: 07-ux-indicators
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/Sync/SyncHistoryStore.swift
  - apps/ios/trendy/Views/Settings/SyncSettingsView.swift
  - apps/ios/trendy/Views/Components/RelativeTimestampView.swift
autonomous: true

must_haves:
  truths:
    - "User can see last sync timestamp in settings"
    - "Timestamp shows relative format by default, absolute on tap"
    - "Sync history shows last 10 syncs with counts and status"
    - "User can trigger manual sync from settings"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncHistoryStore.swift"
      provides: "Persisted sync history with bounded storage"
      min_lines: 80
    - path: "apps/ios/trendy/Views/Settings/SyncSettingsView.swift"
      provides: "Settings section with sync details and history"
      min_lines: 100
    - path: "apps/ios/trendy/Views/Components/RelativeTimestampView.swift"
      provides: "Relative/absolute timestamp toggle component"
      min_lines: 35
  key_links:
    - from: "SyncHistoryStore"
      to: "UserDefaults"
      via: "JSON encoding/decoding"
      pattern: "UserDefaults.standard.*sync_history"
    - from: "SyncSettingsView"
      to: "SyncHistoryStore"
      via: "@Environment binding"
      pattern: "@Environment.*SyncHistoryStore"
---

<objective>
Create sync settings section with history and timestamps

Purpose: Satisfy UX-02 (last sync timestamp display) and provide detailed sync information in settings. Users can see when data was last synced and review recent sync activity.

Output: SyncHistoryStore (persisted history), SyncSettingsView (settings UI), RelativeTimestampView (reusable timestamp component)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ux-indicators/07-CONTEXT.md
@.planning/phases/07-ux-indicators/07-RESEARCH.md
@apps/ios/trendy/ViewModels/EventStore.swift (for currentLastSyncTime, currentPendingCount)
@apps/ios/trendy/DesignSystem/Colors.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncHistoryStore with bounded storage</name>
  <files>apps/ios/trendy/Services/Sync/SyncHistoryStore.swift</files>
  <action>
Create persistent sync history store:

**SyncHistoryEntry struct (Codable, Identifiable):**
- `id: UUID`
- `timestamp: Date`
- `eventsCount: Int`
- `eventTypesCount: Int`
- `status: Status` (enum: success, partialSuccess, failed)
- `errorMessage: String?`
- `durationMs: Int`
- Computed `summary: String` that formats counts (e.g., "3 events, 2 event types")

**SyncHistoryStore (@Observable class):**
- Private constants: `storageKey = "sync_history"`, `maxEntries = 10`
- Property: `entries: [SyncHistoryEntry]` (private set)
- Init: load from UserDefaults via `loadFromStorage()`
- Method: `record(_ entry: SyncHistoryEntry)` - insert at index 0, prune to maxEntries, save
- Method: `recordSuccess(events: Int, eventTypes: Int, durationMs: Int)` - convenience
- Method: `recordFailure(errorMessage: String, durationMs: Int)` - convenience
- Private: `loadFromStorage()` - JSONDecoder from UserDefaults data
- Private: `saveToStorage()` - JSONEncoder to UserDefaults

Include proper error handling - if decode fails, start with empty array (don't crash).
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
  </verify>
  <done>
Sync history persists across app launches with automatic pruning to 10 entries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RelativeTimestampView component</name>
  <files>apps/ios/trendy/Views/Components/RelativeTimestampView.swift</files>
  <action>
Create reusable timestamp component with tap-to-toggle:

- Parameters: `date: Date`, optional `font: Font = .caption`, optional `color: Color = .dsMutedForeground`
- @State `showAbsolute = false`
- Static formatters (computed once, not in body):
  - `relativeFormatter: RelativeDateTimeFormatter` with `.abbreviated` style
  - `absoluteFormatter: DateFormatter` with timeStyle .short, dateStyle .none

**Body:**
- Text showing either relative ("5 min ago") or absolute ("3:42 PM")
- Apply font and foregroundStyle from parameters
- onTapGesture to toggle showAbsolute
- Add subtle scale animation on tap (0.95 -> 1.0) unless reduceMotion

Include SwiftUI Preview with Date().addingTimeInterval(-300) (5 min ago)
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
  </verify>
  <done>
Timestamp component shows relative time, switches to absolute on tap, properly reuses formatters.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SyncSettingsView</name>
  <files>apps/ios/trendy/Views/Settings/SyncSettingsView.swift</files>
  <action>
Create sync settings section view:

- Get EventStore from @Environment for sync state and manual sync trigger
- Get SyncHistoryStore from @Environment (will be wired in later plan)
- @State for isRetrying (disable button during sync)

**Layout (Form or List with sections):**

**Section 1: "Sync Status"**
- Row: "Status" with current state text (Online/Offline/Syncing)
- Row: "Pending Changes" with currentPendingCount
- Row: "Last Synced" with RelativeTimestampView if currentLastSyncTime exists, else "Never"
- Button: "Sync Now" (disabled when syncing or offline or isRetrying)
  - Action: set isRetrying true, call eventStore.fetchData(), set isRetrying false

**Section 2: "Sync History"**
- If history.entries is empty: "No sync history yet" text
- ForEach over history.entries (limit to 10, already enforced by store):
  - Row showing: RelativeTimestampView(entry.timestamp) + entry.summary
  - If entry.status == .failed: show SF Symbol exclamationmark.triangle in red
  - If entry.errorMessage exists: show as secondary text on tap

Use design system colors (Color.dsDestructive for failed entries, Color.dsMutedForeground for secondary text).

Include SwiftUI Preview with mock history entries.
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
Preview renders with sections
  </verify>
  <done>
Settings section shows sync status, last sync time with tap-to-absolute, pending count, Sync Now button, and sync history.
  </done>
</task>

</tasks>

<verification>
1. All 3 new files exist in expected locations
2. Build succeeds with `just build-ios`
3. SyncHistoryStore saves/loads from UserDefaults correctly
4. RelativeTimestampView toggles between relative and absolute formats
5. SyncSettingsView shows all specified sections and rows
6. Sync Now button calls eventStore.fetchData()
</verification>

<success_criteria>
- [ ] SyncHistoryStore persists history with 10-entry cap
- [ ] RelativeTimestampView shows relative time, absolute on tap
- [ ] SyncSettingsView displays sync status section
- [ ] SyncSettingsView displays sync history section
- [ ] Sync Now button triggers manual sync
- [ ] Design system colors used throughout
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-indicators/07-02-SUMMARY.md`
</output>
