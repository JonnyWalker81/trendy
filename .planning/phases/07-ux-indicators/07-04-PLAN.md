---
phase: 07-ux-indicators
plan: 04
type: execute
wave: 3
depends_on: [07-01, 07-02, 07-03]
files_modified:
  - apps/ios/trendy/Views/MainTabView.swift
  - apps/ios/trendy/Views/Settings/EventTypeSettingsView.swift
  - apps/ios/trendy/trendyApp.swift
autonomous: false

must_haves:
  truths:
    - "Floating indicator appears at bottom of main content when sync active"
    - "Indicator animates in/out with spring transition"
    - "Sync settings accessible from main settings view"
    - "SyncStatusViewModel and SyncHistoryStore available app-wide via environment"
  artifacts:
    - path: "apps/ios/trendy/Views/MainTabView.swift"
      provides: "Floating indicator integration via safeAreaInset"
      contains: "safeAreaInset"
    - path: "apps/ios/trendy/Views/Settings/EventTypeSettingsView.swift"
      provides: "Navigation link to SyncSettingsView"
      contains: "SyncSettingsView"
    - path: "apps/ios/trendy/trendyApp.swift"
      provides: "Environment injection of SyncStatusViewModel and SyncHistoryStore"
      contains: "SyncStatusViewModel"
  key_links:
    - from: "MainTabView"
      to: "SyncIndicatorView"
      via: "safeAreaInset(edge: .bottom)"
      pattern: "safeAreaInset.*bottom"
    - from: "trendyApp"
      to: "SyncStatusViewModel"
      via: "environment injection"
      pattern: "\\.environment.*SyncStatusViewModel"
---

<objective>
Wire sync indicator and settings into the app

Purpose: Integrate all UX indicator components into the app so users see sync status during normal use. This completes the UX-01, UX-02, UX-03, UX-04 requirements.

Output: MainTabView with floating indicator, EventTypeSettingsView with sync settings link, trendyApp with environment injection
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ux-indicators/07-CONTEXT.md
@apps/ios/trendy/Views/MainTabView.swift
@apps/ios/trendy/Views/Settings/EventTypeSettingsView.swift
@apps/ios/trendy/trendyApp.swift
@apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorView.swift (created in 07-01)
@apps/ios/trendy/Views/Settings/SyncSettingsView.swift (created in 07-02)
@apps/ios/trendy/ViewModels/SyncStatusViewModel.swift (created in 07-01, enhanced in 07-03)
@apps/ios/trendy/Services/Sync/SyncHistoryStore.swift (created in 07-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up environment injection in trendyApp</name>
  <files>apps/ios/trendy/trendyApp.swift</files>
  <action>
Read the current trendyApp.swift and add environment objects:

**Add @State properties:**
- `@State private var syncStatusViewModel = SyncStatusViewModel()`
- `@State private var syncHistoryStore = SyncHistoryStore()`

**Inject into environment:**
Add to the view modifier chain where other environment values are set:
- `.environment(syncStatusViewModel)`
- `.environment(syncHistoryStore)`

These should be injected at the top level so all views can access them.

**Note:** Do NOT change existing environment setup for apiClient, foundationModelService, etc. Just add the new ones.
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
  </verify>
  <done>
SyncStatusViewModel and SyncHistoryStore are available app-wide via @Environment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add floating indicator to MainTabView</name>
  <files>apps/ios/trendy/Views/MainTabView.swift</files>
  <action>
Read the current MainTabView.swift and integrate the floating indicator:

**Add environment access:**
- `@Environment(SyncStatusViewModel.self) private var syncStatusViewModel`
- `@Environment(\.accessibilityReduceMotion) private var reduceMotion`

**Add state for indicator visibility:**
- @State showIndicator = false

**Wrap mainTabContent with safeAreaInset:**
```swift
mainTabContent
    .safeAreaInset(edge: .bottom, spacing: 0) {
        if showIndicator {
            SyncIndicatorView(
                displayState: syncStatusViewModel.displayState,
                onTap: { /* navigate to sync settings or show details */ },
                onRetry: {
                    await eventStore?.fetchData()
                }
            )
            .transition(reduceMotion ? .opacity : .move(edge: .bottom).combined(with: .opacity))
        }
    }
    .animation(reduceMotion ? nil : .spring(response: 0.35, dampingFraction: 0.8), value: showIndicator)
```

**Keep indicator state in sync:**
Add `.onChange(of: syncStatusViewModel.shouldShowIndicator)` to update showIndicator state.

Or use `showIndicator` directly bound to `syncStatusViewModel.shouldShowIndicator`.

**Update sync state when EventStore changes:**
Add a task or onChange that calls `syncStatusViewModel.refresh(from: eventStore)` when sync state changes.

**Handle success auto-hide:**
When displayState becomes .success, start a 2-second timer then set showIndicator = false.

**Note:** Preserve all existing functionality (tab view, initialization, geofence reconciliation, etc.). Only ADD the indicator overlay.
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
  </verify>
  <done>
Floating indicator appears at bottom when sync is active, animates in/out with spring, auto-hides after success.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sync settings link to EventTypeSettingsView</name>
  <files>apps/ios/trendy/Views/Settings/EventTypeSettingsView.swift</files>
  <action>
Read the current EventTypeSettingsView.swift and add navigation to sync settings:

**Add a new section** (likely near the top or after account-related settings):

```swift
Section("Sync") {
    NavigationLink {
        SyncSettingsView()
    } label: {
        HStack {
            Image(systemName: "arrow.triangle.2.circlepath")
            Text("Sync Settings")
        }
    }
}
```

If there's a status row that would fit better inline (showing pending count or last sync time), add that too:
```swift
HStack {
    Text("Last synced")
    Spacer()
    if let lastSync = eventStore?.currentLastSyncTime {
        RelativeTimestampView(date: lastSync)
    } else {
        Text("Never")
            .foregroundStyle(.secondary)
    }
}
```

Ensure EventTypeSettingsView can access EventStore from environment if not already.

**Note:** Preserve all existing settings functionality. Only ADD the sync section.
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
  </verify>
  <done>
Sync settings accessible from main settings view with NavigationLink.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete sync indicator UX - floating pill, settings integration, animations</what-built>
  <how-to-verify>
1. Build and run the app on simulator
2. Log in with a valid account
3. Verify floating indicator behavior:
   - Force offline (airplane mode) -> Should see "Offline - X pending" banner
   - Create an event while offline -> Pending count should increment
   - Go back online -> Should see "Syncing X of Y" with progress
   - After sync completes -> Should see brief "All synced" checkmark, then hide
4. Check settings:
   - Go to Settings tab -> Sync section should be visible
   - Tap "Sync Settings" -> Should show status, last sync time, history
   - Tap on timestamp -> Should toggle between relative and absolute
   - Tap "Sync Now" -> Should trigger sync
5. Test error state:
   - If possible, trigger an error (invalid auth, server down)
   - Error should persist until dismissed
   - Tap error to see technical details
6. Accessibility:
   - Enable "Reduce Motion" in iOS Settings
   - Verify indicator uses opacity transitions instead of slide
  </how-to-verify>
  <resume-signal>Type "approved" when all behaviors work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. App builds successfully
2. Floating indicator appears at bottom of screen during sync
3. Indicator shows correct state (offline/syncing/error/success)
4. Indicator animates with spring transition (opacity-only with reduce motion)
5. Sync settings accessible from settings tab
6. Environment injection works (no crashes accessing SyncStatusViewModel)
</verification>

<success_criteria>
- [ ] trendyApp injects SyncStatusViewModel and SyncHistoryStore
- [ ] MainTabView shows floating indicator via safeAreaInset
- [ ] Indicator animates correctly with accessibility support
- [ ] EventTypeSettingsView links to SyncSettingsView
- [ ] All existing app functionality preserved
- [ ] Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-indicators/07-04-SUMMARY.md`
</output>
