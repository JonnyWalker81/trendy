---
phase: 07-ux-indicators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorView.swift
  - apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorDisplayState.swift
  - apps/ios/trendy/Views/Components/SyncIndicator/SyncProgressBar.swift
  - apps/ios/trendy/ViewModels/SyncStatusViewModel.swift
autonomous: true

must_haves:
  truths:
    - "Floating indicator shows current sync status visually"
    - "Indicator appears only when active (syncing, error, offline)"
    - "Progress shows determinate count when syncing (e.g., 'Syncing 3 of 5')"
    - "Animations respect reduce motion accessibility setting"
  artifacts:
    - path: "apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorView.swift"
      provides: "Floating pill indicator with state-based appearance"
      min_lines: 100
    - path: "apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorDisplayState.swift"
      provides: "Display state machine enum with derived states"
      min_lines: 30
    - path: "apps/ios/trendy/Views/Components/SyncIndicator/SyncProgressBar.swift"
      provides: "Determinate progress bar with count display"
      min_lines: 40
    - path: "apps/ios/trendy/ViewModels/SyncStatusViewModel.swift"
      provides: "Observable sync state for multiple views"
      min_lines: 50
  key_links:
    - from: "SyncIndicatorDisplayState"
      to: "SyncState"
      via: "static func from(syncState:pendingCount:isOnline:)"
      pattern: "static func from.*SyncState"
    - from: "SyncIndicatorView"
      to: "SyncStatusViewModel"
      via: "@Environment binding"
      pattern: "@Environment.*SyncStatusViewModel"
---

<objective>
Create the floating sync indicator with state machine and progress display

Purpose: Establish the core UI components for sync status visibility (UX-01, UX-04). This is the foundation that all other UX indicator work builds upon.

Output: SyncIndicatorView (floating pill), SyncIndicatorDisplayState (state machine), SyncProgressBar (determinate progress), SyncStatusViewModel (shared state)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-ux-indicators/07-CONTEXT.md
@.planning/phases/07-ux-indicators/07-RESEARCH.md
@apps/ios/trendy/Views/Components/SyncStatusBanner.swift
@apps/ios/trendy/Services/Sync/SyncEngine.swift (lines 14-25 for SyncState enum)
@apps/ios/trendy/ViewModels/EventStore.swift (lines 44-61 for cached sync state)
@apps/ios/trendy/DesignSystem/Colors.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncIndicatorDisplayState and SyncStatusViewModel</name>
  <files>
    apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorDisplayState.swift
    apps/ios/trendy/ViewModels/SyncStatusViewModel.swift
  </files>
  <action>
Create the display state machine and view model:

**SyncIndicatorDisplayState.swift:**
- Enum cases: `.hidden`, `.offline(pending: Int)`, `.syncing(current: Int, total: Int)`, `.error(message: String, canRetry: Bool)`, `.success`
- Static `from(syncState: SyncState, pendingCount: Int, isOnline: Bool, failureCount: Int) -> Self` factory method
- Logic: offline + pending -> .offline; syncing state -> .syncing; error state -> .error; idle + pending=0 + justSynced -> .success; else -> .hidden
- Make it Equatable for animation triggers

**SyncStatusViewModel.swift:**
- @Observable @MainActor class
- Properties: `state: SyncState`, `pendingCount: Int`, `lastSyncTime: Date?`, `failureCount: Int`, `isOnline: Bool`
- Computed `displayState: SyncIndicatorDisplayState` that calls the factory
- Computed `shouldShowIndicator: Bool` based on displayState != .hidden
- Method `refresh(from eventStore: EventStore) async` to pull values from EventStore
- Method `incrementFailureCount()` and `resetFailureCount()` for error escalation tracking

Reference existing SyncState enum from SyncEngine.swift - DO NOT duplicate it.
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
Files exist with correct structure
  </verify>
  <done>
Display state machine correctly maps SyncState + context to display states. ViewModel provides observable properties for UI binding.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SyncProgressBar component</name>
  <files>apps/ios/trendy/Views/Components/SyncIndicator/SyncProgressBar.swift</files>
  <action>
Create a determinate progress bar with count display:

- SwiftUI View with parameters: `current: Int`, `total: Int`
- Use `@Environment(\.accessibilityReduceMotion)` for animation control
- Progress calculation: `Double(current) / Double(total)` with guard for total=0
- Layout: VStack with "Syncing X of Y" text + horizontal Capsule progress bar
- Progress bar: GeometryReader with background track (white 30% opacity) + fill (white 100%)
- Animate fill width change with `.easeInOut(duration: 0.2)` unless reduceMotion
- Use `Color.dsPrimaryForeground` for text (since it sits on primary-colored background)
- Frame height: 4pt for the progress bar capsule
- Include SwiftUI Preview with sample data (e.g., 3 of 5)
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
Preview renders in Xcode
  </verify>
  <done>
Progress bar shows "Syncing X of Y" with animated fill that respects reduce motion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SyncIndicatorView floating pill</name>
  <files>apps/ios/trendy/Views/Components/SyncIndicator/SyncIndicatorView.swift</files>
  <action>
Create the main floating indicator view:

- Parameters: `displayState: SyncIndicatorDisplayState`, `onTap: () -> Void`, `onRetry: () async -> Void`
- Use `@Environment(\.accessibilityReduceMotion)` for animation control
- Layout: HStack with statusIcon + statusContent + Spacer + actionButton
- Padding: horizontal 16, vertical 12
- Background: Capsule shape with state-based color:
  - .hidden/.success: Color.dsSuccess.opacity(0.95)
  - .offline: Color.dsWarning.opacity(0.95)
  - .syncing: Color.dsPrimary.opacity(0.95)
  - .error: Color.dsDestructive.opacity(0.95)
- Shadow: black 10% opacity, radius 8, y offset 4
- Outer padding: horizontal 16, bottom 8

**Status Icon (ViewBuilder):**
- .hidden: EmptyView
- .success: checkmark.circle.fill (dsSuccessForeground)
- .offline: wifi.slash (dsWarningForeground)
- .syncing: ProgressView circular with tint (dsPrimaryForeground), scale 0.8
- .error: exclamationmark.triangle.fill (dsDestructiveForeground)

**Status Content (ViewBuilder):**
- .hidden: EmptyView
- .success: "All synced" text
- .offline(let pending): "Offline - \(pending) pending" text
- .syncing(let current, let total): Use SyncProgressBar if total > 0, else "Syncing..." text
- .error(let message, _): Show user-friendly message text

**Action Button:**
- Only show for .error with canRetry=true or .offline with pending > 0
- "Retry" or "Sync Now" button with Task { await onRetry() }

- Apply `.onTapGesture(perform: onTap)` to entire pill
- Add SwiftUI Previews for each state
  </action>
  <verify>
Build succeeds: `cd /Users/cipher/Repositories/trendy && just build-ios 2>&1 | tail -20`
Previews render for all states
  </verify>
  <done>
Floating pill indicator displays all states with correct colors, icons, and interactive elements. Respects accessibility settings.
  </done>
</task>

</tasks>

<verification>
1. All 4 new files exist in expected locations
2. Build succeeds with `just build-ios`
3. SyncIndicatorDisplayState.from() correctly maps all SyncState cases
4. SyncIndicatorView previews show distinct appearances for each state
5. No hardcoded colors - uses Color.ds* design tokens
6. reduceMotion environment variable is checked before animations
</verification>

<success_criteria>
- [ ] SyncIndicatorDisplayState enum created with factory method
- [ ] SyncStatusViewModel provides observable sync state
- [ ] SyncProgressBar shows determinate progress with count
- [ ] SyncIndicatorView floating pill renders all states correctly
- [ ] All components use design system colors
- [ ] Accessibility reduce motion is respected
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-indicators/07-01-SUMMARY.md`
</output>
