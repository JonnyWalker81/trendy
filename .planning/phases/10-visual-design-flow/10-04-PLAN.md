---
phase: 10-visual-design-flow
plan: 04
type: execute
wave: 3
depends_on: ["10-02", "10-03"]
files_modified:
  - apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift
  - apps/ios/trendy/Views/Onboarding/PermissionsView.swift
  - apps/ios/trendy/Views/Onboarding/CreateEventTypeView.swift
  - apps/ios/trendy/Views/Onboarding/LogFirstEventView.swift
  - apps/ios/trendy/Views/RootView.swift
  - apps/ios/trendy/Models/Onboarding/OnboardingStep.swift
autonomous: true

must_haves:
  truths:
    - "Screen transitions animate with spring animation (not instant cuts)"
    - "Progress bar advances smoothly when moving between steps"
    - "Permissions step shows individual priming screens sequentially"
    - "Loading view matches launch screen aesthetic"
  artifacts:
    - path: "apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift"
      provides: "Redesigned container with animated transitions"
      contains: "spring"
    - path: "apps/ios/trendy/Views/Onboarding/PermissionsView.swift"
      provides: "Updated to use individual priming screens"
      contains: "NotificationPrimingScreen"
    - path: "apps/ios/trendy/Views/RootView.swift"
      provides: "Updated LaunchLoadingView aesthetic"
      contains: "LinearGradient"
  key_links:
    - from: "OnboardingContainerView"
      to: "OnboardingNavigationView"
      via: "Animation modifier"
      pattern: "\\.animation\\(.spring"
    - from: "PermissionsView"
      to: "NotificationPrimingScreen"
      via: "Permission screen instantiation"
      pattern: "NotificationPrimingScreen\\("
    - from: "PermissionsView"
      to: "LocationPrimingScreen"
      via: "Permission screen instantiation"
      pattern: "LocationPrimingScreen\\("
---

<objective>
Redesign onboarding container navigation with animated transitions and wire all screens together.

Purpose: This plan connects all the visual work from Plans 01-03 into a cohesive animated flow. Addresses DESIGN-03 (loading view), DESIGN-04 (step transitions), DESIGN-05 (progress indicator in all screens), FLOW-01 (flow order), and FLOW-02 (permission priming integration).

Output: Updated OnboardingContainerView with spring animations, PermissionsView using individual priming screens, and updated LaunchLoadingView aesthetic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-visual-design-flow/10-CONTEXT.md
@.planning/phases/10-visual-design-flow/10-RESEARCH.md
@.planning/phases/10-visual-design-flow/10-01-SUMMARY.md
@.planning/phases/10-visual-design-flow/10-02-SUMMARY.md
@.planning/phases/10-visual-design-flow/10-03-SUMMARY.md

# Files being modified
@apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift
@apps/ios/trendy/Views/Onboarding/PermissionsView.swift
@apps/ios/trendy/Views/Onboarding/CreateEventTypeView.swift
@apps/ios/trendy/Views/Onboarding/LogFirstEventView.swift
@apps/ios/trendy/Views/RootView.swift
@apps/ios/trendy/Models/Onboarding/OnboardingStep.swift

# New priming screens from Plan 03
@apps/ios/trendy/Views/Onboarding/Screens/NotificationPrimingScreen.swift
@apps/ios/trendy/Views/Onboarding/Screens/LocationPrimingScreen.swift
@apps/ios/trendy/Views/Onboarding/Screens/HealthKitPrimingScreen.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update OnboardingStep Progress Calculation</name>
  <files>apps/ios/trendy/Models/Onboarding/OnboardingStep.swift</files>
  <action>
Add a computed property to OnboardingStep for progress bar calculation.

Add:
```swift
/// Progress value for OnboardingProgressBar (0.0 to 1.0)
var progress: Double {
    let allSteps = OnboardingStep.allCases
    guard let index = allSteps.firstIndex(of: self) else { return 0 }
    return Double(index) / Double(allSteps.count - 1)
}
```

This gives:
- welcome: 0.0
- auth: 0.2
- createEventType: 0.4
- logFirstEvent: 0.6
- permissions: 0.8
- finish: 1.0

Also update the existing `stepNumber` and `totalSteps` to match the progress bar (they currently group steps differently). Consider whether to keep them for backward compatibility or remove them.

Keep existing functionality intact.
  </action>
  <verify>
1. File compiles without errors
2. OnboardingStep.welcome.progress == 0.0
3. OnboardingStep.finish.progress == 1.0
  </verify>
  <done>OnboardingStep has progress computed property for progress bar</done>
</task>

<task type="auto">
  <name>Task 2: Update OnboardingContainerView with Spring Animations</name>
  <files>apps/ios/trendy/Views/Onboarding/OnboardingContainerView.swift</files>
  <action>
Update OnboardingNavigationView to use spring animations for step transitions.

**Changes to OnboardingNavigationView:**

1. Replace the `.animation(.easeInOut(duration: 0.3), value: viewModel.currentStep)` with:
   ```swift
   .animation(.spring(response: 0.25, dampingFraction: 0.7), value: viewModel.currentStep)
   ```
   Per CONTEXT.md: 0.2-0.3s duration, spring animation curve, bouncy iOS-native feel.

2. Add transition modifier to the content Group for horizontal slide:
   ```swift
   .transition(.asymmetric(
       insertion: .move(edge: .trailing).combined(with: .opacity),
       removal: .move(edge: .leading).combined(with: .opacity)
   ))
   ```

3. Ensure each step view has a unique `.id()` modifier for animation to work properly.

**Changes to OnboardingLoadingView:**
Update to use OnboardingHeroView component (or similar aesthetic):
- Keep it simple: app icon + subtle loading indicator
- Match the hero aesthetic but simpler (no gradient, just centered icon)
- This will be further refined in Task 4

Keep all existing initialization logic in initializeOnboarding() unchanged.
  </action>
  <verify>
1. File compiles without errors
2. Build succeeds
3. Animation modifier uses .spring()
  </verify>
  <done>OnboardingContainerView uses spring animations for step transitions</done>
</task>

<task type="auto">
  <name>Task 3: Update PermissionsView to Use Priming Screens</name>
  <files>apps/ios/trendy/Views/Onboarding/PermissionsView.swift</files>
  <action>
Rewrite PermissionsView to display individual priming screens sequentially.

**New Structure:**

Replace the current card-based UI with sequential full-screen priming:

```swift
struct PermissionsView: View {
    @Bindable var viewModel: OnboardingViewModel
    @Environment(\.geofenceManager) private var geofenceManager
    @Environment(\.healthKitService) private var healthKitService

    @State private var currentPermissionIndex = 0
    @State private var permissionResults: [OnboardingPermissionType: Bool] = [:]

    // Define permission order
    private let permissions: [OnboardingPermissionType] = [
        .notifications,
        .location,
        .healthkit
    ]

    private var currentPermission: OnboardingPermissionType? {
        guard currentPermissionIndex < permissions.count else { return nil }
        return permissions[currentPermissionIndex]
    }

    // Calculate progress: base progress for permissions step + sub-progress within permissions
    private var progress: Double {
        let baseProgress = OnboardingStep.permissions.progress
        let permissionProgress = Double(currentPermissionIndex) / Double(permissions.count)
        // Interpolate between permissions progress and finish progress
        let finishProgress = OnboardingStep.finish.progress
        return baseProgress + (finishProgress - baseProgress) * permissionProgress
    }

    var body: some View {
        Group {
            if let permission = currentPermission {
                permissionPrimingView(for: permission)
                    .transition(.asymmetric(
                        insertion: .move(edge: .trailing).combined(with: .opacity),
                        removal: .move(edge: .leading).combined(with: .opacity)
                    ))
                    .id(permission)
            } else {
                // All permissions handled - advance to next step
                Color.clear.onAppear {
                    Task {
                        await viewModel.advanceToNextStep()
                    }
                }
            }
        }
        .animation(.spring(response: 0.25, dampingFraction: 0.7), value: currentPermissionIndex)
    }

    @ViewBuilder
    private func permissionPrimingView(for permission: OnboardingPermissionType) -> some View {
        switch permission {
        case .notifications:
            NotificationPrimingScreen(
                progress: progress,
                onEnable: { await requestPermission(permission) },
                onSkip: { skipPermission(permission) }
            )
        case .location:
            LocationPrimingScreen(
                progress: progress,
                onEnable: { await requestPermission(permission) },
                onSkip: { skipPermission(permission) }
            )
        case .healthkit:
            HealthKitPrimingScreen(
                progress: progress,
                onEnable: { await requestPermission(permission) },
                onSkip: { skipPermission(permission) }
            )
        }
    }

    // Keep existing requestPermission and skipPermission logic
}
```

**Keep existing permission request logic** (the switch statement that calls viewModel.requestNotificationPermission(), etc.)

Remove:
- The old header VStack ("Enhance Your Experience")
- The old ProgressIndicatorView (using progress bar now)
- The old PermissionCard component
- The allPermissionsHandledView (replaced by auto-advance)
- The "Skip all and continue" button (each screen has its own skip)

The PermissionCard and related UI are no longer needed since each permission now has its own full-screen priming view.

Keep the EnvironmentKeys for geofenceManager and healthKitService at the bottom of the file.
  </action>
  <verify>
1. File compiles without errors
2. Build succeeds
3. PermissionsView uses NotificationPrimingScreen, LocationPrimingScreen, HealthKitPrimingScreen
4. Environment keys for services still present
  </verify>
  <done>PermissionsView displays individual full-screen priming views with spring transitions</done>
</task>

<task type="auto">
  <name>Task 4: Update Remaining Screens and LaunchLoadingView</name>
  <files>
    apps/ios/trendy/Views/Onboarding/CreateEventTypeView.swift
    apps/ios/trendy/Views/Onboarding/LogFirstEventView.swift
    apps/ios/trendy/Views/RootView.swift
  </files>
  <action>
**Update CreateEventTypeView:**

1. Replace ProgressIndicatorView with OnboardingProgressBar:
   ```swift
   OnboardingProgressBar(progress: OnboardingStep.createEventType.progress)
       .padding(.horizontal, 24)
       .padding(.top, 8)
   ```

2. Keep all other functionality (template grid, custom form, etc.)

**Update LogFirstEventView:**

Read the file first, then:
1. Add OnboardingProgressBar at the top if not present
2. Use OnboardingStep.logFirstEvent.progress
3. Keep all existing functionality

**Update LaunchLoadingView in RootView.swift:**

Per DESIGN-03: Loading view should match Launch Screen aesthetic (seamless transition).

Update LaunchLoadingView to:
1. Keep the app icon centered
2. Add subtle gradient background (or keep solid dsBackground)
3. Use a more refined loading indicator (perhaps custom pulse animation on the icon rather than ProgressView)
4. Match the "deep backgrounds and glowing accents" aesthetic from CONTEXT.md

Example:
```swift
private struct LaunchLoadingView: View {
    @State private var isPulsing = false

    var body: some View {
        ZStack {
            Color.dsBackground
                .ignoresSafeArea()

            Image(systemName: "chart.line.uptrend.xyaxis")
                .font(.system(size: 60))
                .foregroundStyle(Color.dsPrimary)
                .shadow(color: Color.dsPrimary.opacity(0.5), radius: isPulsing ? 20 : 10)
                .scaleEffect(isPulsing ? 1.05 : 1.0)
                .animation(.easeInOut(duration: 1.0).repeatForever(autoreverses: true), value: isPulsing)
                .onAppear { isPulsing = true }
        }
    }
}
```

This removes the ProgressView spinner and uses a subtle pulse animation on the icon instead, matching the hero animation style.
  </action>
  <verify>
1. All three files compile without errors
2. Build succeeds: `cd apps/ios && xcodebuild -scheme trendy -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(error:|BUILD)"`
3. CreateEventTypeView uses OnboardingProgressBar (not ProgressIndicatorView)
4. LaunchLoadingView has updated aesthetic
  </verify>
  <done>All onboarding screens use progress bar, LaunchLoadingView has polished aesthetic</done>
</task>

</tasks>

<verification>
After all tasks:
1. Project builds without errors
2. OnboardingStep has progress computed property
3. All screens use OnboardingProgressBar
4. Step transitions use spring animations
5. PermissionsView cycles through individual priming screens
6. LaunchLoadingView matches new aesthetic
7. Flow order maintained: welcome -> auth -> createEventType -> logFirstEvent -> permissions -> finish
</verification>

<success_criteria>
1. `xcodebuild build` succeeds
2. Navigation between steps has visible spring animation (bouncy feel)
3. Progress bar advances correctly at each step
4. Permissions flow shows NotificationPriming -> LocationPriming -> HealthKitPriming sequentially
5. Each priming screen skip/enable advances to next permission
6. LaunchLoadingView shows pulsing icon (no spinner)
7. All existing onboarding functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/10-visual-design-flow/10-04-SUMMARY.md`
</output>
