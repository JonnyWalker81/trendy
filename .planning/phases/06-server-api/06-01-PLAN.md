---
phase: 06-server-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/internal/apierror/problem.go
  - apps/backend/internal/apierror/codes.go
  - apps/backend/internal/apierror/response.go
autonomous: true

must_haves:
  truths:
    - "All error responses use RFC 9457 Problem Details format"
    - "Error responses include request_id for correlation"
    - "Validation errors list all failures, not just first"
    - "Rate limit errors include Retry-After header AND body field"
  artifacts:
    - path: "apps/backend/internal/apierror/problem.go"
      provides: "ProblemDetails struct with RFC 9457 fields"
      exports: ["ProblemDetails", "FieldError"]
    - path: "apps/backend/internal/apierror/codes.go"
      provides: "Global error code registry"
      exports: ["TypeValidation", "TypeNotFound", "TypeConflict", "TypeRateLimit", "TypeUnauthorized", "TypeInternal", "TypeInvalidUUID", "TypeFutureTimestamp"]
    - path: "apps/backend/internal/apierror/response.go"
      provides: "Helper functions to write problem responses"
      exports: ["WriteProblem", "NewValidationError", "NewNotFoundError", "NewConflictError", "NewRateLimitError", "NewInternalError"]
  key_links:
    - from: "apps/backend/internal/apierror/response.go"
      to: "github.com/gin-gonic/gin"
      via: "gin.Context for response writing"
      pattern: "c\\.Header|c\\.JSON"
---

<objective>
Create RFC 9457 Problem Details error response infrastructure.

Purpose: Standardize all API error responses with type, title, detail, instance, and extension fields. This enables actionable client error handling with request correlation, retry hints, and validation error details.

Output: New `internal/apierror` package with ProblemDetails struct, error code registry, and response helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-server-api/06-CONTEXT.md
@.planning/phases/06-server-api/06-RESEARCH.md

# Existing patterns
@apps/backend/internal/handlers/event.go (current error handling pattern)
@apps/backend/internal/middleware/logger.go (request ID in context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProblemDetails struct and error codes</name>
  <files>apps/backend/internal/apierror/problem.go, apps/backend/internal/apierror/codes.go</files>
  <action>
Create the `internal/apierror` package with two files:

**problem.go** - RFC 9457 compliant struct:
```go
type ProblemDetails struct {
    Type        string       `json:"type"`                    // URI reference (urn:trendy:error:*)
    Title       string       `json:"title"`                   // Short human-readable summary
    Status      int          `json:"status"`                  // HTTP status code
    Detail      string       `json:"detail,omitempty"`        // Human-readable explanation
    Instance    string       `json:"instance,omitempty"`      // URI for this occurrence

    // RFC 9457 extensions
    RequestID   string       `json:"request_id,omitempty"`    // From X-Request-ID header
    UserMessage string       `json:"user_message,omitempty"`  // UI-safe message for clients
    RetryAfter  *int         `json:"retry_after,omitempty"`   // Seconds until retry (429, 503)
    Action      string       `json:"action,omitempty"`        // Client hint: "refresh_token", etc.
    Errors      []FieldError `json:"errors,omitempty"`        // Validation errors list
}

type FieldError struct {
    Field   string `json:"field"`
    Message string `json:"message"`
    Code    string `json:"code,omitempty"`
}
```

**codes.go** - Error type URIs:
```go
const (
    TypeValidation       = "urn:trendy:error:validation"
    TypeNotFound         = "urn:trendy:error:not_found"
    TypeConflict         = "urn:trendy:error:conflict"
    TypeRateLimit        = "urn:trendy:error:rate_limit"
    TypeUnauthorized     = "urn:trendy:error:unauthorized"
    TypeForbidden        = "urn:trendy:error:forbidden"
    TypeInternal         = "urn:trendy:error:internal"
    TypeInvalidUUID      = "urn:trendy:error:invalid_uuid"
    TypeFutureTimestamp  = "urn:trendy:error:future_timestamp"
    TypeBadRequest       = "urn:trendy:error:bad_request"
)
```

Use package name `apierror` (not `error` - reserved keyword).
  </action>
  <verify>
```bash
cd apps/backend && go build ./internal/apierror/...
```
No compile errors.
  </verify>
  <done>ProblemDetails struct exists with all RFC 9457 fields and extension fields. Error codes defined as constants.</done>
</task>

<task type="auto">
  <name>Task 2: Create response helpers</name>
  <files>apps/backend/internal/apierror/response.go</files>
  <action>
Create response.go with helper functions that:
1. Set `Content-Type: application/problem+json` header
2. Extract request_id from Gin context (use existing logger.RequestIDFromContext pattern)
3. Set `Retry-After` header for 429/503 responses

**Factory functions:**
```go
// WriteProblem writes a ProblemDetails response with correct content type
func WriteProblem(c *gin.Context, problem *ProblemDetails)

// NewValidationError creates a 400 with validation field errors
func NewValidationError(requestID string, errors []FieldError) *ProblemDetails

// NewNotFoundError creates a 404 for missing resources
func NewNotFoundError(requestID, resource, id string) *ProblemDetails

// NewConflictError creates a 409 for conflicts (though per CONTEXT.md, duplicates return 200)
func NewConflictError(requestID, detail string) *ProblemDetails

// NewRateLimitError creates a 429 with retry hint
func NewRateLimitError(requestID string, retryAfter int) *ProblemDetails

// NewInternalError creates a 500 for unexpected errors
// IMPORTANT: Never expose internal error details to client
func NewInternalError(requestID string) *ProblemDetails

// NewBadRequestError creates a 400 for malformed requests
func NewBadRequestError(requestID, detail, userMessage string) *ProblemDetails

// NewUnauthorizedError creates a 401 for auth failures
func NewUnauthorizedError(requestID string) *ProblemDetails

// NewForbiddenError creates a 403 for permission denied
func NewForbiddenError(requestID string) *ProblemDetails
```

Import the existing logger package to access RequestIDFromContext if available, or extract from `c.GetHeader("X-Request-ID")` directly.

**WriteProblem implementation must:**
- Set `Content-Type: application/problem+json`
- If RetryAfter is set, also set `Retry-After` header
- Call `c.JSON(problem.Status, problem)`
  </action>
  <verify>
```bash
cd apps/backend && go build ./internal/apierror/...
cd apps/backend && go test ./internal/apierror/... -v
```
Package compiles. If tests exist, they pass.
  </verify>
  <done>Response helpers exist and set correct Content-Type header. Factory functions create properly structured ProblemDetails for each error type.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for apierror package</name>
  <files>apps/backend/internal/apierror/problem_test.go</files>
  <action>
Create tests that verify:
1. ProblemDetails JSON marshals correctly with RFC 9457 field names
2. WriteProblem sets `Content-Type: application/problem+json`
3. WriteProblem sets `Retry-After` header when RetryAfter field is set
4. NewValidationError includes all field errors in response
5. NewRateLimitError includes both header and body retry_after

Use httptest.NewRecorder to capture response headers and body.

Test cases:
- `TestProblemDetailsJSON` - verify JSON structure matches RFC 9457
- `TestWriteProblemContentType` - verify header is set
- `TestWriteProblemRetryAfter` - verify header AND body field
- `TestNewValidationErrorMultipleFields` - verify all errors included
- `TestNewInternalErrorHidesDetails` - verify no internal details leak
  </action>
  <verify>
```bash
cd apps/backend && go test ./internal/apierror/... -v
```
All tests pass.
  </verify>
  <done>Tests exist for ProblemDetails JSON structure, Content-Type header, Retry-After handling, and validation error aggregation.</done>
</task>

</tasks>

<verification>
```bash
# Build verification
cd apps/backend && go build ./internal/apierror/...

# Test verification
cd apps/backend && go test ./internal/apierror/... -v

# Verify package exports
cd apps/backend && go doc ./internal/apierror | head -30
```
</verification>

<success_criteria>
- `internal/apierror` package exists and compiles
- ProblemDetails struct has all RFC 9457 fields plus extensions (request_id, user_message, retry_after, action, errors)
- Error codes defined as URN constants
- WriteProblem sets `Content-Type: application/problem+json`
- WriteProblem sets `Retry-After` header when applicable
- Factory functions create correctly structured errors
- Unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-server-api/06-01-SUMMARY.md`
</output>
