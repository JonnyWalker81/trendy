---
phase: 06-server-api
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/internal/middleware/auth.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Auth middleware returns RFC 9457 Problem Details on all error paths"
    - "Response includes Content-Type: application/problem+json header"
    - "Response includes request_id for correlation"
  artifacts:
    - path: "apps/backend/internal/middleware/auth.go"
      provides: "RFC 9457 compliant auth errors"
      contains: "apierror.WriteProblem"
  key_links:
    - from: "apps/backend/internal/middleware/auth.go"
      to: "apps/backend/internal/apierror/response.go"
      via: "WriteProblem and NewUnauthorizedError"
      pattern: "apierror\\.WriteProblem.*NewUnauthorizedError"
---

<objective>
Update auth middleware to use RFC 9457 Problem Details for all error responses.

Purpose: Close UAT gap - auth middleware currently uses legacy `gin.H{"error": ...}` format instead of the standardized `apierror.WriteProblem()` pattern established in Phase 6.

Output: Auth middleware that returns consistent Problem Details responses with proper content-type headers and request correlation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/backend/internal/middleware/auth.go
@apps/backend/internal/apierror/response.go
@apps/backend/internal/apierror/codes.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update auth middleware error responses</name>
  <files>apps/backend/internal/middleware/auth.go</files>
  <action>
Replace the three legacy error responses with RFC 9457 Problem Details:

1. Add import for apierror package:
   ```go
   "github.com/JonnyWalker81/trendy/backend/internal/apierror"
   ```

2. Line 20 (missing auth header):
   Replace:
   ```go
   c.JSON(http.StatusUnauthorized, gin.H{"error": "Authorization header required"})
   ```
   With:
   ```go
   requestID := apierror.GetRequestID(c)
   apierror.WriteProblem(c, apierror.NewUnauthorizedError(requestID))
   ```

3. Line 29 (invalid format):
   Replace:
   ```go
   c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid authorization format"})
   ```
   With:
   ```go
   requestID := apierror.GetRequestID(c)
   apierror.WriteProblem(c, apierror.NewUnauthorizedError(requestID))
   ```

4. Line 42 (invalid/expired token):
   Replace:
   ```go
   c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid or expired token"})
   ```
   With:
   ```go
   requestID := apierror.GetRequestID(c)
   apierror.WriteProblem(c, apierror.NewUnauthorizedError(requestID))
   ```

Note: All three cases use the same NewUnauthorizedError because:
- RFC 9457 auth errors should NOT reveal WHY auth failed (security)
- The existing NewUnauthorizedError has appropriate generic messaging
- Request ID provides correlation for debugging
  </action>
  <verify>
1. `cd apps/backend && go build ./...` compiles without errors
2. `cd apps/backend && go test ./internal/middleware/...` passes
3. Manual verification:
   ```bash
   # Start backend
   just dev-backend

   # Test missing header
   curl -i http://localhost:8080/api/v1/events
   # Should return: Content-Type: application/problem+json
   # Body should contain: "type": "urn:trendy:error:unauthorized"

   # Test invalid format
   curl -i -H "Authorization: InvalidFormat" http://localhost:8080/api/v1/events
   # Should return same Problem Details format

   # Test invalid token
   curl -i -H "Authorization: Bearer invalidtoken" http://localhost:8080/api/v1/events
   # Should return same Problem Details format
   ```
  </verify>
  <done>
All three auth error paths return RFC 9457 Problem Details with:
- Content-Type: application/problem+json header
- type: urn:trendy:error:unauthorized
- title: Authentication Required
- status: 401
- request_id field (when available)
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `cd apps/backend && go build ./...`
2. Tests pass: `cd apps/backend && go test ./...`
3. Auth errors return Problem Details format with correct content-type
</verification>

<success_criteria>
- Auth middleware compiles and tests pass
- All 401 responses use application/problem+json content-type
- Response body matches RFC 9457 ProblemDetails schema
- Request ID correlation works when X-Request-ID header is present
</success_criteria>

<output>
After completion, create `.planning/phases/06-server-api/06-04-SUMMARY.md`
</output>
