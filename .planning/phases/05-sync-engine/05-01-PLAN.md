---
phase: 05-sync-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/Sync/SyncEngine.swift
  - apps/ios/trendy/ViewModels/EventStore.swift
  - apps/ios/trendy/Views/Components/SyncStatusBanner.swift
  - apps/ios/trendy/Views/List/EventListView.swift
autonomous: true

must_haves:
  truths:
    - "User can see pending mutation count in EventListView"
    - "User can see when last successful sync occurred"
    - "User can see syncing state while sync is in progress"
    - "User can see error state with message when sync fails"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncEngine.swift"
      provides: "lastSyncTime tracking, observable state updates"
      contains: "lastSyncTime"
    - path: "apps/ios/trendy/Views/Components/SyncStatusBanner.swift"
      provides: "Relative time display for last sync"
      contains: "RelativeDateTimeFormatter"
    - path: "apps/ios/trendy/Views/List/EventListView.swift"
      provides: "Live sync state binding to SyncStatusBanner"
      contains: "eventStore.syncState"
  key_links:
    - from: "SyncEngine.swift"
      to: "EventStore.swift"
      via: "@MainActor observable properties"
      pattern: "@MainActor.*lastSyncTime"
    - from: "EventListView.swift"
      to: "SyncStatusBanner"
      via: "async property binding"
      pattern: "syncState.*pendingCount"
---

<objective>
Wire sync state visibility to main UI so users can see sync status at a glance.

Purpose: SYNC-04 requires users to see sync state (pending count, last sync time, error state). The infrastructure exists (SyncEngine, SyncStatusBanner) but is not connected - EventListView hardcodes `.idle` and `pendingCount: 0`.

Output: Live sync status display in EventListView showing actual pending count, last sync time, and error states.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sync-engine/05-RESEARCH.md

# Key existing files
@apps/ios/trendy/Services/Sync/SyncEngine.swift
@apps/ios/trendy/ViewModels/EventStore.swift
@apps/ios/trendy/Views/Components/SyncStatusBanner.swift
@apps/ios/trendy/Views/List/EventListView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lastSyncTime tracking to SyncEngine</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Add lastSyncTime observable property to SyncEngine:

1. Add `@MainActor public private(set) var lastSyncTime: Date?` alongside existing state and pendingCount properties

2. In performSync(), after successful completion (before `await updateState(.idle)`):
   - Call a new `await updateLastSyncTime()` method

3. Add private MainActor method:
```swift
@MainActor
private func updateLastSyncTime() {
    lastSyncTime = Date()
}
```

4. Update the init log to include lastSyncTime info

Do NOT change any sync logic - only add observable state tracking.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>SyncEngine exposes @MainActor lastSyncTime property, updated on sync completion</done>
</task>

<task type="auto">
  <name>Task 2: Expose sync state from EventStore</name>
  <files>apps/ios/trendy/ViewModels/EventStore.swift</files>
  <action>
EventStore already has async computed properties for syncState and pendingCount. The problem is these require `await` which doesn't work well with SwiftUI bindings. Add non-async observable state:

1. Add @State-like observable properties (these are @Observable so just add properties):
```swift
// Cached sync state for UI binding (updated periodically)
private(set) var currentSyncState: SyncState = .idle
private(set) var currentPendingCount: Int = 0
private(set) var currentLastSyncTime: Date?
```

2. Add a method to refresh cached sync state from SyncEngine:
```swift
func refreshSyncStateForUI() async {
    guard let syncEngine = syncEngine else { return }
    currentSyncState = await syncEngine.state
    currentPendingCount = await syncEngine.pendingCount
    currentLastSyncTime = await syncEngine.lastSyncTime
}
```

3. Call `refreshSyncStateForUI()` at the end of:
   - `performSync()` (after sync completes)
   - `forceFullResync()` (after resync completes)
   - `handleNetworkRestored()` (after network restore sync)
   - `queueMutationsForUnsyncedEvents()` (after queuing)
   - `fetchData()` (after data fetch)

4. Also call it in `setModelContext()` to initialize state when EventStore is configured.
  </action>
  <verify>Build succeeds and existing tests pass: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>EventStore exposes currentSyncState, currentPendingCount, currentLastSyncTime for UI binding</done>
</task>

<task type="auto">
  <name>Task 3: Add relative time display to SyncStatusBanner</name>
  <files>apps/ios/trendy/Views/Components/SyncStatusBanner.swift</files>
  <action>
Enhance SyncStatusBanner to show last sync time:

1. Add optional lastSyncTime parameter:
```swift
let lastSyncTime: Date?
```

2. Update init to include lastSyncTime with default nil:
```swift
init(syncState: SyncState, pendingCount: Int, lastSyncTime: Date? = nil, onRetry: (() async -> Void)? = nil)
```

3. Create a private computed property for relative time:
```swift
private var lastSyncText: String? {
    guard let lastSyncTime = lastSyncTime else { return nil }
    let formatter = RelativeDateTimeFormatter()
    formatter.unitsStyle = .abbreviated
    return formatter.localizedString(for: lastSyncTime, relativeTo: Date())
}
```

4. In the `.idle` case with `pendingCount == 0`, show last sync time instead of EmptyView:
```swift
case .idle:
    if pendingCount > 0 {
        pendingBanner()
    } else if let lastSync = lastSyncText {
        syncedBanner(lastSync: lastSync)
    } else {
        EmptyView()
    }
```

5. Add new syncedBanner method:
```swift
@ViewBuilder
private func syncedBanner(lastSync: String) -> some View {
    HStack(spacing: 12) {
        Image(systemName: "checkmark.circle.fill")
            .foregroundStyle(.green)

        Text("Synced \(lastSync)")
            .font(.subheadline)
            .foregroundStyle(.secondary)

        Spacer()
    }
    .padding(.horizontal, 16)
    .padding(.vertical, 10)
    .background(.ultraThinMaterial)
}
```

6. Update Preview to include lastSyncTime example:
```swift
#Preview("Synced") {
    VStack(spacing: 0) {
        SyncStatusBanner(
            syncState: .idle,
            pendingCount: 0,
            lastSyncTime: Date().addingTimeInterval(-300)
        )
        Spacer()
    }
}
```
  </action>
  <verify>Build succeeds and previews render: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>SyncStatusBanner shows "Synced 5 min ago" when idle with no pending items</done>
</task>

<task type="auto">
  <name>Task 4: Wire EventListView to live sync state</name>
  <files>apps/ios/trendy/Views/List/EventListView.swift</files>
  <action>
Replace hardcoded sync state with live values from EventStore:

1. Find the SyncStatusBanner call (around line 52) and replace:

FROM:
```swift
SyncStatusBanner(
    syncState: .idle,
    pendingCount: 0,
    onRetry: {
        await eventStore.fetchData(force: true)
    }
)
```

TO:
```swift
SyncStatusBanner(
    syncState: eventStore.currentSyncState,
    pendingCount: eventStore.currentPendingCount,
    lastSyncTime: eventStore.currentLastSyncTime,
    onRetry: {
        await eventStore.performSync()
    }
)
```

Note the onRetry change: `performSync()` is more appropriate than `fetchData(force: true)` since the user is explicitly asking to sync.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>EventListView displays live sync state from EventStore</done>
</task>

</tasks>

<verification>
1. Build: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build`
2. Run app in simulator, create an event while offline - should see pending count
3. Go online - should see "Syncing..." then "Synced X ago"
4. Check SyncStatusBanner previews render correctly in Xcode
</verification>

<success_criteria>
- [ ] SyncEngine tracks lastSyncTime
- [ ] EventStore exposes cached sync state properties for UI binding
- [ ] SyncStatusBanner shows relative last sync time
- [ ] EventListView displays live sync state
- [ ] Build succeeds without warnings
- [ ] Requirements SYNC-04 satisfied: "User can see sync state (pending count, last sync time)"
</success_criteria>

<output>
After completion, create `.planning/phases/05-sync-engine/05-01-SUMMARY.md`
</output>
