---
phase: 05-sync-engine
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Views/MainTabView.swift
  - apps/ios/trendy/ViewModels/EventStore.swift
  - apps/ios/trendy/Views/Dashboard/BubblesView.swift
  - apps/ios/trendy/Views/Calendar/CalendarView.swift
  - apps/ios/trendy/Views/Analytics/AnalyticsView.swift
autonomous: true

must_haves:
  truths:
    - "App launches and shows main UI within 3 seconds regardless of pending sync queue size"
    - "User can navigate all tabs while sync runs in background"
    - "Sync status banner visible in Dashboard, Calendar, and Analytics views (not just EventList)"
    - "No UI freeze or hang during large syncs (5000+ events)"
  artifacts:
    - path: "apps/ios/trendy/Views/MainTabView.swift"
      provides: "Non-blocking initialization that loads cache first, syncs in background"
      contains: "fetchFromLocalOnly"
    - path: "apps/ios/trendy/ViewModels/EventStore.swift"
      provides: "New fetchFromLocalOnly() method for instant UI load"
      contains: "func fetchFromLocalOnly"
    - path: "apps/ios/trendy/Views/Dashboard/BubblesView.swift"
      provides: "SyncStatusBanner at top of dashboard"
      contains: "SyncStatusBanner"
    - path: "apps/ios/trendy/Views/Calendar/CalendarView.swift"
      provides: "SyncStatusBanner at top of calendar"
      contains: "SyncStatusBanner"
    - path: "apps/ios/trendy/Views/Analytics/AnalyticsView.swift"
      provides: "SyncStatusBanner at top of analytics"
      contains: "SyncStatusBanner"
  key_links:
    - from: "MainTabView.initializeNormally()"
      to: "EventStore.fetchFromLocalOnly()"
      via: "await call for instant cache load"
      pattern: "await store\\.fetchFromLocalOnly"
    - from: "MainTabView.initializeNormally()"
      to: "EventStore.performSync()"
      via: "Task { } fire-and-forget for background sync"
      pattern: "Task.*performSync"
---

<objective>
Make app initialization non-blocking by loading cached data first, then syncing in background.

Purpose: The current architecture blocks UI on sync completion (await fetchData() -> await performSync()). With 5000+ pending events (e.g., HealthKit imports), the loading screen hangs for hours. Users should see UI immediately with cached data while sync runs in background.

Output: Non-blocking initialization flow and sync status visibility in all main views.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/ios-sync-blocking-ui.md
@.planning/phases/05-sync-engine/05-RESEARCH.md

# Key existing files
@apps/ios/trendy/Views/MainTabView.swift
@apps/ios/trendy/ViewModels/EventStore.swift
@apps/ios/trendy/Views/Components/SyncStatusBanner.swift
@apps/ios/trendy/Views/Dashboard/BubblesView.swift
@apps/ios/trendy/Views/Calendar/CalendarView.swift
@apps/ios/trendy/Views/Analytics/AnalyticsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fetchFromLocalOnly method to EventStore</name>
  <files>apps/ios/trendy/ViewModels/EventStore.swift</files>
  <action>
Add a new method that ONLY loads from SwiftData cache without triggering sync. This enables instant UI display.

1. Add new public method `fetchFromLocalOnly()` (around line 554, after fetchData):

```swift
/// Loads data from local SwiftData cache only - does NOT trigger sync.
/// Use this for instant UI display during app launch, then call performSync() separately.
func fetchFromLocalOnly() async {
    guard modelContext != nil else { return }

    isLoading = true
    errorMessage = nil

    do {
        try await fetchFromLocal()
        await refreshSyncStateForUI()
    } catch {
        Log.data.error("Local fetch error", error: error)
        errorMessage = "Failed to load cached data."
    }

    isLoading = false
}
```

2. The existing `fetchFromLocal()` private method (line 555) already handles the SwiftData fetch logic. The new method is a public wrapper that sets loading state without triggering sync.

3. Do NOT modify the existing `fetchData()` method - it should continue to work as-is for refresh scenarios where sync is desired.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>EventStore has fetchFromLocalOnly() method for instant cache load without sync</done>
</task>

<task type="auto">
  <name>Task 2: Make MainTabView initialization non-blocking</name>
  <files>apps/ios/trendy/Views/MainTabView.swift</files>
  <action>
Reorder initializeNormally() to show UI immediately with cached data, then sync in background.

1. In `initializeNormally()` (line 208), change the data loading section (lines 258-274):

BEFORE (blocking - current code):
```swift
// Load and sync data (fetchData now always syncs geofences from server)
await store.fetchData()

// Reconcile geofences with device after data is synced
// fetchData already synced from server, so just get local definitions
if geoManager.hasGeofencingAuthorization {
    let definitions = store.getLocalGeofenceDefinitions()
    geoManager.reconcileRegions(desired: definitions)
    #if DEBUG
    print("App launch - reconciled \(definitions.count) geofences with device")
    #endif
}

// Hide loading screen
withAnimation {
    isLoading = false
}
```

AFTER (non-blocking):
```swift
// STEP 1: Load cached data for instant UI display (no sync, no network)
await store.fetchFromLocalOnly()

// STEP 2: Show UI immediately with cached data
withAnimation {
    isLoading = false
}

// STEP 3: Reconcile geofences with cached definitions first (instant)
if geoManager.hasGeofencingAuthorization {
    let definitions = store.getLocalGeofenceDefinitions()
    geoManager.reconcileRegions(desired: definitions)
    Log.geofence.debug("App launch - reconciled geofences with cached definitions", context: .with { ctx in
        ctx.add("count", definitions.count)
    })
}

// STEP 4: Start background sync (fire-and-forget, does not block UI)
// User sees cached data immediately; new data appears as sync completes
Task {
    await store.fetchData()

    // Re-reconcile geofences after sync completes to pick up server changes
    if geoManager.hasGeofencingAuthorization {
        let updatedDefinitions = store.getLocalGeofenceDefinitions()
        geoManager.reconcileRegions(desired: updatedDefinitions)
        Log.geofence.debug("Post-sync - reconciled geofences with server data", context: .with { ctx in
            ctx.add("count", updatedDefinitions.count)
        })
    }
}
```

2. The key changes:
   - Call `fetchFromLocalOnly()` instead of `fetchData()` for initial load
   - Move `isLoading = false` BEFORE the background sync task
   - Wrap the full sync (`fetchData()`) in a fire-and-forget `Task { }`
   - Geofence reconciliation happens twice: once with cache (instant), once after sync (background)

3. Do NOT change the screenshot mode initialization or scenePhase handler - those can continue using fetchData() since they run when UI is already visible.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>MainTabView loads cached data instantly, syncs in background without blocking UI</done>
</task>

<task type="auto">
  <name>Task 3: Add SyncStatusBanner to Dashboard, Calendar, and Analytics views</name>
  <files>apps/ios/trendy/Views/Dashboard/BubblesView.swift, apps/ios/trendy/Views/Calendar/CalendarView.swift, apps/ios/trendy/Views/Analytics/AnalyticsView.swift</files>
  <action>
Add SyncStatusBanner to all main views so users can see sync progress regardless of which tab they're on.

**BubblesView.swift (Dashboard):**
1. Inside the NavigationStack's ScrollView VStack (line 34), add SyncStatusBanner as the FIRST element:

```swift
VStack(spacing: 16) {
    // Sync status banner - visible during background sync
    SyncStatusBanner(
        syncState: eventStore.currentSyncState,
        pendingCount: eventStore.currentPendingCount,
        lastSyncTime: eventStore.currentLastSyncTime,
        onRetry: {
            await eventStore.performSync()
        }
    )

    // Insights banner (only show when there are events and insights)
    if !eventStore.eventTypes.isEmpty {
        // ... existing code
```

**CalendarView.swift:**
1. Inside the NavigationStack's ScrollView VStack (line 31), add SyncStatusBanner as the FIRST element:

```swift
VStack(spacing: 20) {
    // Sync status banner - visible during background sync
    SyncStatusBanner(
        syncState: eventStore.currentSyncState,
        pendingCount: eventStore.currentPendingCount,
        lastSyncTime: eventStore.currentLastSyncTime,
        onRetry: {
            await eventStore.performSync()
        }
    )

    viewModeSelector
    // ... existing code
```

**AnalyticsView.swift:**
1. Inside the NavigationStack's ScrollView VStack (line 30), add SyncStatusBanner as the FIRST element:

```swift
VStack(spacing: 20) {
    // Sync status banner - visible during background sync
    SyncStatusBanner(
        syncState: eventStore.currentSyncState,
        pendingCount: eventStore.currentPendingCount,
        lastSyncTime: eventStore.currentLastSyncTime,
        onRetry: {
            await eventStore.performSync()
        }
    )

    if eventStore.eventTypes.isEmpty {
        // ... existing code
```

Note: SyncStatusBanner automatically hides itself when idle with no pending items and no lastSyncTime, so it won't clutter the UI unnecessarily.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>SyncStatusBanner visible in Dashboard, Calendar, and Analytics views during background sync</done>
</task>

</tasks>

<verification>
1. Build: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build`

2. Manual test - Non-blocking launch:
   - Delete app and reinstall (or clear UserDefaults)
   - Log in with account that has 1000+ pending events
   - Time from launch to main UI should be < 3 seconds
   - SyncStatusBanner should show "Syncing X of Y" while sync runs in background
   - User should be able to navigate tabs freely during sync

3. Manual test - Banner visibility:
   - While sync is in progress, check all tabs: Dashboard, Events, Calendar, Analytics
   - All should show SyncStatusBanner with progress
   - Tapping Retry should trigger manual sync

4. Grep verification:
   - `grep -n "fetchFromLocalOnly" apps/ios/trendy/ViewModels/EventStore.swift` - should exist
   - `grep -n "SyncStatusBanner" apps/ios/trendy/Views/Dashboard/BubblesView.swift` - should exist
   - `grep -n "SyncStatusBanner" apps/ios/trendy/Views/Calendar/CalendarView.swift` - should exist
   - `grep -n "SyncStatusBanner" apps/ios/trendy/Views/Analytics/AnalyticsView.swift` - should exist
</verification>

<success_criteria>
- [ ] EventStore has fetchFromLocalOnly() method
- [ ] MainTabView.initializeNormally() loads cache first, syncs in background
- [ ] isLoading = false happens BEFORE background sync starts
- [ ] SyncStatusBanner appears in Dashboard (BubblesView)
- [ ] SyncStatusBanner appears in Calendar (CalendarView)
- [ ] SyncStatusBanner appears in Analytics (AnalyticsView)
- [ ] Build succeeds without warnings
- [ ] App launches to main UI within 3 seconds regardless of pending sync queue
- [ ] No UI freeze during large syncs
</success_criteria>

<output>
After completion, create `.planning/phases/05-sync-engine/05-06-SUMMARY.md`
</output>
