---
phase: 05-sync-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Models/QueuedOperation.swift
  - apps/ios/trendy/trendyApp.swift
  - apps/ios/trendy/Services/Sync/SyncEngine.swift
  - apps/ios/trendy/Views/Settings/DebugStorageView.swift
autonomous: true

must_haves:
  truths:
    - "QueuedOperation model is removed from codebase"
    - "App builds successfully without QueuedOperation references"
    - "Captive portal does not cause false positive sync attempts"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncEngine.swift"
      provides: "Health check before sync to detect captive portals"
      contains: "performHealthCheck"
  key_links:
    - from: "SyncEngine.swift"
      to: "APIClient"
      via: "health check call"
      pattern: "performHealthCheck|checkConnectivity"
---

<objective>
Clean up deprecated code and harden sync reliability against edge cases.

Purpose: Research identified QueuedOperation as deprecated (replaced by PendingMutation) and captive portal false positives as a reliability risk. This plan removes dead code and adds robustness.

Output: Cleaner codebase with improved sync reliability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sync-engine/05-RESEARCH.md

# Key existing files
@apps/ios/trendy/Models/QueuedOperation.swift
@apps/ios/trendy/trendyApp.swift
@apps/ios/trendy/Services/Sync/SyncEngine.swift
@apps/ios/trendy/Views/Settings/DebugStorageView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove QueuedOperation from schema</name>
  <files>apps/ios/trendy/trendyApp.swift, apps/ios/trendy/Models/QueuedOperation.swift</files>
  <action>
QueuedOperation is deprecated - PendingMutation replaced it. Remove QueuedOperation from the SwiftData schema:

1. Open `apps/ios/trendy/trendyApp.swift` and find the `Schema` definition in `sharedModelContainer`

2. Remove `QueuedOperation.self` from the schema array. The schema should include:
   - Event.self
   - EventType.self
   - Geofence.self
   - PendingMutation.self
   - PropertyDefinition.self
   - HealthKitConfiguration.self

   (QueuedOperation.self should be REMOVED)

3. Delete the file `apps/ios/trendy/Models/QueuedOperation.swift` entirely

4. Search for any remaining references to `QueuedOperation` in the codebase and remove them (there may be references in DebugStorageView.swift for count display)

Important: This is a schema migration. Existing data with QueuedOperation records will be orphaned (they're already unused). This is intentional cleanup.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>QueuedOperation model removed from schema and codebase</done>
</task>

<task type="auto">
  <name>Task 2: Add captive portal detection</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
NWPathMonitor can report "satisfied" even when behind a captive portal (hotel/airport WiFi). Add a lightweight health check before sync:

1. Add a private method to SyncEngine:
```swift
/// Performs a lightweight health check to verify actual internet connectivity.
/// NWPathMonitor can report "satisfied" behind captive portals, so we verify
/// with an actual HTTP request before attempting sync operations.
///
/// Uses getEventTypes() because:
/// - It always returns data (user always has at least default types)
/// - Empty response would indicate a problem, not a valid state
/// - Lightweight payload compared to full event list
private func performHealthCheck() async -> Bool {
    do {
        let types = try await apiClient.getEventTypes()
        // If we get a response (even empty), connectivity is working
        Log.sync.debug("Health check passed", context: .with { ctx in
            ctx.add("event_types_count", types.count)
        })
        return true
    } catch {
        Log.sync.warning("Health check failed - likely captive portal or no connectivity", context: .with { ctx in
            ctx.add("error", error.localizedDescription)
        })
        return false
    }
}
```

2. In performSync(), add health check after the isSyncing guard but before processing:
```swift
func performSync() async {
    guard !isSyncing else {
        Log.sync.debug("Sync already in progress, skipping")
        return
    }

    // Verify actual connectivity before starting sync
    // This catches captive portal situations where NWPathMonitor reports "satisfied"
    guard await performHealthCheck() else {
        Log.sync.info("Skipping sync - health check failed (likely captive portal)")
        return
    }

    isSyncing = true
    // ... rest of sync logic
}
```

Why getEventTypes() instead of getChanges(limit: 0):
- getChanges(limit: 0) returns an empty array even with valid connection - this is a valid response, not a failure indicator
- getEventTypes() always returns data if connectivity works (users have default types)
- Both are lightweight calls, but getEventTypes provides a more reliable signal
  </action>
  <verify>
1. Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`
2. Manual test: Connect device to WiFi, enable airplane mode (simulates captive portal - WiFi connected but no internet). Launch app, attempt sync. Verify in Console.app that "Health check failed - likely captive portal" log appears. Sync should be skipped gracefully.
  </verify>
  <done>SyncEngine performs health check using getEventTypes() before sync to detect captive portals</done>
</task>

<task type="auto">
  <name>Task 3: Update DebugStorageView for QueuedOperation removal</name>
  <files>apps/ios/trendy/Views/Settings/DebugStorageView.swift</files>
  <action>
DebugStorageView displays QueuedOperation count. Remove this reference:

1. Remove the `@State private var queuedOperationCount = 0` property

2. Remove the line `countRow("Queued Operations", count: queuedOperationCount, errorKey: "QueuedOperation")` from the swiftDataCountsSection

3. Remove the line `queuedOperationCount = safeCount(QueuedOperation.self, name: "QueuedOperation")` from `loadSwiftDataCounts()`

4. Remove the `import` or reference to QueuedOperation if present

The Pending Mutations row already shows the relevant queue count.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>DebugStorageView no longer references QueuedOperation</done>
</task>

</tasks>

<verification>
1. Build: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build`
2. Grep for QueuedOperation: `grep -r "QueuedOperation" apps/ios/trendy/` should return no results
3. Run app - sync should still work normally
4. Test captive portal detection: Connect to WiFi with airplane mode enabled (WiFi connected but no internet), attempt sync, verify "Health check failed" appears in logs and sync is skipped gracefully
</verification>

<success_criteria>
- [ ] QueuedOperation.swift deleted
- [ ] No references to QueuedOperation in codebase
- [ ] Schema no longer includes QueuedOperation
- [ ] SyncEngine performs health check before sync using getEventTypes()
- [ ] Build succeeds without warnings
- [ ] Captive portal situation logs clear message instead of failing with network errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-sync-engine/05-02-SUMMARY.md`
</output>
