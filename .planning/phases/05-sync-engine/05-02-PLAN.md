---
phase: 05-sync-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Models/QueuedOperation.swift
  - apps/ios/trendy/trendyApp.swift
  - apps/ios/trendy/Services/Sync/SyncEngine.swift
autonomous: true

must_haves:
  truths:
    - "QueuedOperation model is removed from codebase"
    - "App builds successfully without QueuedOperation references"
    - "Captive portal does not cause false positive sync attempts"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncEngine.swift"
      provides: "Health check before sync to detect captive portals"
      contains: "performHealthCheck"
  key_links:
    - from: "SyncEngine.swift"
      to: "APIClient"
      via: "health check call"
      pattern: "performHealthCheck|checkConnectivity"
---

<objective>
Clean up deprecated code and harden sync reliability against edge cases.

Purpose: Research identified QueuedOperation as deprecated (replaced by PendingMutation) and captive portal false positives as a reliability risk. This plan removes dead code and adds robustness.

Output: Cleaner codebase with improved sync reliability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sync-engine/05-RESEARCH.md

# Key existing files
@apps/ios/trendy/Models/QueuedOperation.swift
@apps/ios/trendy/trendyApp.swift
@apps/ios/trendy/Services/Sync/SyncEngine.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove QueuedOperation from schema</name>
  <files>apps/ios/trendy/trendyApp.swift, apps/ios/trendy/Models/QueuedOperation.swift</files>
  <action>
QueuedOperation is deprecated - PendingMutation replaced it. Remove QueuedOperation from the SwiftData schema:

1. Open `apps/ios/trendy/trendyApp.swift` and find the `Schema` definition in `sharedModelContainer`

2. Remove `QueuedOperation.self` from the schema array. The schema should include:
   - Event.self
   - EventType.self
   - Geofence.self
   - PendingMutation.self
   - PropertyDefinition.self
   - HealthKitConfiguration.self

   (QueuedOperation.self should be REMOVED)

3. Delete the file `apps/ios/trendy/Models/QueuedOperation.swift` entirely

4. Search for any remaining references to `QueuedOperation` in the codebase and remove them (there may be references in DebugStorageView.swift for count display)

Important: This is a schema migration. Existing data with QueuedOperation records will be orphaned (they're already unused). This is intentional cleanup.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>QueuedOperation model removed from schema and codebase</done>
</task>

<task type="auto">
  <name>Task 2: Add captive portal detection</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
NWPathMonitor can report "satisfied" even when behind a captive portal (hotel/airport WiFi). Add a lightweight health check before sync:

1. Add a private method to SyncEngine:
```swift
/// Performs a lightweight health check to verify actual internet connectivity.
/// NWPathMonitor can report "satisfied" behind captive portals, so we verify
/// with an actual HTTP request before attempting sync operations.
private func performHealthCheck() async -> Bool {
    // Try to fetch the change feed with limit=0 - this is the lightest possible
    // API call that still verifies authentication and connectivity
    do {
        _ = try await apiClient.getChanges(since: lastSyncCursor, limit: 0)
        return true
    } catch {
        Log.sync.warning("Health check failed - likely captive portal or no connectivity", context: .with { ctx in
            ctx.add("error", error.localizedDescription)
        })
        return false
    }
}
```

2. In performSync(), add health check after the isSyncing guard but before processing:
```swift
func performSync() async {
    guard !isSyncing else {
        Log.sync.debug("Sync already in progress, skipping")
        return
    }

    // Verify actual connectivity before starting sync
    // This catches captive portal situations where NWPathMonitor reports "satisfied"
    guard await performHealthCheck() else {
        Log.sync.info("Skipping sync - health check failed (likely captive portal)")
        return
    }

    isSyncing = true
    // ... rest of sync logic
}
```

3. Add a corresponding log message when health check succeeds:
```swift
Log.sync.debug("Health check passed, proceeding with sync")
```

This ensures we don't waste resources attempting sync operations that will all fail due to captive portal, and provides clear logging for debugging.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>SyncEngine performs health check before sync to detect captive portals</done>
</task>

<task type="auto">
  <name>Task 3: Update DebugStorageView for QueuedOperation removal</name>
  <files>apps/ios/trendy/Views/Settings/DebugStorageView.swift</files>
  <action>
DebugStorageView displays QueuedOperation count. Remove this reference:

1. Remove the `@State private var queuedOperationCount = 0` property

2. Remove the line `countRow("Queued Operations", count: queuedOperationCount, errorKey: "QueuedOperation")` from the swiftDataCountsSection

3. Remove the line `queuedOperationCount = safeCount(QueuedOperation.self, name: "QueuedOperation")` from `loadSwiftDataCounts()`

4. Remove the `import` or reference to QueuedOperation if present

The Pending Mutations row already shows the relevant queue count.
  </action>
  <verify>Build succeeds: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(BUILD|error:)"`</verify>
  <done>DebugStorageView no longer references QueuedOperation</done>
</task>

</tasks>

<verification>
1. Build: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build`
2. Grep for QueuedOperation: `grep -r "QueuedOperation" apps/ios/trendy/` should return no results
3. Run app - sync should still work normally
4. Test with airplane mode: sync should gracefully skip when health check fails
</verification>

<success_criteria>
- [ ] QueuedOperation.swift deleted
- [ ] No references to QueuedOperation in codebase
- [ ] Schema no longer includes QueuedOperation
- [ ] SyncEngine performs health check before sync
- [ ] Build succeeds without warnings
- [ ] Captive portal situation logs clear message instead of failing with network errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-sync-engine/05-02-SUMMARY.md`
</output>
