---
phase: 21-code-quality-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - apps/ios/trendy/Services/Sync/SyncEngine.swift
autonomous: true

must_haves:
  truths:
    - "bootstrapFetch is under 50 lines after extraction"
    - "Extracted methods follow entity-specific naming (fetchEventTypes, fetchGeofences, fetchEvents, fetchPropertyDefinitions)"
    - "All existing unit tests still pass (no behavior changes)"
    - "Entity fetch order preserved (EventTypes -> Geofences -> Events -> PropertyDefinitions)"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncEngine.swift"
      provides: "Refactored bootstrapFetch with extracted entity-specific fetch methods"
      contains: "private func fetchEventTypesForBootstrap"
  key_links:
    - from: "bootstrapFetch"
      to: "performNuclearCleanup"
      via: "method call with dataStore"
      pattern: "try performNuclearCleanup"
    - from: "bootstrapFetch"
      to: "fetchEventTypesForBootstrap"
      via: "method call with dataStore"
      pattern: "try await fetchEventTypesForBootstrap"
    - from: "bootstrapFetch"
      to: "fetchGeofencesForBootstrap"
      via: "method call with dataStore"
      pattern: "try await fetchGeofencesForBootstrap"
    - from: "bootstrapFetch"
      to: "fetchEventsForBootstrap"
      via: "method call with dataStore"
      pattern: "try await fetchEventsForBootstrap"
---

<objective>
Refactor `bootstrapFetch` (~222 lines) into smaller, focused methods with each under 50 lines.

Purpose: Reduce cyclomatic complexity and improve maintainability of the bootstrap logic. The existing unit test suite (BootstrapTests) serves as the safety net.

Output: `bootstrapFetch` becomes a high-level coordinator that delegates to entity-specific fetch methods.
</objective>

<execution_context>
@/Users/cipher/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cipher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-code-quality-refactoring/21-CONTEXT.md
@.planning/phases/21-code-quality-refactoring/21-RESEARCH.md
@.planning/phases/21-code-quality-refactoring/21-01-SUMMARY.md
@apps/ios/trendy/Services/Sync/SyncEngine.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract performNuclearCleanup method</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Extract the nuclear cleanup section (lines ~1547-1582) from `bootstrapFetch` into a new private method:

```swift
/// Delete all local data before repopulating from backend.
/// Called during bootstrap to ensure a clean slate.
/// - Parameter dataStore: Data store for persistence operations
/// - Throws: If deletion or save fails
private func performNuclearCleanup(dataStore: any DataStoreProtocol) throws
```

This method should:
1. Log start of nuclear cleanup
2. Delete all Events (they reference EventTypes)
3. Delete all Geofences
4. Delete all PropertyDefinitions
5. Delete all EventTypes (last, as others reference them)
6. Save deletions
7. Log completion

Place immediately after `bootstrapFetch` in the file.

Do NOT change any behavior - preserve exact logging and deletion order.
  </action>
  <verify>
Build the iOS project to verify no compile errors:
```bash
cd /Users/cipher/Repositories/trendy/apps/ios && xcodebuild -scheme trendy -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)"
```
  </verify>
  <done>
- `performNuclearCleanup` method exists and compiles
- `bootstrapFetch` calls `performNuclearCleanup` at the start
- Deletion order preserved: Events -> Geofences -> PropertyDefinitions -> EventTypes
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract entity-specific fetch methods</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Extract entity fetch sections into four new private methods:

**1. fetchEventTypesForBootstrap** (lines ~1584-1606):
```swift
/// Fetch and upsert all EventTypes from backend.
/// - Parameter dataStore: Data store for persistence operations
/// - Returns: Array of fetched API event types (needed for property definition fetch)
/// - Throws: Network or persistence errors
private func fetchEventTypesForBootstrap(
    dataStore: any DataStoreProtocol
) async throws -> [APIEventType]
```

**2. fetchGeofencesForBootstrap** (lines ~1608-1634):
```swift
/// Fetch and upsert all Geofences from backend.
/// - Parameter dataStore: Data store for persistence operations
/// - Throws: Network or persistence errors
private func fetchGeofencesForBootstrap(
    dataStore: any DataStoreProtocol
) async throws
```

**3. fetchEventsForBootstrap** (lines ~1636-1684):
```swift
/// Fetch and upsert all Events from backend.
/// - Parameter dataStore: Data store for persistence operations
/// - Returns: Count of fetched events (for logging)
/// - Throws: Network or persistence errors
private func fetchEventsForBootstrap(
    dataStore: any DataStoreProtocol
) async throws -> Int
```

**4. fetchPropertyDefinitionsForBootstrap** (lines ~1686-1725):
```swift
/// Fetch property definitions for all event types.
/// - Parameters:
///   - eventTypes: Event types to fetch definitions for
///   - dataStore: Data store for persistence operations
/// - Returns: Count of fetched property definitions (for logging)
/// - Throws: Persistence errors (network errors per-type are logged and continue)
private func fetchPropertyDefinitionsForBootstrap(
    eventTypes: [APIEventType],
    dataStore: any DataStoreProtocol
) async throws -> Int
```

Each method should:
1. Log what it's fetching
2. Call network client to get data
3. Log received count
4. Upsert each item
5. Save to dataStore
6. Return relevant data/count if needed by caller

Place all four methods after `performNuclearCleanup` in entity order.

Do NOT change any behavior - preserve exact logging, upsert logic, and relationship establishment.
  </action>
  <verify>
Build the iOS project to verify no compile errors:
```bash
cd /Users/cipher/Repositories/trendy/apps/ios && xcodebuild -scheme trendy -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)"
```
  </verify>
  <done>
- Four fetch methods exist and compile
- `bootstrapFetch` calls them in correct order: EventTypes -> Geofences -> Events -> PropertyDefinitions
- Each method handles its own logging and save
- Event-EventType relationship establishment preserved in fetchEventsForBootstrap
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify bootstrapFetch is under 50 lines</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
After extractions, verify `bootstrapFetch` is now a clean coordinator method under 50 lines. The method should:

1. Create dataStore
2. Call `performNuclearCleanup`
3. Call `fetchEventTypesForBootstrap` and capture result
4. Call `fetchGeofencesForBootstrap`
5. Call `fetchEventsForBootstrap` and capture count
6. Call `fetchPropertyDefinitionsForBootstrap` with event types
7. Restore event-type relationships
8. Log final counts (verification)
9. Post bootstrap completed notification

The verification section (lines ~1733-1765) that logs final counts and posts notification can remain inline in `bootstrapFetch` since it's the natural place for verification.

Count the lines and ensure it's under 50. If over, the verification section could be extracted, but only if necessary.

Add a MARK comment for organization:
```swift
// MARK: - Private: Bootstrap Fetch (Initial Sync)
```
  </action>
  <verify>
Count lines in bootstrapFetch:
```bash
cd /Users/cipher/Repositories/trendy && awk '/private func bootstrapFetch/,/^    private func [^b]/' apps/ios/trendy/Services/Sync/SyncEngine.swift | head -n -1 | wc -l
```
Target: Under 50 lines (acceptable: under 70 if clear structure)
  </verify>
  <done>
- `bootstrapFetch` is under 50 lines (or under 70 with clear structure)
- Code is organized with MARK comment
- Method reads as high-level coordinator (what, not how)
- Five extracted methods exist: performNuclearCleanup, fetchEventTypesForBootstrap, fetchGeofencesForBootstrap, fetchEventsForBootstrap, fetchPropertyDefinitionsForBootstrap
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no compile errors
2. `bootstrapFetch` under 50 lines
3. Five new extracted methods exist
4. Entity fetch order preserved (EventTypes first, then Geofences, then Events, then PropertyDefinitions)
5. No behavior changes - exact same logging, upsert logic, relationship establishment
6. Nuclear cleanup happens before any fetches
</verification>

<success_criteria>
- QUAL-04 addressed (bootstrapFetch split into entity-specific methods)
- All extracted methods under 50 lines each
- Existing unit tests still pass conceptually (tests compile and verify same behaviors)
- Ready for commit with atomic change
</success_criteria>

<output>
After completion, create `.planning/phases/21-code-quality-refactoring/21-02-SUMMARY.md`
</output>
