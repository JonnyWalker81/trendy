---
phase: 21-code-quality-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/Sync/SyncEngine.swift
autonomous: true

must_haves:
  truths:
    - "flushPendingMutations is under 50 lines after extraction"
    - "Extracted methods follow entity-specific naming (syncEventCreates, syncOtherMutations)"
    - "All existing unit tests still pass (no behavior changes)"
    - "Circuit breaker logic preserved exactly (no duplicate checks)"
  artifacts:
    - path: "apps/ios/trendy/Services/Sync/SyncEngine.swift"
      provides: "Refactored flushPendingMutations with extracted helper methods"
      contains: "private func syncEventCreateBatches"
  key_links:
    - from: "flushPendingMutations"
      to: "syncEventCreateBatches"
      via: "method call with mutations and dataStore"
      pattern: "try await syncEventCreateBatches"
    - from: "flushPendingMutations"
      to: "syncOtherMutations"
      via: "method call with mutations and dataStore"
      pattern: "try await syncOtherMutations"
---

<objective>
Refactor `flushPendingMutations` (~247 lines) into smaller, focused methods with each under 50 lines.

Purpose: Reduce cyclomatic complexity and improve maintainability of the mutation flush logic. The existing unit test suite (CircuitBreakerTests, BatchProcessingTests, DeduplicationTests) serves as the safety net.

Output: `flushPendingMutations` becomes a high-level coordinator that delegates to entity-specific methods.
</objective>

<execution_context>
@/Users/cipher/.claude/get-shit-done/workflows/execute-plan.md
@/Users/cipher/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-code-quality-refactoring/21-CONTEXT.md
@.planning/phases/21-code-quality-refactoring/21-RESEARCH.md
@apps/ios/trendy/Services/Sync/SyncEngine.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract syncEventCreateBatches method</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Extract the event CREATE batch processing loop (lines ~717-797) from `flushPendingMutations` into a new private method:

```swift
/// Process event CREATE mutations in batches of 50.
/// - Parameters:
///   - mutations: Event CREATE mutations to process
///   - dataStore: Data store for persistence operations
///   - totalPending: Total pending mutations (for progress updates)
/// - Returns: Number of successfully synced events
/// - Throws: Propagates network errors (rate limits handled internally)
private func syncEventCreateBatches(
    _ mutations: [PendingMutation],
    dataStore: any DataStoreProtocol,
    totalPending: Int
) async throws -> Int
```

This method should:
1. Handle the `for batchStart in stride(...)` loop
2. Check circuit breaker before each batch (same as current)
3. Call existing `flushEventCreateBatch` for each batch
4. Handle rate limit errors by incrementing counter (no throw)
5. Handle other errors by recording failures on mutations
6. Return total synced count

Place immediately after `flushPendingMutations` in the file.

Do NOT change any behavior - preserve exact error handling, logging, and state updates.
  </action>
  <verify>
Build the iOS project to verify no compile errors:
```bash
cd /Users/cipher/Repositories/trendy/apps/ios && xcodebuild -scheme trendy -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)"
```
  </verify>
  <done>
- `syncEventCreateBatches` method exists and compiles
- `flushPendingMutations` calls `syncEventCreateBatches` for event CREATE processing
- Circuit breaker check happens before each batch (not duplicated)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract syncOtherMutations method</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
Extract the other mutations loop (lines ~800-923) from `flushPendingMutations` into a new private method:

```swift
/// Process non-event-CREATE mutations one by one.
/// - Parameters:
///   - mutations: Mutations to process (updates, deletes, non-events)
///   - dataStore: Data store for persistence operations
///   - startingSyncedCount: Count of already synced mutations
///   - totalPending: Total pending mutations (for progress updates)
/// - Returns: Final synced count after processing
/// - Throws: Propagates unexpected errors (rate limits handled internally)
private func syncOtherMutations(
    _ mutations: [PendingMutation],
    dataStore: any DataStoreProtocol,
    startingSyncedCount: Int,
    totalPending: Int
) async throws -> Int
```

This method should:
1. Handle the `for mutation in otherMutations` loop
2. Check circuit breaker before each mutation (same as current)
3. Call existing `flushMutation` for each mutation
4. Handle rate limit errors, duplicate errors, API errors, and non-API errors (preserve exact behavior)
5. Return accumulated synced count

Place immediately after `syncEventCreateBatches` in the file.

Do NOT change any behavior - preserve exact error handling, logging, and state updates.
  </action>
  <verify>
Build the iOS project to verify no compile errors:
```bash
cd /Users/cipher/Repositories/trendy/apps/ios && xcodebuild -scheme trendy -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)"
```
  </verify>
  <done>
- `syncOtherMutations` method exists and compiles
- `flushPendingMutations` calls `syncOtherMutations` for non-event-CREATE processing
- Circuit breaker check happens before each mutation (not duplicated)
- All error handling paths preserved (rate limit, duplicate, API error, non-API error)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify flushPendingMutations is under 50 lines</name>
  <files>apps/ios/trendy/Services/Sync/SyncEngine.swift</files>
  <action>
After extractions, verify `flushPendingMutations` is now a clean coordinator method under 50 lines. The method should:

1. Create dataStore
2. Fetch pending mutations
3. Check circuit breaker (early return if tripped)
4. Guard for empty mutations
5. Log start of flush
6. Separate mutations by type
7. Initialize progress state
8. Call `syncEventCreateBatches` for event CREATEs
9. Call `syncOtherMutations` for other mutations
10. Save and update pending count

Count the lines and ensure it's under 50. If over, look for additional extraction opportunities (but avoid over-fragmenting - 50-70 lines is acceptable if the code is clear).

Add a MARK comment for organization:
```swift
// MARK: - Private: Flush Pending Mutations
```
  </action>
  <verify>
Count lines in flushPendingMutations:
```bash
cd /Users/cipher/Repositories/trendy && awk '/private func flushPendingMutations/,/^    private func [^f]/' apps/ios/trendy/Services/Sync/SyncEngine.swift | head -n -1 | wc -l
```
Target: Under 50 lines (acceptable: under 70 if clear structure)
  </verify>
  <done>
- `flushPendingMutations` is under 50 lines (or under 70 with clear structure)
- Code is organized with MARK comment
- Method reads as high-level coordinator (what, not how)
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no compile errors
2. `flushPendingMutations` under 50 lines
3. Two new extracted methods exist: `syncEventCreateBatches`, `syncOtherMutations`
4. No behavior changes - exact same logging, error handling, state updates
5. Circuit breaker checks not duplicated between parent and extracted methods
</verification>

<success_criteria>
- QUAL-03 partially addressed (flushPendingMutations split into focused methods)
- All extracted methods under 50 lines each
- Existing unit tests still pass conceptually (tests compile and verify same behaviors)
- Ready for commit with atomic change
</success_criteria>

<output>
After completion, create `.planning/phases/21-code-quality-refactoring/21-01-SUMMARY.md`
</output>
