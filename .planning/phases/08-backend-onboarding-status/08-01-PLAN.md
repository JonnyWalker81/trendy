---
phase: 08-backend-onboarding-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260120000000_add_onboarding_status.sql
autonomous: true

must_haves:
  truths:
    - "Database has onboarding_status table"
    - "Table stores completion status, step timestamps, permission statuses"
    - "RLS prevents users from accessing other users' data"
    - "User deletion cascades to remove onboarding status"
  artifacts:
    - path: "supabase/migrations/20260120000000_add_onboarding_status.sql"
      provides: "Database schema for onboarding status"
      contains: "CREATE TABLE"
  key_links:
    - from: "onboarding_status.user_id"
      to: "auth.users.id"
      via: "foreign key with ON DELETE CASCADE"
      pattern: "REFERENCES auth.users\\(id\\) ON DELETE CASCADE"
---

<objective>
Create database schema for storing user onboarding completion status.

Purpose: Provides the backend foundation for tracking onboarding progress per user. This table will be the source of truth for whether a user has completed onboarding, which steps they've completed, and what permissions they've granted/denied/skipped.

Output: SQL migration file ready for manual application via Supabase SQL Editor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-backend-onboarding-status/08-CONTEXT.md
@.planning/phases/08-backend-onboarding-status/08-RESEARCH.md
@supabase/migrations/20251116000000_add_geofences.sql (migration pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding_status migration</name>
  <files>supabase/migrations/20260120000000_add_onboarding_status.sql</files>
  <action>
Create the migration file with:

1. **CREATE TABLE onboarding_status:**
   - `user_id` UUID PRIMARY KEY (NOT separate id column - user_id IS the PK)
   - `user_id` REFERENCES auth.users(id) ON DELETE CASCADE
   - `completed` BOOLEAN NOT NULL DEFAULT FALSE
   - Step timestamps (all nullable TIMESTAMP WITH TIME ZONE):
     - `welcome_completed_at`
     - `auth_completed_at`
     - `permissions_completed_at`
   - Permission fields (all nullable):
     - `notifications_status` TEXT
     - `notifications_completed_at` TIMESTAMP WITH TIME ZONE
     - `healthkit_status` TEXT
     - `healthkit_completed_at` TIMESTAMP WITH TIME ZONE
     - `location_status` TEXT
     - `location_completed_at` TIMESTAMP WITH TIME ZONE
   - Standard timestamps:
     - `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
     - `updated_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()

2. **CHECK CONSTRAINTS for permission status values:**
   ```sql
   CONSTRAINT check_notifications_status
       CHECK (notifications_status IS NULL OR notifications_status IN ('granted', 'denied', 'skipped', 'not_requested'))
   ```
   (Same pattern for healthkit_status and location_status)

3. **Enable RLS:**
   ```sql
   ALTER TABLE public.onboarding_status ENABLE ROW LEVEL SECURITY;
   ```

4. **RLS Policies (4 policies):**
   - SELECT: `auth.uid() = user_id`
   - INSERT: `auth.uid() = user_id`
   - UPDATE: `auth.uid() = user_id`
   - DELETE: `auth.uid() = user_id`

5. **Trigger for updated_at:**
   Use existing `update_updated_at_column()` function (same as geofences migration).

6. **GRANT permissions:**
   ```sql
   GRANT ALL ON public.onboarding_status TO authenticated;
   GRANT ALL ON public.onboarding_status TO service_role;
   ```

7. **Comments for documentation** (table and key columns).

Follow the exact pattern from `20251116000000_add_geofences.sql` for structure, spacing, and comments.
  </action>
  <verify>
- File exists at correct path
- SQL syntax is valid (no obvious typos)
- Contains CREATE TABLE, RLS, policies, trigger, grants
- CHECK constraints for all three permission status fields
- user_id references auth.users(id) with ON DELETE CASCADE
  </verify>
  <done>
Migration file created with onboarding_status table schema, RLS policies, and constraints.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify migration file exists
cat supabase/migrations/20260120000000_add_onboarding_status.sql

# Verify key elements present
grep -E "CREATE TABLE|ENABLE ROW LEVEL SECURITY|ON DELETE CASCADE|check_notifications_status" supabase/migrations/20260120000000_add_onboarding_status.sql
```
</verification>

<success_criteria>
- [ ] Migration file exists at `supabase/migrations/20260120000000_add_onboarding_status.sql`
- [ ] Table has user_id as PRIMARY KEY with CASCADE delete
- [ ] Table has completed boolean, step timestamps, permission status fields
- [ ] CHECK constraints validate permission status values
- [ ] RLS enabled with SELECT/INSERT/UPDATE/DELETE policies
- [ ] Trigger for updated_at timestamps
- [ ] Grants for authenticated and service_role
</success_criteria>

<output>
After completion, create `.planning/phases/08-backend-onboarding-status/08-01-SUMMARY.md`
</output>
