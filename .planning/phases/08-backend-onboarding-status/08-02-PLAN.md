---
phase: 08-backend-onboarding-status
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/backend/internal/models/models.go
  - apps/backend/internal/repository/interfaces.go
  - apps/backend/internal/repository/onboarding_status.go
  - apps/backend/internal/service/interfaces.go
  - apps/backend/internal/service/onboarding.go
  - apps/backend/internal/handlers/onboarding.go
  - apps/backend/cmd/trendy-api/serve.go
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/users/onboarding returns onboarding status for authenticated user"
    - "GET returns 200 with defaults for new users (not 404)"
    - "PATCH /api/v1/users/onboarding updates onboarding status"
    - "DELETE /api/v1/users/onboarding performs soft reset"
    - "Unauthenticated requests return 401"
    - "Invalid permission status values rejected with 400"
  artifacts:
    - path: "apps/backend/internal/models/models.go"
      provides: "OnboardingStatus and request models"
      contains: "OnboardingStatus struct"
    - path: "apps/backend/internal/repository/onboarding_status.go"
      provides: "Database operations for onboarding status"
      exports: ["NewOnboardingStatusRepository"]
    - path: "apps/backend/internal/service/onboarding.go"
      provides: "Business logic and validation"
      exports: ["NewOnboardingService"]
    - path: "apps/backend/internal/handlers/onboarding.go"
      provides: "HTTP handlers for GET/PATCH/DELETE"
      exports: ["NewOnboardingHandler"]
    - path: "apps/backend/cmd/trendy-api/serve.go"
      provides: "Route registration"
      contains: "onboardingHandler"
  key_links:
    - from: "handlers/onboarding.go"
      to: "service/onboarding.go"
      via: "OnboardingService interface"
      pattern: "onboardingService\\.Get|onboardingService\\.Update|onboardingService\\.Reset"
    - from: "service/onboarding.go"
      to: "repository/onboarding_status.go"
      via: "OnboardingStatusRepository interface"
      pattern: "onboardingRepo\\.GetOrCreate|onboardingRepo\\.Update"
    - from: "serve.go"
      to: "middleware.Auth"
      via: "protected route group"
      pattern: "protected\\.GET.*onboarding|protected\\.PATCH.*onboarding|protected\\.DELETE.*onboarding"
---

<objective>
Create Go backend API for onboarding status management.

Purpose: Provides the API layer for iOS app to read and update onboarding completion status. Follows the established Handler -> Service -> Repository clean architecture pattern.

Output: Working GET/PATCH/DELETE endpoints at /api/v1/users/onboarding with authentication enforcement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-backend-onboarding-status/08-CONTEXT.md
@.planning/phases/08-backend-onboarding-status/08-RESEARCH.md
@.planning/phases/08-backend-onboarding-status/08-01-SUMMARY.md (migration details)
@apps/backend/internal/handlers/geofence.go (handler pattern)
@apps/backend/internal/repository/geofence.go (repository pattern)
@apps/backend/internal/service/interfaces.go (interface pattern)
@apps/backend/cmd/trendy-api/serve.go (route wiring)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add models and interfaces</name>
  <files>
    apps/backend/internal/models/models.go
    apps/backend/internal/repository/interfaces.go
    apps/backend/internal/service/interfaces.go
  </files>
  <action>
**In models/models.go, add at the end of the file:**

```go
// OnboardingStatus represents a user's onboarding completion state
type OnboardingStatus struct {
    UserID                   string     `json:"user_id"`
    Completed                bool       `json:"completed"`
    WelcomeCompletedAt       *time.Time `json:"welcome_completed_at,omitempty"`
    AuthCompletedAt          *time.Time `json:"auth_completed_at,omitempty"`
    PermissionsCompletedAt   *time.Time `json:"permissions_completed_at,omitempty"`
    NotificationsStatus      *string    `json:"notifications_status,omitempty"`
    NotificationsCompletedAt *time.Time `json:"notifications_completed_at,omitempty"`
    HealthkitStatus          *string    `json:"healthkit_status,omitempty"`
    HealthkitCompletedAt     *time.Time `json:"healthkit_completed_at,omitempty"`
    LocationStatus           *string    `json:"location_status,omitempty"`
    LocationCompletedAt      *time.Time `json:"location_completed_at,omitempty"`
    CreatedAt                time.Time  `json:"created_at"`
    UpdatedAt                time.Time  `json:"updated_at"`
}

// UpdateOnboardingStatusRequest represents the request to update onboarding status.
// All fields are required (full object replacement, not partial update).
type UpdateOnboardingStatusRequest struct {
    Completed                bool       `json:"completed"`
    WelcomeCompletedAt       *time.Time `json:"welcome_completed_at"`
    AuthCompletedAt          *time.Time `json:"auth_completed_at"`
    PermissionsCompletedAt   *time.Time `json:"permissions_completed_at"`
    NotificationsStatus      *string    `json:"notifications_status"`
    NotificationsCompletedAt *time.Time `json:"notifications_completed_at"`
    HealthkitStatus          *string    `json:"healthkit_status"`
    HealthkitCompletedAt     *time.Time `json:"healthkit_completed_at"`
    LocationStatus           *string    `json:"location_status"`
    LocationCompletedAt      *time.Time `json:"location_completed_at"`
}
```

**In repository/interfaces.go, add at the end:**

```go
// OnboardingStatusRepository defines the interface for onboarding status data access
type OnboardingStatusRepository interface {
    // GetOrCreate returns the user's onboarding status, creating a default record if none exists
    GetOrCreate(ctx context.Context, userID string) (*models.OnboardingStatus, error)
    // Update updates the user's onboarding status
    Update(ctx context.Context, userID string, status *models.OnboardingStatus) (*models.OnboardingStatus, error)
    // SoftReset clears step completion but preserves permission data
    SoftReset(ctx context.Context, userID string) (*models.OnboardingStatus, error)
}
```

**In service/interfaces.go, add at the end:**

```go
// OnboardingService defines the interface for onboarding business logic
type OnboardingService interface {
    GetOnboardingStatus(ctx context.Context, userID string) (*models.OnboardingStatus, error)
    UpdateOnboardingStatus(ctx context.Context, userID string, req *models.UpdateOnboardingStatusRequest) (*models.OnboardingStatus, error)
    ResetOnboardingStatus(ctx context.Context, userID string) (*models.OnboardingStatus, error)
}
```
  </action>
  <verify>
```bash
cd apps/backend && go build ./... 2>&1 | head -20
```
Build should succeed (models compile, interfaces defined).
  </verify>
  <done>
Models and interfaces defined. OnboardingStatus, UpdateOnboardingStatusRequest, OnboardingStatusRepository, OnboardingService all exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement repository and service</name>
  <files>
    apps/backend/internal/repository/onboarding_status.go
    apps/backend/internal/service/onboarding.go
  </files>
  <action>
**Create repository/onboarding_status.go:**

Follow the geofence.go pattern exactly. Key implementation details:

1. `GetOrCreate`:
   - Use Supabase Upsert with `user_id` as the conflict column
   - Data: `{"user_id": userID, "completed": false}`
   - This atomically creates a default record if none exists, or returns existing
   - Parse response into OnboardingStatus model

2. `Update`:
   - Build map with all fields from status
   - Use client.Update("onboarding_status", userID, data) where userID is the primary key
   - Return updated record

3. `SoftReset`:
   - Update with: completed=false, step timestamps=nil, preserve permission fields
   - Build data map that sets completed=false, clears step timestamps, but does NOT touch permission fields
   - Return updated record

**Create service/onboarding.go:**

1. Constructor: `NewOnboardingService(repo OnboardingStatusRepository) OnboardingService`

2. `GetOnboardingStatus`: Simply calls repo.GetOrCreate

3. `UpdateOnboardingStatus`:
   - Validate permission status values (must be nil or one of: granted, denied, skipped, not_requested)
   - Create validation error using apierror patterns for invalid values
   - Build OnboardingStatus from request
   - Call repo.Update

4. `ResetOnboardingStatus`: Calls repo.SoftReset

**Permission validation helper:**

```go
var validPermissionStatuses = map[string]bool{
    "granted":       true,
    "denied":        true,
    "skipped":       true,
    "not_requested": true,
}

func validatePermissionStatus(status *string, fieldName string) error {
    if status == nil {
        return nil
    }
    if !validPermissionStatuses[*status] {
        return fmt.Errorf("invalid %s: must be one of granted, denied, skipped, not_requested", fieldName)
    }
    return nil
}
```
  </action>
  <verify>
```bash
cd apps/backend && go build ./... 2>&1 | head -20
```
Build should succeed with repository and service implementations.
  </verify>
  <done>
Repository implements GetOrCreate (upsert pattern), Update, and SoftReset. Service implements validation and delegates to repository.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement handler and wire routes</name>
  <files>
    apps/backend/internal/handlers/onboarding.go
    apps/backend/cmd/trendy-api/serve.go
  </files>
  <action>
**Create handlers/onboarding.go:**

Follow geofence.go pattern exactly. Three handlers:

1. `GetOnboardingStatus` (GET /api/v1/users/onboarding):
   - Extract user_id from context (set by Auth middleware)
   - If not exists, return 401 with apierror.WriteProblem
   - Call service.GetOnboardingStatus
   - Return 200 with OnboardingStatus JSON

2. `UpdateOnboardingStatus` (PATCH /api/v1/users/onboarding):
   - Extract user_id from context
   - Bind JSON to UpdateOnboardingStatusRequest
   - Call service.UpdateOnboardingStatus
   - On validation error, return 400 with error message
   - On success, return 200 with updated OnboardingStatus

3. `ResetOnboardingStatus` (DELETE /api/v1/users/onboarding):
   - Extract user_id from context
   - Call service.ResetOnboardingStatus
   - Return 200 with reset OnboardingStatus (not 204 - iOS needs to see new state)

Use structured logging (logger.Ctx) for errors, matching existing handler patterns.

**Update serve.go:**

1. Add import if needed (should already have all needed imports)

2. In the initialization section (after existing repos), add:
   ```go
   onboardingRepo := repository.NewOnboardingStatusRepository(supabaseClient)
   ```

3. In the services section (after existing services), add:
   ```go
   onboardingService := service.NewOnboardingService(onboardingRepo)
   ```

4. In the handlers section (after existing handlers), add:
   ```go
   onboardingHandler := handlers.NewOnboardingHandler(onboardingService)
   ```

5. In the protected routes section, add routes under a new comment block:
   ```go
   // Onboarding status routes
   protected.GET("/users/onboarding", onboardingHandler.GetOnboardingStatus)
   protected.PATCH("/users/onboarding", onboardingHandler.UpdateOnboardingStatus)
   protected.DELETE("/users/onboarding", onboardingHandler.ResetOnboardingStatus)
   ```

These routes are under `protected` group which already has `middleware.Auth(supabaseClient)`, so unauthenticated requests automatically get 401.
  </action>
  <verify>
```bash
cd apps/backend && go build ./... && echo "Build successful"

# Verify routes are registered by checking serve.go
grep -E "users/onboarding" apps/backend/cmd/trendy-api/serve.go
```
  </verify>
  <done>
Handler implements GET/PATCH/DELETE endpoints. Routes registered under protected group. Unauthenticated requests return 401 via existing Auth middleware.
  </done>
</task>

</tasks>

<verification>
```bash
# Build entire backend
cd apps/backend && go build ./...

# Run tests
cd apps/backend && go test ./... -v 2>&1 | tail -30

# Verify all new files exist
ls -la apps/backend/internal/handlers/onboarding.go
ls -la apps/backend/internal/service/onboarding.go
ls -la apps/backend/internal/repository/onboarding_status.go

# Check models were added
grep "OnboardingStatus struct" apps/backend/internal/models/models.go

# Check routes registered
grep -A2 "Onboarding" apps/backend/cmd/trendy-api/serve.go
```
</verification>

<success_criteria>
- [ ] Backend builds successfully (`go build ./...`)
- [ ] All tests pass (`go test ./...`)
- [ ] OnboardingStatus model defined in models.go
- [ ] OnboardingStatusRepository interface and implementation exist
- [ ] OnboardingService interface and implementation exist
- [ ] OnboardingHandler with GET/PATCH/DELETE handlers exists
- [ ] Routes registered at /api/v1/users/onboarding under protected group
- [ ] Permission status validation rejects invalid values
</success_criteria>

<output>
After completion, create `.planning/phases/08-backend-onboarding-status/08-02-SUMMARY.md`
</output>
