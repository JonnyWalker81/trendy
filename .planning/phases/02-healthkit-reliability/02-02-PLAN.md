---
phase: 02-healthkit-reliability
plan: 02
type: execute
wave: 1
depends_on: [02-01]
files_modified:
  - apps/ios/trendy/Services/HealthKitService.swift
  - apps/ios/trendy/Services/HealthKitSettings.swift
  - apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift
autonomous: true

must_haves:
  truths:
    - "Each enabled HealthKit category has a 'last updated' timestamp visible to users"
    - "Timestamps are persisted to App Group UserDefaults and survive app restarts"
    - "Freshness is displayed in relative format (e.g., '5 min ago', 'Yesterday')"
  artifacts:
    - path: "apps/ios/trendy/Services/HealthKitService.swift"
      provides: "Per-category last update timestamp tracking"
      contains: "lastUpdateTime|recordCategoryUpdate"
    - path: "apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift"
      provides: "Freshness indicators in settings UI"
      contains: "Last updated"
  key_links:
    - from: "HealthKitService.swift"
      to: "HealthKitSettingsView.swift"
      via: "lastUpdateTime property"
      pattern: "lastUpdateTime"
---

<objective>
Add per-category "last updated" timestamps so users know when HealthKit data was last received.

Purpose: Users need visibility into whether their HealthKit data is fresh. Currently there's no indication of when data was last synced from Apple Health. This addresses requirement HLTH-04 and builds user trust in the reliability of background delivery.

Output: HealthKitSettingsView shows "Last updated: X minutes ago" for each enabled category. Debug view shows exact timestamps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-healthkit-reliability/02-01-PLAN.md

# Target files:
@apps/ios/trendy/Services/HealthKitService.swift
@apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift
@apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift

# Reference for existing settings patterns:
@apps/ios/trendy/Services/HealthKitSettings.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add last update timestamp tracking to HealthKitService</name>
  <files>apps/ios/trendy/Services/HealthKitService.swift</files>
  <action>
    Add per-category timestamp tracking for when data was last received.

    **1. Add UserDefaults key constant** (in Constants section):
    ```swift
    private let lastUpdateTimeKeyPrefix = "healthKitLastUpdate_"
    ```

    **2. Add public property for accessing timestamps** (in Properties section):
    ```swift
    /// Last update time per category (for UI display)
    private(set) var lastUpdateTimes: [HealthDataCategory: Date] = [:]
    ```

    **3. Add timestamp persistence methods** (after loadAllAnchors):
    ```swift
    // MARK: - Update Time Tracking

    /// Record that a category received new data
    private func recordCategoryUpdate(for category: HealthDataCategory) {
        let now = Date()
        lastUpdateTimes[category] = now
        Self.sharedDefaults.set(now.timeIntervalSince1970, forKey: "\(lastUpdateTimeKeyPrefix)\(category.rawValue)")
        Log.healthKit.debug("Recorded update", context: .with { ctx in
            ctx.add("category", category.displayName)
        })
    }

    /// Load all persisted update times into memory
    private func loadAllUpdateTimes() {
        for category in HealthDataCategory.allCases {
            let timestamp = Self.sharedDefaults.double(forKey: "\(lastUpdateTimeKeyPrefix)\(category.rawValue)")
            if timestamp > 0 {
                lastUpdateTimes[category] = Date(timeIntervalSince1970: timestamp)
            }
        }
        Log.healthKit.debug("Loaded update times", context: .with { ctx in
            ctx.add("count", lastUpdateTimes.count)
        })
    }

    /// Get last update time for a specific category
    func lastUpdateTime(for category: HealthDataCategory) -> Date? {
        lastUpdateTimes[category]
    }

    /// Clear update time for a category
    func clearUpdateTime(for category: HealthDataCategory) {
        lastUpdateTimes.removeValue(forKey: category)
        Self.sharedDefaults.removeObject(forKey: "\(lastUpdateTimeKeyPrefix)\(category.rawValue)")
    }
    ```

    **4. Call loadAllUpdateTimes in init** (after loadAllAnchors):
    ```swift
    loadAllUpdateTimes()
    ```

    **5. Call recordCategoryUpdate in handleNewSamples** (after processing samples loop, inside the "if !samples.isEmpty" block):
    ```swift
    // Record update time for freshness display
    recordCategoryUpdate(for: category)
    ```
  </action>
  <verify>
    ```bash
    # Verify timestamp tracking methods exist
    grep -c "recordCategoryUpdate\|lastUpdateTime\|loadAllUpdateTimes" apps/ios/trendy/Services/HealthKitService.swift
    # Expected: >= 5

    # Verify lastUpdateTimes property exists
    grep "lastUpdateTimes.*HealthDataCategory.*Date" apps/ios/trendy/Services/HealthKitService.swift
    # Expected: Found
    ```
  </verify>
  <checkpoint type="git" commit="feat(02-02): add per-category update timestamp tracking" />
</task>

<task type="auto">
  <name>Task 2: Add freshness display to HealthKitSettingsView</name>
  <files>apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift</files>
  <action>
    Display "Last updated" for each enabled category in the settings view.

    **1. First, read the current file structure to understand where to add the freshness display.**

    **2. Find the category toggle rows** and add freshness below each:

    For each category row that shows a toggle (likely in a ForEach over categories), add a subtitle showing last update time:

    ```swift
    // Add helper computed property at the end of the struct (before body closing):
    private func formatRelativeTime(_ date: Date?) -> String {
        guard let date = date else { return "Never" }
        let formatter = RelativeDateTimeFormatter()
        formatter.unitsStyle = .abbreviated
        return formatter.localizedString(for: date, relativeTo: Date())
    }
    ```

    **3. Modify each category row** to show the freshness indicator. The pattern should be:
    ```swift
    VStack(alignment: .leading, spacing: 2) {
        // Existing category name and toggle
        HStack {
            Image(systemName: category.iconName)
            Text(category.displayName)
            Spacer()
            Toggle("", isOn: binding)
                .labelsHidden()
        }
        // Add freshness indicator for enabled categories
        if isEnabled {
            if let lastUpdate = healthKitService?.lastUpdateTime(for: category) {
                Text("Updated \(formatRelativeTime(lastUpdate))")
                    .font(.caption)
                    .foregroundStyle(.secondary)
            } else {
                Text("Not yet updated")
                    .font(.caption)
                    .foregroundStyle(.orange)
            }
        }
    }
    ```

    **Note:** Adapt this pattern to match the existing view structure. The key is:
    - Only show freshness for enabled categories
    - Use relative time formatting
    - Show "Not yet updated" in orange if no data received yet
  </action>
  <verify>
    ```bash
    # Verify freshness display exists
    grep -c "lastUpdateTime\|Updated.*formatRelativeTime\|Not yet updated" apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift
    # Expected: >= 2

    # Verify RelativeDateTimeFormatter is used
    grep "RelativeDateTimeFormatter" apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift
    # Expected: Found
    ```
  </verify>
  <checkpoint type="git" commit="feat(02-02): display freshness indicators in settings" />
</task>

<task type="auto">
  <name>Task 3: Add detailed timestamps to debug view</name>
  <files>apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift</files>
  <action>
    Add a section showing exact last update timestamps for all categories in the debug view.

    **1. Add a new section after "Cache Status":**
    ```swift
    // Category Update Times Section
    Section {
        if let service = healthKitService {
            ForEach(HealthDataCategory.allCases, id: \.rawValue) { category in
                HStack {
                    Image(systemName: category.iconName)
                        .frame(width: 20)
                    Text(category.displayName)
                        .font(.subheadline)
                    Spacer()
                    if let lastUpdate = service.lastUpdateTime(for: category) {
                        VStack(alignment: .trailing) {
                            Text(lastUpdate, style: .time)
                                .font(.caption)
                            Text(lastUpdate, style: .date)
                                .font(.caption2)
                                .foregroundStyle(.secondary)
                        }
                    } else {
                        Text("Never")
                            .font(.caption)
                            .foregroundStyle(.orange)
                    }
                }
            }
        }
    } header: {
        Text("Last Update Times")
    } footer: {
        Text("Shows when each category last received data from HealthKit.")
    }
    ```

    **2. Add "Clear All Update Times" button in Actions section** (after "Clear All Anchors"):
    ```swift
    Button {
        clearAllUpdateTimes()
    } label: {
        HStack {
            Image(systemName: "clock.badge.xmark")
            Text("Clear Update Times")
        }
    }
    .foregroundStyle(.orange)
    ```

    **3. Add clearAllUpdateTimes action function:**
    ```swift
    private func clearAllUpdateTimes() {
        for category in HealthDataCategory.allCases {
            healthKitService?.clearUpdateTime(for: category)
        }
    }
    ```
  </action>
  <verify>
    ```bash
    # Verify update times section exists
    grep "Last Update Times" apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift
    # Expected: Found

    # Verify clear button exists
    grep "Clear Update Times" apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift
    # Expected: Found
    ```
  </verify>
  <checkpoint type="git" commit="feat(02-02): add detailed timestamps to debug view" />
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# 1. Verify timestamp tracking in service
grep -c "lastUpdateTimes\|recordCategoryUpdate" apps/ios/trendy/Services/HealthKitService.swift
# Expected: >= 4

# 2. Verify freshness in settings view
grep "lastUpdateTime\|Updated" apps/ios/trendy/Views/Settings/HealthKitSettingsView.swift | wc -l
# Expected: >= 2

# 3. Verify debug view timestamps
grep "Last Update Times" apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift
# Expected: Found
```

**Manual verification (post-build):**
1. Build and run app
2. Go to Settings > HealthKit
3. Enable a category (e.g., Steps)
4. Verify "Not yet updated" shows in orange
5. Trigger HealthKit sync (force refresh or wait for background delivery)
6. Verify "Updated X minutes ago" appears
7. Go to HealthKit Debug view
8. Verify "Last Update Times" section shows exact timestamps
9. Kill and restart app
10. Verify freshness indicators persist correctly
</verification>
