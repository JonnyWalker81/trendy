---
phase: 02-healthkit-reliability
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift
  - apps/ios/trendy/Services/HealthKitSettings.swift
  - apps/ios/trendy/Views/HealthKit/HealthKitSettingsView.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Initial HealthKit sync completes in under 30 seconds for all categories"
    - "User can trigger historical import for older data on demand"
    - "Historical import shows progress (X of Y workouts)"
  artifacts:
    - path: "apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift"
      provides: "30-day date predicate for initial sync"
      contains: "predicate.*30.*days"
    - path: "apps/ios/trendy/Services/HealthKitSettings.swift"
      provides: "Historical import depth setting"
      contains: "historicalImportDays"
    - path: "apps/ios/trendy/Views/HealthKit/HealthKitSettingsView.swift"
      provides: "Import Historical Data UI"
      contains: "Import Historical"
  key_links:
    - from: "HealthKitService+CategoryProcessing.swift"
      to: "HealthKitSettings.historicalImportDays"
      via: "settings lookup for import depth"
      pattern: "settings\\.historicalImportDays|HealthKitSettings\\.shared\\.historicalImportDays"
---

<objective>
Fix HealthKit initial sync performance by limiting default fetch to 30 days and providing user-triggered historical import.

Purpose: UAT revealed that initial sync with 500+ historical workouts hangs the refresh button for minutes. Users need fast default sync with option to import older data.

Output: Fast 30-day default sync, "Import Historical Data" UI with progress indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-healthkit-reliability/02-UAT.md

# Existing implementation (understand current state)
@apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift
@apps/ios/trendy/Services/HealthKit/HealthKitService+WorkoutProcessing.swift
@apps/ios/trendy/Services/HealthKitSettings.swift
@apps/ios/trendy/Views/HealthKit/HealthKitSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 30-day date predicate for initial sync</name>
  <files>
    apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift
    apps/ios/trendy/Services/HealthKitSettings.swift
  </files>
  <action>
**HealthKitSettings.swift:**
Add historical import settings:
```swift
// MARK: - Historical Import Settings

private let historicalImportDaysKey = "healthKit.historicalImportDays"
private let defaultImportDays = 30

/// Number of days to import on initial sync (when no anchor exists)
/// Default is 30 days. User can trigger full historical import separately.
var historicalImportDays: Int {
    get {
        let days = defaults.integer(forKey: historicalImportDaysKey)
        return days > 0 ? days : defaultImportDays
    }
    set {
        defaults.set(newValue, forKey: historicalImportDaysKey)
    }
}
```

**HealthKitService+CategoryProcessing.swift:**
Modify `handleNewSamples(for:)` to use date predicate when no anchor exists:

1. Before the `HKAnchoredObjectQuery`, add predicate construction:
```swift
// Build predicate: limit to last N days for initial sync (no anchor)
let predicate: NSPredicate?
if currentAnchor == nil {
    let daysToImport = HealthKitSettings.shared.historicalImportDays
    let startDate = Calendar.current.date(byAdding: .day, value: -daysToImport, to: Date()) ?? Date()
    predicate = HKQuery.predicateForSamples(withStart: startDate, end: nil, options: .strictStartDate)
    Log.healthKit.info("Initial sync: limiting to last \(daysToImport) days", context: .with { ctx in
        ctx.add("category", category.displayName)
        ctx.add("startDate", startDate.ISO8601Format())
    })
} else {
    // Subsequent fetches: get all new data since anchor (no date limit)
    predicate = nil
}
```

2. Pass `predicate` to `HKAnchoredObjectQuery`:
```swift
let query = HKAnchoredObjectQuery(
    type: sampleType,
    predicate: predicate,  // Was: nil
    anchor: currentAnchor,
    limit: HKObjectQueryNoLimit
) { ... }
```
  </action>
  <verify>
Build: `xcodebuild -workspace apps/ios/trendy.xcworkspace -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16 Pro" build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"`
  </verify>
  <done>
Initial sync uses 30-day predicate when no anchor exists. Subsequent syncs use anchor (no date limit). Settings expose `historicalImportDays`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add historical import UI with progress</name>
  <files>
    apps/ios/trendy/Services/HealthKit/HealthKitService+CategoryProcessing.swift
    apps/ios/trendy/Views/HealthKit/HealthKitSettingsView.swift
  </files>
  <action>
**HealthKitService+CategoryProcessing.swift:**
Add method for full historical import with progress callback:

```swift
/// Import all historical data for a category (no date limit)
/// Used for user-triggered "Import Historical Data" action
/// - Parameter progressHandler: Called with (processed, total) counts during import
@MainActor
func importAllHistoricalData(for category: HealthDataCategory, progressHandler: @escaping (Int, Int) -> Void) async {
    guard let sampleType = category.hkSampleType else { return }

    Log.healthKit.info("Starting full historical import", context: .with { ctx in
        ctx.add("category", category.displayName)
    })

    // Clear anchor to force full fetch, but use a flag to skip the default 30-day limit
    let savedAnchor = queryAnchors[category]

    // Query ALL data (no predicate, no anchor)
    let (samples, newAnchor) = await withCheckedContinuation { (continuation: CheckedContinuation<([HKSample], HKQueryAnchor?), Never>) in
        let query = HKAnchoredObjectQuery(
            type: sampleType,
            predicate: nil,  // No date limit for historical import
            anchor: nil,     // Start from beginning
            limit: HKObjectQueryNoLimit
        ) { _, addedSamples, _, newAnchor, error in
            if let error = error {
                Log.healthKit.error("Historical import query error", error: error, context: .with { ctx in
                    ctx.add("category", category.displayName)
                })
                continuation.resume(returning: ([], nil))
                return
            }
            continuation.resume(returning: (addedSamples ?? [], newAnchor))
        }
        healthStore.execute(query)
    }

    // Update anchor
    if let newAnchor = newAnchor {
        queryAnchors[category] = newAnchor
        saveAnchor(newAnchor, for: category)
    }

    let totalCount = samples.count
    Log.healthKit.info("Historical import: \(totalCount) samples to process", context: .with { ctx in
        ctx.add("category", category.displayName)
    })

    // Process with progress updates
    for (index, sample) in samples.enumerated() {
        // Report progress every 10 samples or at start/end
        if index % 10 == 0 || index == totalCount - 1 {
            progressHandler(index + 1, totalCount)
        }
        await processSample(sample, category: category, isBulkImport: true)
    }

    // Record update time
    if !samples.isEmpty {
        recordCategoryUpdate(for: category)
    }

    Log.healthKit.info("Historical import complete", context: .with { ctx in
        ctx.add("category", category.displayName)
        ctx.add("processed", totalCount)
    })
}
```

**HealthKitSettingsView.swift:**
Add "Import Historical Data" section below the existing "Refresh Health Data" button:

1. Add state variables (near other @State vars):
```swift
@State private var isImportingHistorical = false
@State private var importProgress: (current: Int, total: Int) = (0, 0)
@State private var showingImportOptions = false
```

2. In `configurationList`, add new section after the existing "Refresh Health Data" button section:
```swift
Section {
    Button {
        showingImportOptions = true
    } label: {
        if isImportingHistorical {
            HStack {
                ProgressView()
                    .controlSize(.small)
                VStack(alignment: .leading) {
                    Text("Importing Historical Data...")
                        .foregroundStyle(.secondary)
                    if importProgress.total > 0 {
                        Text("\(importProgress.current) of \(importProgress.total)")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                }
            }
        } else {
            Label("Import Historical Data", systemImage: "clock.arrow.circlepath")
        }
    }
    .disabled(isImportingHistorical)
} header: {
    Text("Historical Data")
} footer: {
    Text("Import older health data beyond the default 30-day window. This may take several minutes for large datasets.")
}
```

3. Add confirmation sheet (after other .sheet modifiers):
```swift
.confirmationDialog("Import Historical Data", isPresented: $showingImportOptions, titleVisibility: .visible) {
    Button("Import All Workouts") {
        Task { await importHistorical(category: .workout) }
    }
    Button("Import All Categories") {
        Task { await importAllHistorical() }
    }
    Button("Cancel", role: .cancel) {}
} message: {
    Text("This will import all historical health data. Large datasets may take several minutes. Heart rate data is skipped during bulk import for performance.")
}
```

4. Add import methods:
```swift
private func importHistorical(category: HealthDataCategory) async {
    isImportingHistorical = true
    importProgress = (0, 0)

    await healthKitService?.importAllHistoricalData(for: category) { current, total in
        importProgress = (current, total)
    }

    isImportingHistorical = false
    refreshTrigger.toggle()
}

private func importAllHistorical() async {
    isImportingHistorical = true
    importProgress = (0, 0)

    for category in enabledCategories {
        await healthKitService?.importAllHistoricalData(for: category) { current, total in
            importProgress = (current, total)
        }
    }

    isImportingHistorical = false
    refreshTrigger.toggle()
}
```
  </action>
  <verify>
Build: `xcodebuild -workspace apps/ios/trendy.xcworkspace -scheme "Trendy (Local)" -destination "platform=iOS Simulator,name=iPhone 16 Pro" build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"`
  </verify>
  <done>
"Import Historical Data" button in HealthKit Settings. Tapping shows options (workouts only or all categories). During import, progress shows "X of Y". Heart rate enrichment skipped for performance (existing behavior via isBulkImport=true).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>30-day default sync and historical import UI</what-built>
  <how-to-verify>
1. Clear HealthKit anchors (Debug view -> Clear All Anchors)
2. Tap "Refresh Health Data" - should complete in under 30 seconds even with 500+ historical workouts
3. Check logs: should see "Initial sync: limiting to last 30 days"
4. Navigate to "Import Historical Data" section
5. Tap button, select "Import All Workouts"
6. Observe progress indicator showing "X of Y"
7. After completion, verify older workouts now appear in event list
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Build succeeds without errors
- [ ] Initial sync with cleared anchors completes quickly (under 30s)
- [ ] Logs show "Initial sync: limiting to last 30 days" message
- [ ] "Import Historical Data" button appears in HealthKit Settings
- [ ] Historical import shows progress during execution
- [ ] Historical import processes older data beyond 30-day window
</verification>

<success_criteria>
1. Initial HealthKit sync completes in reasonable time (under 30 seconds) regardless of historical data volume
2. User has explicit option to import all historical data when needed
3. Progress indicator provides feedback during long historical imports
4. Heart rate enrichment remains skipped for bulk imports (existing behavior preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/02-healthkit-reliability/02-03-SUMMARY.md`
</output>
