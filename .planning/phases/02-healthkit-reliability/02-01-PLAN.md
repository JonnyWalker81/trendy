---
phase: 02-healthkit-reliability
plan: 01
type: execute
wave: 1
depends_on: [01-03]
files_modified:
  - apps/ios/trendy/Services/HealthKitService.swift
autonomous: true

must_haves:
  truths:
    - "HKQueryAnchors are persisted to App Group UserDefaults and survive app restarts"
    - "Observer queries use persistent anchors for incremental data fetching"
    - "Background delivery completion handlers are called correctly (iOS requirement)"
  artifacts:
    - path: "apps/ios/trendy/Services/HealthKitService.swift"
      provides: "Persistent anchor storage for incremental HealthKit queries"
      contains: "saveAnchor|loadAnchor"
  key_links:
    - from: "HealthKitService.swift"
      to: "App Group UserDefaults"
      via: "anchor persistence"
      pattern: "anchorData"
---

<objective>
Persist HKQueryAnchors to App Group UserDefaults so incremental fetching survives app restarts.

Purpose: Currently `queryAnchors` is an in-memory dictionary that resets on every app launch. This causes HealthKit to re-process all samples since app inception instead of only new ones. Persisting anchors enables true incremental data fetching, which is critical for background delivery efficiency and avoiding duplicate event creation.

Output: HealthKitService that loads/saves anchors per category, uses them in HKAnchoredObjectQuery pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

# Target file - observe existing anchor pattern:
@apps/ios/trendy/Services/HealthKitService.swift

# Existing App Group UserDefaults usage pattern:
# See sharedDefaults property around line 32
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add anchor persistence methods</name>
  <files>apps/ios/trendy/Services/HealthKitService.swift</files>
  <action>
    Add methods to persist and load HKQueryAnchor per category.

    **1. Add UserDefaults key constant** (in Constants section ~line 127):
    ```swift
    private let queryAnchorKeyPrefix = "healthKitQueryAnchor_"
    ```

    **2. Add anchor persistence methods** (after loadLastActiveEnergyDate):
    ```swift
    // MARK: - Anchor Persistence

    /// Save anchor for a category to persistent storage
    private func saveAnchor(_ anchor: HKQueryAnchor, for category: HealthDataCategory) {
        do {
            let data = try NSKeyedArchiver.archivedData(withRootObject: anchor, requiringSecureCoding: true)
            Self.sharedDefaults.set(data, forKey: "\(queryAnchorKeyPrefix)\(category.rawValue)")
            Log.healthKit.debug("Saved anchor", context: .with { ctx in
                ctx.add("category", category.displayName)
            })
        } catch {
            Log.healthKit.error("Failed to archive anchor", error: error, context: .with { ctx in
                ctx.add("category", category.displayName)
            })
        }
    }

    /// Load anchor for a category from persistent storage
    private func loadAnchor(for category: HealthDataCategory) -> HKQueryAnchor? {
        guard let data = Self.sharedDefaults.data(forKey: "\(queryAnchorKeyPrefix)\(category.rawValue)") else {
            return nil
        }
        do {
            let anchor = try NSKeyedUnarchiver.unarchivedObject(ofClass: HKQueryAnchor.self, from: data)
            Log.healthKit.debug("Loaded anchor", context: .with { ctx in
                ctx.add("category", category.displayName)
                ctx.add("found", anchor != nil)
            })
            return anchor
        } catch {
            Log.healthKit.error("Failed to unarchive anchor", error: error, context: .with { ctx in
                ctx.add("category", category.displayName)
            })
            return nil
        }
    }

    /// Clear anchor for a category (useful for debug/reset)
    func clearAnchor(for category: HealthDataCategory) {
        Self.sharedDefaults.removeObject(forKey: "\(queryAnchorKeyPrefix)\(category.rawValue)")
        queryAnchors.removeValue(forKey: category)
        Log.healthKit.info("Cleared anchor", context: .with { ctx in
            ctx.add("category", category.displayName)
        })
    }
    ```

    **3. Load anchors on init** (in init, after loadLastActiveEnergyDate call):
    ```swift
    loadAllAnchors()
    ```

    **4. Add loadAllAnchors method** (after clearAnchor):
    ```swift
    /// Load all persisted anchors into memory
    private func loadAllAnchors() {
        for category in HealthDataCategory.allCases {
            if let anchor = loadAnchor(for: category) {
                queryAnchors[category] = anchor
            }
        }
        Log.healthKit.debug("Loaded anchors", context: .with { ctx in
            ctx.add("count", queryAnchors.count)
        })
    }
    ```
  </action>
  <verify>
    ```bash
    # Verify new methods exist
    grep -c "saveAnchor\|loadAnchor\|clearAnchor" apps/ios/trendy/Services/HealthKitService.swift
    # Expected: >= 5 (declarations + calls)

    # Verify NSKeyedArchiver usage
    grep "NSKeyedArchiver\|NSKeyedUnarchiver" apps/ios/trendy/Services/HealthKitService.swift
    # Expected: Both appear
    ```
  </verify>
  <checkpoint type="git" commit="feat(02-01): add HKQueryAnchor persistence methods" />
</task>

<task type="auto">
  <name>Task 2: Update sample processing to use persistent anchors</name>
  <files>apps/ios/trendy/Services/HealthKitService.swift</files>
  <action>
    Modify handleNewSamples to use HKAnchoredObjectQuery with persistent anchors instead of time-based HKSampleQuery.

    **Current implementation** (handleNewSamples around line 508):
    Uses HKSampleQuery with time-based predicate (last 24 hours).

    **New implementation** - Replace the entire handleNewSamples method:
    ```swift
    /// Handle new samples for a category using anchored query
    @MainActor
    private func handleNewSamples(for category: HealthDataCategory) async {
        guard let sampleType = category.hkSampleType else { return }

        // Get current anchor (may be nil for first query)
        let currentAnchor = queryAnchors[category]

        // Execute anchored query
        let (samples, newAnchor) = await withCheckedContinuation { (continuation: CheckedContinuation<([HKSample], HKQueryAnchor?), Never>) in
            let query = HKAnchoredObjectQuery(
                type: sampleType,
                predicate: nil,
                anchor: currentAnchor,
                limit: HKObjectQueryNoLimit
            ) { _, addedSamples, _, newAnchor, error in
                if let error = error {
                    Log.healthKit.error("Anchored query error", error: error, context: .with { ctx in
                        ctx.add("category", category.displayName)
                    })
                    continuation.resume(returning: ([], nil))
                    return
                }
                continuation.resume(returning: (addedSamples ?? [], newAnchor))
            }
            healthStore.execute(query)
        }

        // Update and persist anchor if we got new samples or a new anchor
        if let newAnchor = newAnchor {
            queryAnchors[category] = newAnchor
            saveAnchor(newAnchor, for: category)
        }

        // Log sample counts
        if !samples.isEmpty {
            Log.healthKit.info("Processing new samples", context: .with { ctx in
                ctx.add("category", category.displayName)
                ctx.add("count", samples.count)
                ctx.add("hadPreviousAnchor", currentAnchor != nil)
            })
        }

        // Process only truly new samples
        for sample in samples {
            await processSample(sample, category: category)
        }
    }
    ```

    **Key changes:**
    1. Uses HKAnchoredObjectQuery instead of HKSampleQuery
    2. Passes current anchor (nil on first query means "get all")
    3. Saves new anchor after query completes
    4. Only processes samples returned by anchored query (guaranteed new)
  </action>
  <verify>
    ```bash
    # Verify HKAnchoredObjectQuery usage
    grep "HKAnchoredObjectQuery" apps/ios/trendy/Services/HealthKitService.swift
    # Expected: At least 1 match

    # Verify anchor is used in query
    grep -A5 "HKAnchoredObjectQuery(" apps/ios/trendy/Services/HealthKitService.swift | grep "anchor:"
    # Expected: anchor: currentAnchor

    # Verify syntax
    cd apps/ios && swiftc -typecheck -sdk $(xcrun --sdk iphoneos --show-sdk-path) -target arm64-apple-ios17.0 trendy/Services/HealthKitService.swift 2>&1 | head -20 || echo "Syntax check complete (some errors expected due to missing imports)"
    ```
  </verify>
  <checkpoint type="git" commit="feat(02-01): use HKAnchoredObjectQuery for incremental fetching" />
</task>

<task type="auto">
  <name>Task 3: Add debug view anchor controls</name>
  <files>apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift, apps/ios/trendy/Services/HealthKitService.swift</files>
  <action>
    Expose anchor state in debug view for observability.

    **1. Add public property to HealthKitService** (in Properties section):
    ```swift
    /// Categories with persisted anchors (for debug view)
    var categoriesWithAnchors: [HealthDataCategory] {
        Array(queryAnchors.keys).sorted { $0.rawValue < $1.rawValue }
    }
    ```

    **2. Add clearAllAnchors method to HealthKitService** (after clearAnchor):
    ```swift
    /// Clear all anchors (useful for full refresh)
    func clearAllAnchors() {
        for category in HealthDataCategory.allCases {
            clearAnchor(for: category)
        }
        Log.healthKit.info("Cleared all anchors")
    }
    ```

    **3. Add anchor section to HealthKitDebugView** (in Cache Status section, after Last Active Energy Date):
    ```swift
    HStack {
        Text("Anchors Stored")
        Spacer()
        Text("\(healthKitService?.categoriesWithAnchors.count ?? 0)")
            .foregroundStyle(.secondary)
    }

    if let categories = healthKitService?.categoriesWithAnchors, !categories.isEmpty {
        ForEach(categories, id: \.rawValue) { category in
            HStack {
                Image(systemName: "bookmark.fill")
                    .foregroundStyle(.blue)
                    .font(.caption)
                Text(category.displayName)
                    .font(.caption)
                Spacer()
            }
            .padding(.leading, 8)
        }
    }
    ```

    **4. Add clear anchors button to Actions section** (after "Clear Active Energy Cache"):
    ```swift
    Button {
        clearAllAnchors()
    } label: {
        HStack {
            Image(systemName: "bookmark.slash")
            Text("Clear All Anchors")
        }
    }
    .foregroundStyle(.red)
    ```

    **5. Add clearAllAnchors action function:**
    ```swift
    private func clearAllAnchors() {
        healthKitService?.clearAllAnchors()
    }
    ```
  </action>
  <verify>
    ```bash
    # Verify categoriesWithAnchors property exists
    grep "categoriesWithAnchors" apps/ios/trendy/Services/HealthKitService.swift
    # Expected: At least 1 match

    # Verify debug view has anchor display
    grep "Anchors Stored\|bookmark.fill\|Clear All Anchors" apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift
    # Expected: All 3 found
    ```
  </verify>
  <checkpoint type="git" commit="feat(02-01): expose anchor state in debug view" />
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# 1. Verify anchor persistence methods exist
grep -c "saveAnchor\|loadAnchor" apps/ios/trendy/Services/HealthKitService.swift
# Expected: >= 4

# 2. Verify HKAnchoredObjectQuery is used
grep "HKAnchoredObjectQuery" apps/ios/trendy/Services/HealthKitService.swift | wc -l
# Expected: >= 1

# 3. Verify debug view shows anchors
grep "categoriesWithAnchors" apps/ios/trendy/Views/HealthKit/HealthKitDebugView.swift
# Expected: Found

# 4. Swift syntax validation (partial - missing deps expected)
cd apps/ios && swiftc -typecheck trendy/Services/HealthKitService.swift 2>&1 | grep -c "error:" || echo "0 errors found"
```

**Manual verification (post-build):**
1. Build and run app on device
2. Enable HealthKit category (e.g., Steps)
3. Check debug view shows "Anchors Stored: 1"
4. Kill and restart app
5. Check debug view still shows "Anchors Stored: 1" (persisted!)
6. Check new samples are processed (not duplicates)
</verification>
