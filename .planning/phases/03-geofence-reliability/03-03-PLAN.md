---
phase: 03-geofence-reliability
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/ios/trendy/Services/GeofenceManager.swift
  - apps/ios/trendy/Views/Geofence/GeofenceDebugView.swift
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see which geofences are registered with iOS vs saved in app"
    - "User can see which geofences are missing from iOS (should be registered but aren't)"
    - "User can see which geofences are orphaned in iOS (registered but not in app)"
    - "Health status shows overall healthy/unhealthy state"
  artifacts:
    - path: "apps/ios/trendy/Services/GeofenceManager.swift"
      provides: "GeofenceHealthStatus computed property"
      contains: "GeofenceHealthStatus"
    - path: "apps/ios/trendy/Views/Geofence/GeofenceDebugView.swift"
      provides: "Full health dashboard UI"
      min_lines: 350
  key_links:
    - from: "apps/ios/trendy/Views/Geofence/GeofenceDebugView.swift"
      to: "apps/ios/trendy/Services/GeofenceManager.swift"
      via: "healthStatus computed property access"
      pattern: "geofenceManager.*healthStatus"
---

<objective>
Enhance GeofenceDebugView to show comprehensive geofence health monitoring.

Purpose: Users need to see exactly which geofences are registered with iOS vs saved in the app. This visibility helps diagnose why geofences might not be triggering - are they missing from iOS? Is authorization wrong? Are there orphaned regions from previous app versions?

Output: GeofenceHealthStatus model and enhanced GeofenceDebugView with full health dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-geofence-reliability/RESEARCH.md
@.planning/phases/03-geofence-reliability/03-01-SUMMARY.md

# Current implementation
@apps/ios/trendy/Services/GeofenceManager.swift
@apps/ios/trendy/Views/Geofence/GeofenceDebugView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GeofenceHealthStatus model to GeofenceManager</name>
  <files>apps/ios/trendy/Services/GeofenceManager.swift</files>
  <action>
Add a GeofenceHealthStatus struct and computed property to GeofenceManager.

1. Add the struct definition BEFORE the GeofenceManager class (or as a nested type inside):

```swift
/// Health status of geofence monitoring system
struct GeofenceHealthStatus {
    /// Region identifiers currently registered with iOS CLLocationManager
    let registeredWithiOS: Set<String>

    /// Geofence identifiers saved in the app's SwiftData database (active only)
    let savedInApp: Set<String>

    /// Current authorization status
    let authorizationStatus: CLAuthorizationStatus

    /// Whether location services are enabled system-wide
    let locationServicesEnabled: Bool

    /// Geofences that are saved in app but NOT registered with iOS
    /// These need to be registered for monitoring to work
    var missingFromiOS: Set<String> {
        savedInApp.subtracting(registeredWithiOS)
    }

    /// Regions registered with iOS but NOT in app database
    /// These are orphaned and should be removed
    var orphanedIniOS: Set<String> {
        registeredWithiOS.subtracting(savedInApp)
    }

    /// Overall health check
    var isHealthy: Bool {
        authorizationStatus == .authorizedAlways &&
        locationServicesEnabled &&
        missingFromiOS.isEmpty &&
        orphanedIniOS.isEmpty
    }

    /// Human-readable status summary
    var statusSummary: String {
        if !locationServicesEnabled {
            return "Location services disabled"
        }
        if authorizationStatus != .authorizedAlways {
            return "Needs 'Always' authorization"
        }
        if !missingFromiOS.isEmpty {
            return "\(missingFromiOS.count) geofence(s) not registered with iOS"
        }
        if !orphanedIniOS.isEmpty {
            return "\(orphanedIniOS.count) orphan region(s) in iOS"
        }
        if savedInApp.isEmpty {
            return "No active geofences"
        }
        return "Healthy"
    }
}
```

2. Add a computed property to GeofenceManager that builds the health status:

```swift
/// Current health status of geofence monitoring
var healthStatus: GeofenceHealthStatus {
    // Get iOS registered region identifiers
    let iosRegionIds = Set(locationManager.monitoredRegions.map { $0.identifier })

    // Fetch active geofences from SwiftData
    let descriptor = FetchDescriptor<Geofence>(
        predicate: #Predicate { $0.isActive }
    )
    let activeGeofences = (try? modelContext.fetch(descriptor)) ?? []
    let appGeofenceIds = Set(activeGeofences.map { $0.regionIdentifier })

    return GeofenceHealthStatus(
        registeredWithiOS: iosRegionIds,
        savedInApp: appGeofenceIds,
        authorizationStatus: authorizationStatus,
        locationServicesEnabled: CLLocationManager.locationServicesEnabled()
    )
}
```

Place the computed property in the "Debug Properties" section of GeofenceManager.
  </action>
  <verify>
- GeofenceHealthStatus struct exists
- GeofenceManager has healthStatus computed property
- Property returns accurate counts for registered vs saved
- missingFromiOS and orphanedIniOS computed correctly
- isHealthy returns true only when all conditions met
  </verify>
  <done>GeofenceManager exposes GeofenceHealthStatus for health monitoring</done>
</task>

<task type="auto">
  <name>Task 2: Enhance GeofenceDebugView with health dashboard</name>
  <files>apps/ios/trendy/Views/Geofence/GeofenceDebugView.swift</files>
  <action>
Enhance GeofenceDebugView to display comprehensive health information.

1. Add a computed property to get health status:
```swift
private var healthStatus: GeofenceHealthStatus? {
    geofenceManager?.healthStatus
}
```

2. Replace the existing "Sync Status" section with a new "Health Status" section:

```swift
// Health Status Section
Section {
    // Overall status indicator
    HStack {
        if let status = healthStatus {
            if status.isHealthy {
                Label("Healthy", systemImage: "checkmark.shield.fill")
                    .foregroundStyle(.green)
            } else {
                Label(status.statusSummary, systemImage: "exclamationmark.shield.fill")
                    .foregroundStyle(.orange)
            }
        } else {
            Label("Unknown", systemImage: "questionmark.circle")
                .foregroundStyle(.secondary)
        }
        Spacer()
    }

    // Counts comparison
    if let status = healthStatus {
        LabeledContent("Registered with iOS") {
            Text("\(status.registeredWithiOS.count)")
                .font(.title3.bold())
        }

        LabeledContent("Active in App") {
            Text("\(status.savedInApp.count)")
                .font(.title3.bold())
        }
    }
} header: {
    Text("Health Status")
}
```

3. Add a new section for "Missing from iOS" if there are any:

```swift
if let status = healthStatus, !status.missingFromiOS.isEmpty {
    Section {
        ForEach(Array(status.missingFromiOS).sorted(), id: \.self) { identifier in
            let geofence = allGeofences.first { $0.regionIdentifier == identifier }
            HStack {
                Image(systemName: "exclamationmark.triangle.fill")
                    .foregroundStyle(.orange)
                VStack(alignment: .leading) {
                    Text(geofence?.name ?? "Unknown")
                        .font(.subheadline)
                    Text(identifier)
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                        .lineLimit(1)
                }
                Spacer()
                Text("Not Registered")
                    .font(.caption)
                    .foregroundStyle(.orange)
            }
        }
    } header: {
        Text("Missing from iOS (\(status.missingFromiOS.count))")
    } footer: {
        Text("These geofences are active in the app but not registered with iOS. Tap 'Refresh Geofences' to register them.")
    }
}
```

4. Add a new section for "Orphaned in iOS" if there are any:

```swift
if let status = healthStatus, !status.orphanedIniOS.isEmpty {
    Section {
        ForEach(Array(status.orphanedIniOS).sorted(), id: \.self) { identifier in
            HStack {
                Image(systemName: "questionmark.circle.fill")
                    .foregroundStyle(.secondary)
                VStack(alignment: .leading) {
                    Text("Unknown Region")
                        .font(.subheadline)
                        .foregroundStyle(.secondary)
                    Text(identifier)
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                        .lineLimit(1)
                }
                Spacer()
                Text("Orphaned")
                    .font(.caption)
                    .foregroundStyle(.secondary)
            }
        }
    } header: {
        Text("Orphaned in iOS (\(status.orphanedIniOS.count))")
    } footer: {
        Text("These regions are registered with iOS but have no matching geofence in the app. They may be from a previous app version. Use 'Force Complete Re-sync' to clean up.")
    }
}
```

5. Keep the existing "Registered Regions" section but update it to show which regions are healthy vs problematic.

6. Keep the existing Actions section but rename "Force Complete Re-sync" to "Fix Registration Issues" and update the footer text.
  </action>
  <verify>
- GeofenceDebugView shows health status section
- Missing from iOS section appears when there are missing regions
- Orphaned in iOS section appears when there are orphaned regions
- Overall status indicator shows healthy/unhealthy
- Counts for registered vs saved are accurate
  </verify>
  <done>GeofenceDebugView displays comprehensive health monitoring dashboard</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build the iOS app: `cd apps/ios && xcodebuild -scheme "Trendy (Local)" -configuration Debug build`
2. Verify no compilation errors
3. Run the app and navigate to Settings > Geofence Debug
4. Verify Health Status section appears
5. Create a geofence and verify counts update
6. Check that health indicator shows correct state

Test scenarios:
1. No geofences: Should show "No active geofences"
2. Geofences registered: Should show "Healthy"
3. Change authorization to When In Use: Should show "Needs 'Always' authorization"
4. Disable location services: Should show "Location services disabled"
</verification>

<success_criteria>
- GeofenceHealthStatus model accurately represents system state
- GeofenceDebugView shows all health information clearly
- Missing and orphaned regions are clearly identified
- User can understand why geofences might not be working
- Actions section provides clear remediation steps
</success_criteria>

<output>
After completion, create `.planning/phases/03-geofence-reliability/03-03-SUMMARY.md`
</output>
